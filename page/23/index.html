<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"minminmsn.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="MinMinMsn">
<meta property="og:url" content="https://minminmsn.github.io/page/23/index.html">
<meta property="og:site_name" content="MinMinMsn">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Jerry Min">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://minminmsn.github.io/page/23/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>MinMinMsn</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">MinMinMsn</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/11/24/2018/11/2018-11-24-nginx%E9%99%90%E8%BF%9E%E6%8E%A5%E9%99%90%E9%80%9F%E7%8E%87%E6%A8%A1%E5%9D%97%E6%80%BB%E7%BB%93/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/24/2018/11/2018-11-24-nginx%E9%99%90%E8%BF%9E%E6%8E%A5%E9%99%90%E9%80%9F%E7%8E%87%E6%A8%A1%E5%9D%97%E6%80%BB%E7%BB%93/index/" class="post-title-link" itemprop="url">Nginx限连接限速率模块总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-24 08:00:00" itemprop="dateCreated datePublished" datetime="2018-11-24T08:00:00+08:00">2018-11-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>关于ngx_http_limit_conn_module、ngx_http_limit_req_module 模块，echo（需要安装第三方模块 ngx_http_echo_module），map（默认安装了ngx_http_map_module），geo（默认安装了ngx_http_geo_module）指令请查看官方文档，这里不再赘述。</p>
</blockquote>
<h3 id="有四种情况："><a href="#有四种情况：" class="headerlink" title="有四种情况："></a>有四种情况：</h3><ul>
<li><strong>不过CDN限速配置</strong></li>
<li><strong>过CDN限速配置</strong></li>
<li><strong>不用白名单的不过CDN</strong></li>
<li><strong>不用白名单的过CDN</strong></li>
</ul>
<blockquote>
<p>首先说明一个问题： geo里面的IP可以是单个的，也可以是一个网段的，只要符合CIDR标准就行。 map里面的IP必须是当个，因为这里把他看着一个变量。 过CDN的白名单IP只需要客户端IP就行，CND不需要，客户端IP得一行一行写 不过CDN的白名单IP可以写一个网段 关键点limited为空时不走限速。有值的，这里white_ip为1,走限速。</p>
</blockquote>
<h3 id="测试方法"><a href="#测试方法" class="headerlink" title="测试方法"></a>测试方法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">可以通过echo模块查看到（这两个都是没有走CDN的）：</span><br><span class="line">虚拟主机里echo的配置如下</span><br><span class="line">location /echo &#123;</span><br><span class="line">default_type text/plain;</span><br><span class="line">     echo http_x_forwarded_for: $http_x_forwarded_for;</span><br><span class="line">     echo remote_addr: $remote_addr;</span><br><span class="line">     echo firstAddr: $firstAddr;</span><br><span class="line">     echo clientRealIp: $clientRealIp;</span><br><span class="line">     echo white_ip: $white_ip;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">这个要限速，没有加入白名单</span><br><span class="line">http://123.11.11.11/echo</span><br><span class="line">http_x_forwarded_for:</span><br><span class="line">remote_addr: 59.12.13.14</span><br><span class="line">firstAddr:</span><br><span class="line">clientRealIp: 59.12.13.14</span><br><span class="line">white_ip: 1</span><br><span class="line">limited: 59.12.13.14</span><br><span class="line"></span><br><span class="line">这个不限速，加入了白名单</span><br><span class="line">http://123.11.11.11/echo</span><br><span class="line">http_x_forwarded_for:</span><br><span class="line">remote_addr: 114.11.183.6</span><br><span class="line">firstAddr:</span><br><span class="line">clientRealIp: 114.11.183.6</span><br><span class="line">white_ip: 0</span><br><span class="line">limited:</span><br></pre></td></tr></table></figure>

<h3 id="具体配置"><a href="#具体配置" class="headerlink" title="具体配置"></a>具体配置</h3><ol>
<li><strong>不过CDN限速配置</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">nginx.conf里面的配置</span><br><span class="line">geo $white_ip  &#123;</span><br><span class="line">        default 1;</span><br><span class="line">        127.0.0.1 0;</span><br><span class="line">        59.12.13.14  0;</span><br><span class="line">        61.11.12.0/24  0;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">map $white_ip $limited &#123;</span><br><span class="line">        1  $binary_remote_addr;</span><br><span class="line">        0  &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">limit_conn_zone $limited zone=addr:10m;</span><br><span class="line">limit_req_zone  $limited zone=one:10m rate=50r/s;</span><br><span class="line">limit_req_log_level info;</span><br><span class="line">limit_conn_log_level info;</span><br><span class="line"></span><br><span class="line">具体域名vhosts配置文件里面的应用</span><br><span class="line">    location / &#123;</span><br><span class="line">          limit_req  zone=one burst=5  nodelay;</span><br><span class="line">          limit_conn addr  100;</span><br><span class="line">          proxy_pass http://my_test_com;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>过CDN限速配置</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">nginx.conf里面的配置</span><br><span class="line">map $http_x_forwarded_for  $clientRealIpnormal &#123;</span><br><span class="line">        &quot;&quot;      $remote_addr;</span><br><span class="line">        ~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$  $firstAddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">map $http_http_cdn_src_ip $clientRealIp&#123;</span><br><span class="line">        &quot;&quot;   $clientRealIpnormal;</span><br><span class="line">        default $http_http_cdn_src_ip;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">map $clientRealIp  $white_ip  &#123;</span><br><span class="line">        default 1;</span><br><span class="line">        127.0.0.1 0;</span><br><span class="line">        59.12.13.14  0;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">map $white_ip $limited &#123;</span><br><span class="line">        1  $clientRealIp;</span><br><span class="line">        0  &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">limit_conn_zone $limited zone=addr:10m;</span><br><span class="line">limit_req_zone  $limited zone=one:10m rate=30r/s;</span><br><span class="line">limit_req_zone  $limited zone=two:10m rate=20r/s;</span><br><span class="line">limit_req_log_level info;</span><br><span class="line">limit_conn_log_level info;</span><br><span class="line"></span><br><span class="line">具体域名vhosts配置文件里面的应用</span><br><span class="line">    location / &#123;</span><br><span class="line">          limit_req  zone=two burst=1  nodelay;</span><br><span class="line">          proxy_pass http://mynew_test_com;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>不用白名单的不过CDN</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">nginx.conf里面的配置</span><br><span class="line">limit_conn_zone $binary_remote_addr zone=addr:10m;</span><br><span class="line">limit_req_zone  $binary_remote_addr zone=one:10m rate=50r/s;</span><br><span class="line">limit_req_log_level info;</span><br><span class="line">limit_conn_log_level info;</span><br><span class="line"></span><br><span class="line">具体域名vhosts配置文件里面的应用</span><br><span class="line">    location / &#123;</span><br><span class="line">          limit_req  zone=one burst=5  nodelay;</span><br><span class="line">          limit_conn addr  100;</span><br><span class="line">          proxy_pass http://my_test_com;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>不用白名单的过CDN</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">nginx.conf里面的配置</span><br><span class="line">map $http_x_forwarded_for  $clientRealIp &#123;</span><br><span class="line">&quot;&quot; $remote_addr;</span><br><span class="line">~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$ $firstAddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">limit_conn_zone $clientRealIp_addr zone=addr:10m;</span><br><span class="line">limit_req_zone  $clientRealIp_addr zone=one:10m rate=50r/s;</span><br><span class="line">limit_req_log_level info;</span><br><span class="line">limit_conn_log_level info;</span><br><span class="line"></span><br><span class="line">具体域名vhosts配置文件里面的应用</span><br><span class="line">    location / &#123;</span><br><span class="line">          limit_req  zone=one burst=5  nodelay;</span><br><span class="line">          limit_conn addr  100;</span><br><span class="line">          proxy_pass http://my_test_com;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/11/21/2018/11/2018-11-21-codis-3-2%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE%E6%B1%87%E6%80%BB/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/21/2018/11/2018-11-21-codis-3-2%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE%E6%B1%87%E6%80%BB/index/" class="post-title-link" itemprop="url">Codis 3.2集群部署配置汇总</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-21 08:00:00" itemprop="dateCreated datePublished" datetime="2018-11-21T08:00:00+08:00">2018-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<h3 id="概念总结"><a href="#概念总结" class="headerlink" title="概念总结"></a>概念总结</h3><p>集群配置前需要了解架构，集群分片主要分三种： 客户端分片：这个需要自己开发，对客户端要求严格，集群很难扩容 代理端分片：如codis，对客户端几乎无要求，集群容易扩容 服务端分片：如redis集群，需要智能客户端支持集群协议的，集群容易扩容</p>
</blockquote>
<h3 id="Codis3-2集群架构"><a href="#Codis3-2集群架构" class="headerlink" title="Codis3.2集群架构"></a>Codis3.2集群架构</h3><p><a target="_blank" rel="noopener" href="https://i.loli.net/2018/11/21/5bf5137e31cf5.png"><img src="/images/5bf5137e31cf5.png"></a></p>
<p>服务端：codis-fe——codis-dashboard——codis-proxy——codis-group——codis-server 客户端：client——nginx-tcp——codis-proxy cdis-fe可以管理多个codis-dashboard 每个codis-dashboard代表一个产品线，每个codis-dashboard可以管理多个codis-proxy 每个codis-proxy可以管理多个codis-server group 每个codis-server group至少由两个codis-server组成，最少1主1备 由上可知一个大的codis集群可以分多个产品线，客户端连接各个产品线的codis-proxy，业务线之间可以做到物理隔离，比如group1，group2，group3分给codis-product1业务线，group4， group5，group6分给codis-product2业务线，codis-dashboard配置保存在zookeeper里。</p>
<h3 id="特别注意"><a href="#特别注意" class="headerlink" title="特别注意"></a>特别注意</h3><p>同一个codis-server加入多个codis-dashboard的codis-group里，但是在不同的codis-dashboard里面主备的角色要一致，这代表逻辑隔离。 同一个codis-server只加入唯一的codis-dashboard的codis-group里，这代表物理隔离。</p>
<h3 id="宗旨方法"><a href="#宗旨方法" class="headerlink" title="宗旨方法"></a>宗旨方法</h3><p>宗旨：多读书 多实践 追随内心 着实去做 方法：志存高远 勤学苦练 知错就改 自渡渡他</p>
<h3 id="本文目录"><a href="#本文目录" class="headerlink" title="本文目录"></a>本文目录</h3><p>一、Codis简介 二、Codis 3.x 三、Codis 3.x 由以下组件组成 四、安装部署 五、集群配置 六、Codis-fe面板操作 七、代理HA 八、客户端通过VIP访问 九、压力测试</p>
<h3 id="一、Codis简介"><a href="#一、Codis简介" class="headerlink" title="一、Codis简介"></a>一、Codis简介</h3><p>Codis 是一个分布式 Redis 解决方案, 对于上层的应用来说, 连接到 Codis Proxy 和连接原生的 Redis Server 没有显著区别 (不支持的命令列表), 上层应用可以像使用单机的 Redis 一 样使用, Codis 底层会处理请求的转发, 不停机的数据迁移等工作, 所有后边的一切事情, 对于前面的客户端来说是透明的, 可以简单的认为后边连接的是一个内存无限大的 Redis 服务。 不支持命令列表 <a target="_blank" rel="noopener" href="https://github.com/CodisLabs/codis/blob/release3.2/doc/unsupported/_cmds.md">https://github.com/CodisLabs/codis/blob/release3.2/doc/unsupported\_cmds.md</a> redis的修改 <a target="_blank" rel="noopener" href="https://github.com/CodisLabs/codis/blob/release3.2/doc/redis/_change/_zh.md">https://github.com/CodisLabs/codis/blob/release3.2/doc/redis\_change\_zh.md</a> go安装 <a target="_blank" rel="noopener" href="https://golang.org/doc/install">https://golang.org/doc/install</a></p>
<h3 id="二、Codis-3-x"><a href="#二、Codis-3-x" class="headerlink" title="二、Codis 3.x"></a>二、Codis 3.x</h3><p>最新 release 版本为 codis-3.2，codis-server 基于 redis-3.2.8 支持 slot 同步迁移、异步迁移和并发迁移，对 key 大小无任何限制，迁移性能大幅度提升 相比 2.0：重构了整个集群组件通信方式，codis-proxy 与 zookeeper 实现了解耦，废弃了codis-config 等元数据存储支持 etcd&#x2F;zookeeper&#x2F;filesystem 等，可自行扩展支持新的存储，集群正常运行期间，即便元存储故障也不再影响 codis 集群，大大提升 codis-proxy 稳定性 对 codis-proxy 进行了大量性能优化,通过控制GC频率、减少对象创建、内存预分配、引入 cgo、jemalloc 等，使其吞吐还是延迟，都已达到 codis 项目中最佳 proxy 实现 select 命令，支持多 DB proxy 支持读写分离、优先读同 IP&#x2F;同 DC 下副本功能 基于 redis-sentinel 实现主备自动切换 实现动态 pipeline 缓存区（减少内存分配以及所引起的 GC 问题） proxy 支持通过 HTTP 请求实时获取 runtime metrics，便于监控、运维 支持通过 influxdb 和 statsd 采集 proxy metrics slot auto rebalance 算法从 2.0 的基于 max memory policy 变更成基于 group 下 slot 数量 提供了更加友好的 dashboard 和 fe 界面，新增了很多按钮、跳转链接、错误状态等，有利于快速发现、处理集群故障 新增 SLOTSSCAN 指令，便于获取集群各个 slot 下的所有 key codis-proxy 与 codis-dashbaord 支持 docker 部署</p>
<h3 id="三、Codis-3-x-由以下组件组成："><a href="#三、Codis-3-x-由以下组件组成：" class="headerlink" title="三、Codis 3.x 由以下组件组成："></a>三、Codis 3.x 由以下组件组成：</h3><p>Codis Server：基于 redis-3.2.8 分支开发。增加了额外的数据结构，以支持 slot 有关的操作以及数据迁移指令。具体的修改可以参考文档 redis 的修改。 Codis Proxy：客户端连接的 Redis 代理服务, 实现了 Redis 协议。 除部分命令不支持以外(不支持的命令列表)，表现的和原生的 Redis 没有区别（就像 Twemproxy）。 对于同一个业务集群而言，可以同时部署多个 codis-proxy 实例； 不同 codis-proxy 之间由 codis-dashboard 保证状态同步。 Codis Dashboard：集群管理工具，支持 codis-proxy、codis-server 的添加、删除，以及据迁移等操作。在集群状态发生改变时，codis-dashboard 维护集群下所有 codis-proxy 的状态的一致性。 对于同一个业务集群而言，同一个时刻 codis-dashboard 只能有 0个或者1个； 所有对集群的修改都必须通过 codis-dashboard 完成。 Codis Admin：集群管理的命令行工具。 可用于控制 codis-proxy、codis-dashboard 状态以及访问外部存储。 Codis FE：集群管理界面。 多个集群实例共享可以共享同一个前端展示页面； 通过配置文件管理后端 codis-dashboard 列表，配置文件可自动更新。 Storage：为集群状态提供外部存储。 提供 Namespace 概念，不同集群的会按照不同 product name 进行组织； 目前仅提供了 Zookeeper、Etcd、Fs 三种实现，但是提供了抽象的 interface 可自行扩展。</p>
<h3 id="四，安装部署"><a href="#四，安装部署" class="headerlink" title="四，安装部署"></a>四，安装部署</h3><p>二进制部署（官网的支持CentOS7,Glibc2.14以上版本）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf /root/codis3.2.0-go1.7.5-linux.tar.gz -C /usr/local/</span><br><span class="line">ln -s /usr/local/codis3.2.0-go1.7.5-linux/ /usr/local/codis</span><br><span class="line">/usr/local/codis/redis-cli -v</span><br><span class="line">/usr/local/codis/redis-cli: /lib64/libc.so.6: version `GLIBC_2.14&#x27; not found (required by /usr/local/codis/redis-cli)</span><br><span class="line">排错</span><br><span class="line">strings /lib64/libc.so.6 |grep GLIBC_</span><br><span class="line">GLIBC_2.2.5</span><br><span class="line">GLIBC_2.2.6</span><br><span class="line">GLIBC_2.3</span><br><span class="line">GLIBC_2.3.2</span><br><span class="line">GLIBC_2.3.3</span><br><span class="line">GLIBC_2.3.4</span><br><span class="line">GLIBC_2.4</span><br><span class="line">GLIBC_2.5</span><br><span class="line">GLIBC_2.6</span><br><span class="line">GLIBC_2.7</span><br><span class="line">GLIBC_2.8</span><br><span class="line">GLIBC_2.9</span><br><span class="line">GLIBC_2.10</span><br><span class="line">GLIBC_2.11</span><br><span class="line">GLIBC_2.12</span><br><span class="line">GLIBC_PRIVATE</span><br><span class="line">需要安装GLIBC_2.14版本</span><br><span class="line">直接使用CentOS7即可解决此问题。</span><br><span class="line">源码部署（CentOS6/7都可）</span><br><span class="line"></span><br><span class="line">1，java环境</span><br><span class="line">yum -y  install java-1.8.0</span><br><span class="line">java -version</span><br><span class="line"></span><br><span class="line">2，go环境</span><br><span class="line">tar zxvf /root/go1.8.3.linux-amd64.tar.gz -C /usr/local/</span><br><span class="line">/usr/local/go/bin/go version</span><br><span class="line">mkdir -p /data/go</span><br><span class="line">echo &#x27;export PATH=$PATH:/usr/local/go/bin:/usr/local/codis/bin&#x27;  &gt;&gt;/etc/profile</span><br><span class="line">echo &#x27;export GOPATH=/data/go&#x27;  &gt;&gt;/etc/profile</span><br><span class="line">source /etc/profile</span><br><span class="line">go env GOPATH</span><br><span class="line"></span><br><span class="line">3，codis安装</span><br><span class="line">mkdir -p /data/go/src/github.com/CodisLabs/</span><br><span class="line">tar -zxvf /root/codis-3.2.0.tar.gz -C /data/go/src/github.com/CodisLabs/</span><br><span class="line">cd /data/go/src/github.com/CodisLabs/</span><br><span class="line">mv codis-3.2.0/ codis</span><br><span class="line">cd codis/</span><br><span class="line">make</span><br><span class="line">./bin/redis-cli -v</span><br><span class="line">ln -s /data/go/src/github.com/CodisLabs/codis/ /usr/local/codis</span><br><span class="line">cat bin/version</span><br><span class="line">version = unknown version</span><br><span class="line">compile = 2017-09-11 16:58:26 +0800 by go version go1.8.3 linux/amd64</span><br><span class="line"></span><br><span class="line">4，zookeepr安装</span><br><span class="line">tar -zxvf /root/zookeeper-3.4.10.tar.gz -C /usr/local</span><br><span class="line">ln -s /usr/local/zookeeper-3.4.10 /usr/local/zookeeper</span><br><span class="line">echo &#x27;/usr/local/zookeeper/bin/zkServer.sh start&#x27;  &gt;&gt;/etc/rc.local</span><br><span class="line">cat &lt;&lt; EOF &gt;&gt;  /usr/local/zookeeper/conf/zoo.cfg</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br><span class="line">dataDir=/data/zookeeper/data</span><br><span class="line">clientPort=2181</span><br><span class="line">server.1=192.168.188.120:2888:3888</span><br><span class="line">server.2=192.168.188.121:2888:3888</span><br><span class="line">server.3=192.168.188.122:2888:3888</span><br><span class="line">EOF</span><br><span class="line">###myid</span><br><span class="line">#注意：2888是主从的通信端口，3888是选举端口，server后面的1,2,3是在data目录下myid文件里的数值</span><br><span class="line">mkdir -p /data/zookeeper/data</span><br><span class="line">echo &#x27;1&#x27; &gt; /data/zookeeper/data/myid</span><br><span class="line">/usr/local/zookeeper/bin/zkServer.sh start</span><br><span class="line">/usr/local/zookeeper/bin/zkServer.sh status</span><br><span class="line"></span><br><span class="line">5，其他节点直接打包/data/go/src/github.com/CodisLabs/codis.tar.gz复制过去即可</span><br><span class="line">集群配置前需要了解架构，集群分片主要分三种：</span><br><span class="line">客户端分片：这个需要自己开发，对客户端要求严格，集群很难扩容</span><br><span class="line">代理端分片：如codis，对客户端几乎无要求，集群容易扩容</span><br><span class="line">服务端分片：如redis集群，需要智能客户端支持集群协议的，集群容易扩容</span><br></pre></td></tr></table></figure>

<h3 id="五、集群配置"><a href="#五、集群配置" class="headerlink" title="五、集群配置"></a>五、集群配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">1、角色划分</span><br><span class="line">192.168.188.120 codis120    codis-server  zookeeper</span><br><span class="line">192.168.188.121 codis121    codis-server  zookeeper</span><br><span class="line">192.168.188.122 codis122    codis-server  zookeeper</span><br><span class="line">192.168.188.123 codis123    codis-server  codis-proxy  nginx-tcp  lvs</span><br><span class="line">192.168.188.124 codis124    codis-server  codis-proxy  nginx-tcp  lvs</span><br><span class="line">192.168.188.125 codis125  codis-server  codis-dashboard codis-fe</span><br><span class="line">以下操作的基本目录</span><br><span class="line">[root@codis125 codis]# pwd -L</span><br><span class="line">/usr/local/codis</span><br><span class="line">[root@codis125 codis]# pwd -P</span><br><span class="line">/data/go/src/github.com/CodisLabs/codis</span><br><span class="line"></span><br><span class="line">2，启动codis-dashobard（codis125上操作）</span><br><span class="line">1)，修改dashboard.toml配置文件</span><br><span class="line">[root@codis125 codis]# cat config/dashboard.toml</span><br><span class="line">主要修改这几行</span><br><span class="line"># Set Coordinator, only accept &quot;zookeeper&quot; &amp; &quot;etcd&quot; &amp; &quot;filesystem&quot;.</span><br><span class="line">coordinator_name = &quot;zookeeper&quot;</span><br><span class="line">coordinator_addr = &quot;192.168.188.120:2181,192.168.188.121:2181,192.168.188.122:2181&quot;</span><br><span class="line"># Set Codis Product Name/Auth.</span><br><span class="line">product_name = &quot;codis-product1&quot;</span><br><span class="line">product_auth = &quot;&quot;</span><br><span class="line"># Set bind address for admin(rpc), tcp only.</span><br><span class="line">admin_addr = &quot;0.0.0.0:18080&quot;</span><br><span class="line"></span><br><span class="line">2），启动脚本</span><br><span class="line">启动前需要修改脚本zookeeper地址池与product名称</span><br><span class="line">[root@codis125 codis]#cat  ./admin/codis-dashboard-admin.sh</span><br><span class="line">$CODIS_ADMIN_TOOL_BIN -v --remove-lock --product=codis-product1 --zookeeper=192.168.188.120:2181,192.168.188.121:2181,192.168.188.122:2181</span><br><span class="line">[root@codis125 codis]#  ./admin/codis-dashboard-admin.sh start</span><br><span class="line"></span><br><span class="line">3），检查日志与端口</span><br><span class="line">[root@codis125 codis]# cat log/codis-dashboard.log.2017-09-11</span><br><span class="line">2017/09/11 17:42:08 main.go:78: [WARN] set ncpu = 8</span><br><span class="line">2017/09/11 17:42:08 zkclient.go:23: [INFO] zookeeper - zkclient setup new connection to 192.168.188.120:2181,192.168.188.121:2181,192.168.188.122:2181</span><br><span class="line">2017/09/11 17:42:08 zkclient.go:23: [INFO] zookeeper - Connected to 192.168.188.121:2181</span><br><span class="line">2017/09/11 17:42:08 topom.go:119: [WARN] create new topom:</span><br><span class="line">&#123;</span><br><span class="line">&quot;token&quot;: &quot;a10e7a35209d1db8f21c8e89a78a6c9a&quot;,</span><br><span class="line">&quot;start_time&quot;: &quot;2017-09-11 17:42:08.1058555 +0800 CST&quot;,</span><br><span class="line">&quot;admin_addr&quot;: &quot;codis125:18080&quot;,</span><br><span class="line">&quot;product_name&quot;: &quot;codis-product2&quot;,</span><br><span class="line">&quot;pid&quot;: 18029,</span><br><span class="line">&quot;pwd&quot;: &quot;/usr/local/codis&quot;,</span><br><span class="line">&quot;sys&quot;: &quot;Linux codis125 3.10.0-514.26.2.el7.x86_64 #1 SMP Tue Jul 4 15:04:05 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux&quot;</span><br><span class="line">&#125;</span><br><span class="line">2017/09/11 17:42:08 main.go:103: [WARN] create topom with config</span><br><span class="line">coordinator_name = &quot;zookeeper&quot;</span><br><span class="line">coordinator_addr = &quot;192.168.188.120:2181,192.168.188.121:2181,192.168.188.122:2181&quot;</span><br><span class="line">admin_addr = &quot;0.0.0.0:18080&quot;</span><br><span class="line">product_name = &quot;codis-product1&quot;</span><br><span class="line">product_auth = &quot;&quot;</span><br><span class="line">migration_method = &quot;semi-async&quot;</span><br><span class="line">migration_parallel_slots = 100</span><br><span class="line">migration_async_maxbulks = 200</span><br><span class="line">migration_async_maxbytes = &quot;32mb&quot;</span><br><span class="line">migration_async_numkeys = 500</span><br><span class="line">migration_timeout = &quot;30s&quot;</span><br><span class="line">sentinel_quorum = 2</span><br><span class="line">sentinel_parallel_syncs = 1</span><br><span class="line">sentinel_down_after = &quot;30s&quot;</span><br><span class="line">sentinel_failover_timeout = &quot;5m&quot;</span><br><span class="line">sentinel_notification_script = &quot;&quot;</span><br><span class="line">sentinel_client_reconfig_script = &quot;&quot;</span><br><span class="line">2017/09/11 17:42:08 topom.go:424: [WARN] admin start service on [::]:18080</span><br><span class="line">2017/09/11 17:42:08 main.go:116: [WARN] option --pidfile = /usr/local/codis/bin/codis-dashboard.pid</span><br><span class="line">2017/09/11 17:42:08 zkclient.go:23: [INFO] zookeeper - Authenticated: id=170697207944249344, timeout=40000</span><br><span class="line">2017/09/11 17:42:08 zkclient.go:23: [INFO] zookeeper - Re-submitting `0` credentials after reconnect</span><br><span class="line">2017/09/11 17:42:08 main.go:140: [WARN] [0xc42033e120] dashboard is working ...</span><br><span class="line">[root@codis125 codis]# netstat -tulpn |grep codis-dashboa</span><br><span class="line">tcp6      0      0 :::18080                :::*                    LISTEN      32006/codis-dashboa</span><br><span class="line"></span><br><span class="line">4)，检查服务</span><br><span class="line">http://192.168.188.125:18080/topom</span><br><span class="line"></span><br><span class="line">3，启动codis-proxy（codis123与codis124上操作）</span><br><span class="line">1)，修改codis-proxy启动脚本</span><br><span class="line">[root@codis124 codis]# cat admin/codis-proxy-admin.sh|grep DASH</span><br><span class="line">CODIS_DASHBOARD_ADDR=&quot;192.168.188.125:18080&quot;</span><br><span class="line">2)，修改proxy.toml配置</span><br><span class="line">[root@codis124 codis]# cat config/proxy.toml|grep -Ev &quot;^#|^$&quot;</span><br><span class="line">product_name = &quot;codis-product1&quot;</span><br><span class="line">product_auth = &quot;&quot;</span><br><span class="line">session_auth = &quot;&quot;</span><br><span class="line">admin_addr = &quot;0.0.0.0:11080&quot;</span><br><span class="line">proto_type = &quot;tcp4&quot;</span><br><span class="line">proxy_addr = &quot;0.0.0.0:19000&quot;</span><br><span class="line">3)，启动codis-proxy脚本</span><br><span class="line">[root@codis124 codis]# ./admin/codis-proxy-admin.sh start</span><br><span class="line">4），检查日志与端口</span><br><span class="line">[root@codis124 codis]# cat log/codis-proxy.log.2017-09-11</span><br><span class="line">[root@codis124 codis]# netstat -tulpn|grep codis-proxy</span><br><span class="line">tcp        0      0 0.0.0.0:19000          0.0.0.0:*              LISTEN      31971/codis-proxy</span><br><span class="line">tcp6      0      0 :::11080                :::*                    LISTEN      31971/codis-proxy</span><br><span class="line"></span><br><span class="line">4，启动codis-server（需要在所有上操作）</span><br><span class="line">1），修改启动脚本</span><br><span class="line">vim /usr/local/codis/admin/codis-server-admin-6379.sh start</span><br><span class="line">vim /usr/local/codis/admin/codis-server-admin-6380.sh start</span><br><span class="line">主要注意以下几点</span><br><span class="line">[root@codis125 codis]# cat /usr/local/codis/admin/codis-server-admin-6379.sh |grep -Ev &quot;^#|^$&quot;|grep 6379</span><br><span class="line">CODIS_SERVER_PID_FILE=/data/codis/6379/redis_6379.pid</span><br><span class="line">CODIS_SERVER_LOG_FILE=/data/codis/6379/redis_6379.log</span><br><span class="line">CODIS_SERVER_CONF_FILE=$CODIS_CONF_DIR/redis-6379.conf</span><br><span class="line">2），修改服务配置</span><br><span class="line">[root@codis120 codis]# mkdir -p /data/redis/6379</span><br><span class="line">[root@codis120 codis]# mkdir -p /data/redis/6380</span><br><span class="line">[root@codis120 codis]# vim /usr/local/codis/config/redis-6379.conf</span><br><span class="line">[root@codis120 codis]# vim /usr/local/codis/config/redis-6380.conf</span><br><span class="line"></span><br><span class="line">主要是注意以下几点</span><br><span class="line">[root@codis120 codis]# cat /usr/local/codis/config/redis-6379.conf |grep -Ev &quot;^#|^$&quot;|grep 6379</span><br><span class="line">port 6379</span><br><span class="line">pidfile /data/redis/6379/redis_6379.pid</span><br><span class="line">logfile &quot;/data/redis/6379/redis_6379.log&quot;</span><br><span class="line">dir /data/redis/6379</span><br><span class="line">3），启动codis-server服务</span><br><span class="line">[root@codis120 codis]# ./admin/codis-server-admin-6379.sh start</span><br><span class="line">/usr/local/codis/admin/../config/redis-6379.conf</span><br><span class="line">starting codis-server ...</span><br><span class="line">[root@codis120 codis]# ./admin/codis-server-admin-6380.sh start</span><br><span class="line">/usr/local/codis/admin/../config/redis-6380.conf</span><br><span class="line">starting codis-server ...</span><br><span class="line">4），检测日志与端口</span><br><span class="line">[root@codis120 codis]# netstat -tulpn |grep codis-server</span><br><span class="line">tcp        0      0 192.168.188.120:6379      0.0.0.0:*              LISTEN      22231/codis-server</span><br><span class="line">tcp        0      0 192.168.188.120:6380      0.0.0.0:*              LISTEN      22308/codis-server</span><br><span class="line"></span><br><span class="line">5，启动codis-fe（codis125上操作）</span><br><span class="line">1），修改codis-fe启动脚本</span><br><span class="line">[root@codis125 codis]# cat admin/codis-fe-admin.sh</span><br><span class="line">主要修改这几行</span><br><span class="line">#!/usr/bin/env bash</span><br><span class="line">#COORDINATOR_NAME=&quot;filesystem&quot;</span><br><span class="line">#COORDINATOR_ADDR=&quot;/tmp/codis&quot;</span><br><span class="line">COORDINATOR_NAME=&quot;zookeeper&quot;</span><br><span class="line">COORDINATOR_ADDR=&quot;192.168.188.120:2181,192.168.188.121:2181,192.168.188.122:2181&quot;</span><br><span class="line">2），启动codis-fe脚本</span><br><span class="line">[root@codis125 codis]#  ./admin/codis-fe-admin.sh start</span><br><span class="line">3），检查日志与端口</span><br><span class="line">[root@codis125 codis]# cat log/codis-fe.log.2017-09-11</span><br><span class="line">2017/09/11 19:24:32 main.go:101: [WARN] set ncpu = 8</span><br><span class="line">2017/09/11 19:24:32 main.go:104: [WARN] set listen = 0.0.0.0:9090</span><br><span class="line">2017/09/11 19:24:32 main.go:120: [WARN] set assets = /usr/local/codis/bin/assets</span><br><span class="line">2017/09/11 19:24:32 main.go:155: [WARN] set --zookeeper = 192.168.188.120:2181,192.168.188.121:2181,192.168.188.122:2181</span><br><span class="line">2017/09/11 19:24:32 zkclient.go:23: [INFO] zookeeper - zkclient setup new connection to 192.168.188.120:2181,192.168.188.121:2181,192.168.188.122:2181</span><br><span class="line">2017/09/11 19:24:32 main.go:209: [WARN] option --pidfile = /usr/local/codis/bin/codis-fe.pid</span><br><span class="line">2017/09/11 19:24:32 zkclient.go:23: [INFO] zookeeper - Connected to 192.168.188.120:2181</span><br><span class="line">2017/09/11 19:24:32 zkclient.go:23: [INFO] zookeeper - Authenticated: id=98639613905403907, timeout=40000</span><br><span class="line">2017/09/11 19:24:32 zkclient.go:23: [INFO] zookeeper - Re-submitting `0` credentials after reconnect</span><br><span class="line">[root@codis125 codis]# netstat -tupnl |grep codis-fe</span><br><span class="line">tcp6      0      0 :::9090                :::*                    LISTEN      32141/codis-fe</span><br><span class="line">4），访问面板</span><br><span class="line">http://192.168.188.125:9090/#codis-product1</span><br></pre></td></tr></table></figure>

<h3 id="六、Codis-fe面板操作"><a href="#六、Codis-fe面板操作" class="headerlink" title="六、Codis-fe面板操作"></a>六、Codis-fe面板操作</h3><p>1、通过codis-fe添加group 通过web浏览器访问集群管理页面(fe地址:<a target="_blank" rel="noopener" href="http://192.168.188.125:9090/#codis-product1">http://192.168.188.125:9090/#codis-product1</a>) 选择我们刚搭建的集群 codis-product1，在 Proxy 栏可看到我们已经启动的 Proxy， 但是 Group 栏为空，因为我们启动的 codis-server 并未加入到集群 添加 NEW GROUP，NEW GROUP 行输入 1，再点击 NEW GROUP 即可 添加 Codis Server，Add Server 行输入我们刚刚启动的 codis-server 地址，添加到我们刚新建的 Group，然后再点击 Add Server 按钮即可。 如上依次添加6个group，12个codis-server，默认每组里面第一个添加的为主，第二个添加的设置为从，同一个节点2个实例不能设置为同一group。</p>
<p>2、通过codis-fe初始化solt 新增的集群 slot 状态是 offline，因此我们需要对它进行初始化（将 1024 个 slot 分配到各个 group），而初始化最快的方法可通过 fe 提供的 rebalance all slots 按钮来做，如下图 所示，点击此按钮，我们即快速完成了一个集群的搭建。 自动分配1024个solt到6个group，reblance all solts会自动分配完所以solt到6个group。</p>
<h3 id="七、代理HA"><a href="#七、代理HA" class="headerlink" title="七、代理HA"></a>七、代理HA</h3><p>1、在codis123与codis124上安装lvs与nginx-tcp 2、配置好VIP+19000端口为第一个codis-dashboard业务线使用，其他类推 192.168.188.131:19000 [root@codis124 keepalived]# vim keepalived.conf 注意大网段一般不使用多播，使用单播。 有的时候也用单播：比如路由交换层禁用了ARP的广播限制，造成KEEPALIVE主备协议无法通过广播的方式进行通信，造成主备两台服务器都强占HAVIP地址，出现同时两台服务器都有VIP地址 的情况出现，必须通过配置来指定IP的两台服务器间进行通讯。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state BACKUP</span><br><span class="line">interface eth0</span><br><span class="line">virtual_router_id 131</span><br><span class="line">unicast_src_ip 192.168.188.124</span><br><span class="line">unicast_peer &#123;</span><br><span class="line">192.168.188.123</span><br><span class="line">&#125;</span><br><span class="line">priority 50</span><br><span class="line">advert_int 3</span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass bitauto</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123;</span><br><span class="line">192.168.188.131</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@codis124 keepalived]# systemctl enable keepalived</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/keepalived.service to /usr/lib/systemd/system/keepalived.service.</span><br><span class="line">[root@codis124 keepalived]# systemctl start keepalived</span><br><span class="line">[root@codis124 keepalived]# systemctl status keepalived</span><br><span class="line">● keepalived.service - LVS and VRRP High Availability Monitor</span><br><span class="line">Loaded: loaded (/usr/lib/systemd/system/keepalived.service; enabled; vendor preset: disabled)</span><br><span class="line">Active: active (running) since Tue 2017-09-12 11:01:31 CST; 5s ago</span><br><span class="line">Process: 32865 ExecStart=/usr/sbin/keepalived $KEEPALIVED_OPTIONS (code=exited, status=0/SUCCESS)</span><br><span class="line">Main PID: 32866 (keepalived)</span><br><span class="line">CGroup: /system.slice/keepalived.service</span><br><span class="line">├─32866 /usr/sbin/keepalived -D</span><br><span class="line">├─32867 /usr/sbin/keepalived -D</span><br><span class="line">└─32870 /usr/sbin/keepalived -D</span><br><span class="line"></span><br><span class="line">[root@codis124 keepalived]# ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">-&gt; RemoteAddress:Port          Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  192.168.188.131:19000 wrr</span><br><span class="line">-&gt; 192.168.188.123:19000          Route  0      0          0</span><br><span class="line">-&gt; 192.168.188.124:19000          Route  1      0          0</span><br><span class="line"></span><br><span class="line">主从切换验证分别在主上停止启动keepalived</span><br><span class="line">[root@codis124 keepalived]# tail -f /var/log/messages</span><br><span class="line">Sep 12 11:01:31 codis124 Keepalived_healthcheckers[32867]: Configuration is using : 14608 Bytes</span><br><span class="line">Sep 12 11:01:31 codis124 Keepalived_healthcheckers[32867]: Using LinkWatch kernel netlink reflector...</span><br><span class="line">Sep 12 11:01:31 codis124 Keepalived_healthcheckers[32867]: Activating healthchecker for service [192.168.188.123]:19000</span><br><span class="line">Sep 12 11:01:31 codis124 kernel: IPVS: [wrr] scheduler registered.</span><br><span class="line">Sep 12 11:01:31 codis124 Keepalived_healthcheckers[32867]: Activating healthchecker for service [192.168.188.124]:19000</span><br><span class="line">Sep 12 11:26:16 codis124 Keepalived_vrrp[32870]: VRRP_Instance(VI_1) Transition to MASTER STATE</span><br><span class="line">Sep 12 11:26:19 codis124 Keepalived_vrrp[32870]: VRRP_Instance(VI_1) Entering MASTER STATE</span><br><span class="line">Sep 12 11:26:19 codis124 Keepalived_vrrp[32870]: VRRP_Instance(VI_1) setting protocol VIPs.</span><br><span class="line">Sep 12 11:26:19 codis124 Keepalived_vrrp[32870]: VRRP_Instance(VI_1) Sending gratuitous ARPs on eth0 for 192.168.188.131</span><br><span class="line">Sep 12 11:26:19 codis124 Keepalived_healthcheckers[32867]: Netlink reflector reports IP 192.168.188.131 added</span><br><span class="line">Sep 12 11:26:24 codis124 Keepalived_vrrp[32870]: VRRP_Instance(VI_1) Sending gratuitous ARPs on eth0 for 192.168.188.131</span><br><span class="line">Sep 12 11:26:43 codis124 Keepalived_vrrp[32870]: VRRP_Instance(VI_1) Received higher prio advert</span><br><span class="line">Sep 12 11:26:43 codis124 Keepalived_vrrp[32870]: VRRP_Instance(VI_1) Entering BACKUP STATE</span><br><span class="line">Sep 12 11:26:43 codis124 Keepalived_vrrp[32870]: VRRP_Instance(VI_1) removing protocol VIPs.</span><br><span class="line">Sep 12 11:26:43 codis124 Keepalived_healthcheckers[32867]: Netlink reflector reports IP 192.168.188.131 removed</span><br></pre></td></tr></table></figure>

<h3 id="八、客户端通过代理VIP访问"><a href="#八、客户端通过代理VIP访问" class="headerlink" title="八、客户端通过代理VIP访问"></a>八、客户端通过代理VIP访问</h3><p>最后验证效果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">[root@codis120 config]# telnet 192.168.188.131 19000</span><br><span class="line">Trying 192.168.188.131...</span><br><span class="line">Connected to 192.168.188.131.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">info</span><br><span class="line">$2284</span><br><span class="line"># Server</span><br><span class="line">redis_version:3.2.8</span><br><span class="line">redis_git_sha1:00000000</span><br><span class="line">redis_git_dirty:0</span><br><span class="line">redis_build_id:d0ce2cfe7ff224ff</span><br><span class="line">redis_mode:standalone</span><br><span class="line">os:Linux 3.10.0-514.26.2.el7.x86_64 x86_64</span><br><span class="line">arch_bits:64</span><br><span class="line">multiplexing_api:epoll</span><br><span class="line">gcc_version:4.8.5</span><br><span class="line">process_id:31915</span><br><span class="line">run_id:e5e12d6e422b0670a3a761350f6ad5ac5ec14d6f</span><br><span class="line">tcp_port:6379</span><br><span class="line">uptime_in_seconds:58481</span><br><span class="line">uptime_in_days:0</span><br><span class="line">hz:10</span><br><span class="line">lru_clock:12015071</span><br><span class="line">executable:/usr/local/codis/admin/../bin/codis-server</span><br><span class="line">config_file:/usr/local/codis/admin/../config/redis-6379.conf</span><br><span class="line"># Clients</span><br><span class="line">connected_clients:33</span><br><span class="line">client_longest_output_list:0</span><br><span class="line">client_biggest_input_buf:0</span><br><span class="line">blocked_clients:0</span><br><span class="line"># Memory</span><br><span class="line">used_memory:4554376</span><br><span class="line">used_memory_human:4.34M</span><br><span class="line">used_memory_rss:16281600</span><br><span class="line">used_memory_rss_human:15.53M</span><br><span class="line">used_memory_peak:5537432</span><br><span class="line">used_memory_peak_human:5.28M</span><br><span class="line">total_system_memory:16650620928</span><br><span class="line">total_system_memory_human:15.51G</span><br><span class="line">used_memory_lua:37888</span><br><span class="line">used_memory_lua_human:37.00K</span><br><span class="line">maxmemory:0</span><br><span class="line">maxmemory_human:0B</span><br><span class="line">maxmemory_policy:noeviction</span><br><span class="line">mem_fragmentation_ratio:3.57</span><br><span class="line">mem_allocator:jemalloc-4.0.3</span><br><span class="line"># Persistence</span><br><span class="line">loading:0</span><br><span class="line">rdb_changes_since_last_save:0</span><br><span class="line">rdb_bgsave_in_progress:0</span><br><span class="line">rdb_last_save_time:1505139604</span><br><span class="line">rdb_last_bgsave_status:ok</span><br><span class="line">rdb_last_bgsave_time_sec:0</span><br><span class="line">rdb_current_bgsave_time_sec:-1</span><br><span class="line">aof_enabled:0</span><br><span class="line">aof_rewrite_in_progress:0</span><br><span class="line">aof_rewrite_scheduled:0</span><br><span class="line">aof_last_rewrite_time_sec:-1</span><br><span class="line">aof_current_rewrite_time_sec:-1</span><br><span class="line">aof_last_bgrewrite_status:ok</span><br><span class="line">aof_last_write_status:ok</span><br><span class="line"># Stats</span><br><span class="line">total_connections_received:99</span><br><span class="line">total_commands_processed:448295</span><br><span class="line">instantaneous_ops_per_sec:13</span><br><span class="line">total_net_input_bytes:8662811</span><br><span class="line">total_net_output_bytes:113597360</span><br><span class="line">instantaneous_input_kbps:0.22</span><br><span class="line">instantaneous_output_kbps:2.89</span><br><span class="line">rejected_connections:0</span><br><span class="line">sync_full:1</span><br><span class="line">sync_partial_ok:0</span><br><span class="line">sync_partial_err:0</span><br><span class="line">expired_keys:0</span><br><span class="line">evicted_keys:0</span><br><span class="line">keyspace_hits:0</span><br><span class="line">keyspace_misses:0</span><br><span class="line">pubsub_channels:0</span><br><span class="line">pubsub_patterns:0</span><br><span class="line">latest_fork_usec:794</span><br><span class="line">migrate_cached_sockets:0</span><br><span class="line"># Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=192.168.188.122,port=6380,state=online,offset=66655,lag=1</span><br><span class="line">master_repl_offset:66669</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:2</span><br><span class="line">repl_backlog_histlen:66668</span><br><span class="line"># CPU</span><br><span class="line">used_cpu_sys:23.81</span><br><span class="line">used_cpu_user:19.91</span><br><span class="line">used_cpu_sys_children:0.00</span><br><span class="line">used_cpu_user_children:0.00</span><br><span class="line"># Cluster</span><br><span class="line">cluster_enabled:0</span><br><span class="line"># Keyspace</span><br></pre></td></tr></table></figure>

<h3 id="九、压力测试"><a href="#九、压力测试" class="headerlink" title="九、压力测试"></a>九、压力测试</h3><p>多个客户端压力测试效果如下： redis-benchmark -h 192.168.188.131 -p 19000 -q -n 1000000 -c 20 -d 100k</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/11/21/2018/11/2018-11-21-openresty-codis%E9%9B%86%E7%BE%A4%E7%BC%93%E5%AD%98%E7%B3%BB%E7%BB%9F/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/21/2018/11/2018-11-21-openresty-codis%E9%9B%86%E7%BE%A4%E7%BC%93%E5%AD%98%E7%B3%BB%E7%BB%9F/index/" class="post-title-link" itemprop="url">OpenResty Codis集群缓存系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-21 08:00:00" itemprop="dateCreated datePublished" datetime="2018-11-21T08:00:00+08:00">2018-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<h3 id="部署环境"><a href="#部署环境" class="headerlink" title="部署环境"></a><strong>部署环境</strong></h3><p>OpenResty1.12.5 Codis3.2集群（客户端不支持Redis集群协议故选择了Codis集群） Nginx1.12.1反向代理 Iis7源站</p>
</blockquote>
<h3 id="依赖的第三方模块"><a href="#依赖的第三方模块" class="headerlink" title="依赖的第三方模块"></a><strong>依赖的第三方模块</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">echo-nginx-module</span><br><span class="line">[https://github.com/openresty/echo-nginx-module](https://github.com/openresty/echo-nginx-module) </span><br><span class="line">set-misc-nginx-module </span><br><span class="line">[https://github.com/openresty/set-misc-nginx-module](https://github.com/openresty/set-misc-nginx-module) </span><br><span class="line">redis-nginx-module</span><br><span class="line">redis2-nginx-module</span><br><span class="line">[https://github.com/openresty/redis2-nginx-module](https://github.com/openresty/redis2-nginx-module) </span><br><span class="line">srcach-nginx-module </span><br><span class="line">[https://github.com/openresty/srcache-nginx-module](https://github.com/openresty/srcache-nginx-module) </span><br></pre></td></tr></table></figure>

<h3 id="测试架构"><a href="#测试架构" class="headerlink" title="测试架构"></a><strong>测试架构</strong></h3><p>客户端——OR入口——Codis缓存——Nginx反向代理——IIS源站</p>
<h3 id="一、测试效果"><a href="#一、测试效果" class="headerlink" title="一、测试效果"></a><strong>一、测试效果</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">测试SET GET KEY</span><br><span class="line">http://www.test.com/350/thread-13741876.html</span><br><span class="line">OR访问日志</span><br><span class="line">172.17.0.20 - - [13/Sep/2017:20:14:23 +0800] &quot;GET /350/thread-13741876.html HTTP/1.1&quot; &quot;200&quot; 17909 0.060 18361 1382 [0.057] [MISS] [STORE] [6666]</span><br><span class="line">172.17.0.20 - - [13/Sep/2017:20:15:52 +0800] &quot;GET /350/thread-13741876.html HTTP/1.1&quot; &quot;200&quot; 17896 0.003 18327 1382 [-] [HIT] [BYPASS] [-]</span><br><span class="line">Nginx访问日志（只有1次记录，第二次缓存命中没有回源）</span><br><span class="line">&#123; &quot;@timestamp&quot;: &quot;2017-09-13T20:14:33+08:00&quot;, &quot;clientRealIp&quot;: &quot;172.17.0.20&quot;, &quot;size&quot;: 17896, &quot;method&quot;: &quot;GET&quot;, &quot;responsetime&quot;: 0.055, &quot;upstreamhost&quot;: &quot;172.17.3.97:80&quot;, </span><br><span class="line">&quot;http_host&quot;: &quot;www.test.com&quot;, &quot;url&quot;: &quot;http://www.test.com/350/thread-13741876.html&quot;, &quot;referrer&quot;: &quot;-&quot;, &quot;agent&quot;: &quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64) </span><br><span class="line">AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.113 Safari/537.36&quot;, &quot;status&quot;: &quot;200&quot;&#125; </span><br><span class="line">6666秒默认缓存</span><br><span class="line">[root@client ]# redis-cli -h 172.17.6.131 -p 19000</span><br><span class="line">172.17.6.131:19000&gt; TTL www.test.com/350/thread-13741876.html</span><br><span class="line">(integer) 6639</span><br><span class="line">测试DEL KEY</span><br><span class="line">浏览器发送删除KEY请求</span><br><span class="line">http://www.test.com/delkey/www.test.com/350/thread-13741876.html</span><br><span class="line">Codis集群上验证</span><br><span class="line">172.17.6.131:19000&gt; TTL www.test.com/350/thread-13741876.html</span><br><span class="line">(integer) -2</span><br></pre></td></tr></table></figure>

<h3 id="二、配置详解"><a href="#二、配置详解" class="headerlink" title="二、配置详解"></a><strong>二、配置详解</strong></h3><h4 id="1、设置Codis集群信息"><a href="#1、设置Codis集群信息" class="headerlink" title="1、设置Codis集群信息"></a>1、设置Codis集群信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    upstream redis_server &#123;</span><br><span class="line">        server 172.17.6.131:19000; #Codis集群对外VIP，TCP协议</span><br><span class="line">        keepalive 100; #一个连接池最多100个连接可根据实际情况设置</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、设置Nginx反向代理"><a href="#2、设置Nginx反向代理" class="headerlink" title="2、设置Nginx反向代理"></a>2、设置Nginx反向代理</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    upstream baa_test_com &#123;</span><br><span class="line">        server 172.17.2.216:80;        #Nginx反向代理前端IP</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3、删除key，默认优先级最高，注意每个location里记录日志方便查看"><a href="#3、删除key，默认优先级最高，注意每个location里记录日志方便查看" class="headerlink" title="3、删除key，默认优先级最高，注意每个location里记录日志方便查看"></a>3、删除key，默认优先级最高，注意每个location里记录日志方便查看</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">        location ~ /delkey/(.*) &#123;</span><br><span class="line">                set $redis_key $1;   #set redis_key为匹配url（）里内容</span><br><span class="line">                redis2_query del $redis_key;    #redis2_query语法类似redis_cli语法例如语法: redis2_query 指令 参数1 参数2，这里代表删除key，key名字为上面获取的 </span><br><span class="line">                redis2_pass redis_server;   #redis反向代理可知道upsteam明或者IP：端口</span><br><span class="line">                access_log  /data/wwwlogs/access_www.test.com-delkey.log srcache_log;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="4、这里针对目录进行配置测试"><a href="#4、这里针对目录进行配置测试" class="headerlink" title="4、这里针对目录进行配置测试"></a>4、这里针对目录进行配置测试</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">        location / &#123;</span><br><span class="line">            default_type text/html;</span><br><span class="line">            srcache_methods GET; #设置对那些HTTP请求缓存，这里只缓存GET</span><br><span class="line">            srcache_response_cache_control off;  #默认开启，用于http，server，location区域，开启后发现response header的Cache-Control与Expires有以下情况的：private、no-store、no-cache、max-age=0、data-no-more-recently-than-now的跳过缓存；当源站策略为不缓存时需要强制缓存源站内容，这个参数需要设置为off，设置为off后缓存策略参考srcache_expire</span><br><span class="line">            srcache_store_statuses 200 301 302;  #缓存状态吗，根据情况自己设定</span><br><span class="line">            srcache_store_max_size 1024000;      #设置缓存key最大value值，单位字节</span><br><span class="line">            set $key $host$uri; #设置key命名规则：域名加url</span><br><span class="line">            set_escape_uri $escaped_key $key;   #转义key，url里面特殊字符需要转义</span><br><span class="line"></span><br><span class="line">            srcache_fetch GET /redis_get $key;   #获取key内容 </span><br><span class="line">            srcache_default_expire 6666; #设置默认缓存时间，单位秒</span><br><span class="line">            srcache_max_expire 2h;            #设置最大缓存时间该值不能大于597h</span><br><span class="line">            srcache_store PUT /redis_set key=$escaped_key&amp;exptime=$srcache_expire;  #存储key时设置key及过期时间，srcache_expire算法是这样的：首先读response header 的Cache-Control:max-age=N，其次读response header的 Expires ，最后读srcahe_default_expire</span><br><span class="line"></span><br><span class="line">            add_header X-Cached-From $srcache_fetch_status;  #添加命中状态响应头</span><br><span class="line">            add_header X-Cached-Store $srcache_store_status;  #添加存储状态响应头</span><br><span class="line">            add_header X-Key $key; #添加key名字响应头</span><br><span class="line">            add_header X-expire $srcache_expire; #添加过期时间响应头</span><br><span class="line"></span><br><span class="line">            access_log /data/wwwlogs/access_baa.test.com-redis.log srcache_log;</span><br><span class="line">            proxy_pass http://baa_test_com;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="5、GET-KEY配置"><a href="#5、GET-KEY配置" class="headerlink" title="5、GET KEY配置"></a>5、GET KEY配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        location = /redis_get &#123;</span><br><span class="line">                internal; #内部访问为了安全</span><br><span class="line">                set $redis_key $args;      #对应前面的srcache_fetch GET /redis_get $key ，这个$args就是key的名字</span><br><span class="line">                redis_pass redis_server;</span><br><span class="line">        &#125; </span><br></pre></td></tr></table></figure>

<h4 id="6、SET-KEY配置"><a href="#6、SET-KEY配置" class="headerlink" title="6、SET KEY配置"></a>6、SET KEY配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">        location = /redis_set &#123;</span><br><span class="line">                internal;</span><br><span class="line">                set_unescape_uri $exptime $arg_exptime;   #对应前面的srcache_store PUT /redis_set key=$escaped_key&amp;exptime=$srcache_expire;  这里是获取并设置过期时间且使用了非转义</span><br><span class="line">                set_unescape_uri $key $arg_key;   #对应前面的srcache_store PUT /redis_set key=$escaped_key&amp;exptime=$srcache_expire;  这里是获取并设置key且使用了非转义</span><br><span class="line">                redis2_query set $key $echo_request_body;  #这里正式存储key，key的value值是请求体，这里用到了echo模块</span><br><span class="line">                redis2_query expire $key $exptime;               #设置key的过期时间 </span><br><span class="line">                redis2_pass redis_server;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="7、日志格式，分正常格式与Srcache格式"><a href="#7、日志格式，分正常格式与Srcache格式" class="headerlink" title="7、日志格式，分正常格式与Srcache格式"></a>7、日志格式，分正常格式与Srcache格式</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    log_format  srcache_log &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                                &#x27;&quot;$status&quot; $body_bytes_sent $request_time $bytes_sent $request_length &#x27;</span><br><span class="line">                                &#x27;[$upstream_response_time] [$srcache_fetch_status] [$srcache_store_status] [$srcache_expire]&#x27;;</span><br><span class="line">日志格式对比传统的nginx日志格式新增了缓存名字状态、缓存存储状态、过期时间</span><br></pre></td></tr></table></figure>

<h4 id="8、完整配置文件如下"><a href="#8、完整配置文件如下" class="headerlink" title="8、完整配置文件如下"></a>8、完整配置文件如下</h4><p> 略，根据实际情况修改。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/11/21/2018/11/2018-11-21-redis3-x%E4%B8%8E4-x%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/21/2018/11/2018-11-21-redis3-x%E4%B8%8E4-x%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96/index/" class="post-title-link" itemprop="url">Redis3.x与4.x集群部署配置优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-21 08:00:00" itemprop="dateCreated datePublished" datetime="2018-11-21T08:00:00+08:00">2018-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><p><a target="_blank" rel="noopener" href="http://www.redis.cn/topics/cluster-spec.html">http://www.redis.cn/topics/cluster-spec.html</a></p>
</blockquote>
<h3 id="键分布模型"><a href="#键分布模型" class="headerlink" title="键分布模型"></a>键分布模型</h3><p>键空间被分割为 16384 槽（slot），事实上集群的最大节点数量是 16384 个。（然而建议最大节点数量设置在1000这个数量级上） 所有的主节点都负责 16384 个哈希槽中的一部分。当集群处于稳定状态时，集群中没有在执行重配置（reconfiguration）操作，每个哈希槽都只由一个节点进行处理（不过主节点可以有一个或多个从节点，可以在网络断线或节点失效时替换掉主节点）。 以下是用来把键映射到哈希槽的算法（下一段哈希标签例外就是按照这个规则）： HASH_SLOT &#x3D; CRC16(key) mod 16384 其中，CRC16的定义如下： 名称：XMODEM（也可以称为 ZMODEM 或 CRC-16&#x2F;ACORN） 输出长度：16 bit 多项数（poly）：1021（即是 x16 + x12 + x5 + 1 ） 初始化：0000 反射输入字节（Reflect Input byte）：False 反射输入CRC（Reflect Output CRC）：False 用于输出CRC的异或常量（Xor constant to output CRC）：0000 该算法对于输入”123456789”的输出：31C3 CRC16的16位输出中的14位会被使用（这也是为什么上面的式子中有一个对 16384 取余的操作）。 在我们的测试中，CRC16能相当好地把不同的键均匀地分配到 16384 个槽中。 注意： 在本文档的附录A中有CRC16算法的实现。 Redis499问题根本原因是redis发生了阻塞，是linux系统环境（CPU&#x2F;内存&#x2F;IO）、Redis配置、客户端使用多方综合导致，由于大数据部门使用量巨大，需要持续优化验证。</p>
<h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><h4 id="Redis优化相关"><a href="#Redis优化相关" class="headerlink" title="Redis优化相关"></a>Redis优化相关</h4><p>1、单个redis实例 内存控制在10GB以内，fork耗时每GB在20ms左右，10GB在200ms左右（latest_fork_usec:287905），需要配置maxmemory，最大内存的70%左右 2、降低fork操作频率，适度放宽rdb&#x2F;aof自动触发时机（默认只开启rdb持久化且每分钟有1万key变更就触发rdb持久化） 3、repl-timeout默认60s，如果rdb（目前rdb文件压缩后有3G多，不压缩有10GB左右，默认开启压缩，目前量至少需要2-3分钟才能同步完成）60S内数据没有同步到从节点，主节点会认为从节点故障并中断复制连接 4、客户端尽量避免使用高算法复杂度的命令，可以通过info commandstats查看 可能还有其他需要关注的点，后续了解后再补充</p>
<h4 id="Linux配置优化相关（只适用redis服务器）"><a href="#Linux配置优化相关（只适用redis服务器）" class="headerlink" title="Linux配置优化相关（只适用redis服务器）"></a>Linux配置优化相关（只适用redis服务器）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1、关闭THP</span><br><span class="line">临时</span><br><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">永久</span><br><span class="line">/etc/rc.local</span><br><span class="line">if test -f /sys/kernel/mm/redhat_transparent_hugepage/enabled; then</span><br><span class="line">echo never &gt; /sys/kernel/mm/redhat_transparent_hugepage/enabled</span><br><span class="line">fi</span><br><span class="line">2、内存分配策略</span><br><span class="line">临时</span><br><span class="line">echo 1 &gt; /proc/sys/vm/overcommit_memory （默认0）</span><br><span class="line">永久</span><br><span class="line">echo &quot;vm.overcommit_memory=1&quot; &gt;&gt;/etc/sysctl.conf</span><br><span class="line">3、交换分区策略</span><br><span class="line">临时</span><br><span class="line">echo 10 &gt;  /proc/sys/vm/swappiness （默认60）</span><br><span class="line">永久</span><br><span class="line">echo &quot;vm.swappiness=10&quot;  &gt;&gt;/etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">4、分盘存储</span><br><span class="line">单机多实例情况下，不同实例RDB/AOF文件分盘存储（2实例虚拟机最好挂载2块盘）</span><br><span class="line">运营添加业务监控：应用方加入异常报警，发生阻塞时线上应用会最先感知到</span><br><span class="line">运维部署CacheCloud监控集群状态，便于发现定位问题</span><br></pre></td></tr></table></figure>

<h3 id="补充资料"><a href="#补充资料" class="headerlink" title="补充资料"></a>补充资料</h3><h4 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h4><p>redis-cli -c -p 7004 info persistence redis-cli -c -p 7004 info replication redis-cli -c -p 7004 info commandstats redis-cli -c -p 7004 info stats redis-cli -c -p 7004 –stat</p>
<h4 id="集群客户端"><a href="#集群客户端" class="headerlink" title="集群客户端"></a>集群客户端</h4><p>使用最多的时java客户端, Jedis 最近添加了对集群的支持, 详细请查看项目README中Jedis Cluster部分. StackExchange.Redis 提供对 C# 的支持(并且包括大部分 .NET 下面的语言，比如： VB, F#等等) thunk-redis 提供对 Node.js 和 io.js的支持。 Redis unstable 分支中的 redis-cli 程序实现了非常基本的集群支持， 可以使用命令 redis-cli -c 来启动。 redis-cli 对集群的支持是非常基本的， 所以它总是依靠 Redis 集群节点来将它转向（redirect）至正确的节点。一个真正的（serious）集群客户端应该做得比这更好： 它应该用缓存记录起哈希槽与节点地址之间的映射（map）， 从而直接将命令发送到正确的节点上面。这种映射只会在集群的配置出现某些修改时变化， 比如说， 在一次故障转移（failover）之后， 或者系统管理员通过添加节点或移除节点来修改了集群的布局（layout）之后， 诸如此类。 CONFIG SET SAVE “900 1 300 10”. Redis 持久化 Redis 提供了不同级别的持久化方式: RDB持久化方式能够在指定的时间间隔能对你的数据进行快照存储. AOF持久化方式记录每次对服务器写的操作,当服务器重启的时候会重新执行这些命令来恢复原始的数据,AOF命令以redis协议追加保存每次写的操作到文件末尾.Redis还能对AOF文件进行后台重写,使得AOF文件的体积不至于过大. 如果你只希望你的数据在服务器运行的时候存在,你也可以不使用任何持久化方式. 你也可以同时开启两种持久化方式, 在这种情况下, 当redis重启的时候会优先载入AOF文件来恢复原始的数据,因为在通常情况下AOF文件保存的数据集要比RDB文件保存的数据集要完整. 最重要的事情是了解RDB和AOF持久化方式的不同,让我们以RDB持久化方式开始: RDB的优点 RDB是一个非常紧凑的文件,它保存了某个时间点得数据集,非常适用于数据集的备份,比如你可以在每个小时报保存一下过去24小时内的数据,同时每天保存过去30天的数据,这样即使出了问题你也可以根据需求恢复到不同版本的数据集. RDB是一个紧凑的单一文件,很方便传送到另一个远端数据中心或者亚马逊的S3（可能加密），非常适用于灾难恢复. RDB在保存RDB文件时父进程唯一需要做的就是fork出一个子进程,接下来的工作全部由子进程来做，父进程不需要再做其他IO操作，所以RDB持久化方式可以最大化redis的性能. 与AOF相比,在恢复大的数据集的时候，RDB方式会更快一些. RDB的缺点 如果你希望在redis意外停止工作（例如电源中断）的情况下丢失的数据最少的话，那么RDB不适合你.虽然你可以配置不同的save时间点(例如每隔5分钟并且对数据集有100个写的操作),是Redis要完整的保存整个数据集是一个比较繁重的工作,你通常会每隔5分钟或者更久做一次完整的保存,万一在Redis意外宕机,你可能会丢失几分钟的数据. RDB 需要经常fork子进程来保存数据集到硬盘上,当数据集比较大的时候,fork的过程是非常耗时的,可能会导致Redis在一些毫秒级内不能响应客户端的请求.如果数据集巨大并且CPU性能不是很好的情况下,这种情况会持续1秒,AOF也需要fork,但是你可以调节重写日志文件的频率来提高数据集的耐久度. AOF 优点 使用AOF 会让你的Redis更加耐久: 你可以使用不同的fsync策略：无fsync,每秒fsync,每次写的时候fsync.使用默认的每秒fsync策略,Redis的性能依然很好(fsync是由后台线程进行处理的,主线程会尽力处理客户端请求),一旦出现故障，你最多丢失1秒的数据. AOF文件是一个只进行追加的日志文件,所以不需要写入seek,即使由于某些原因(磁盘空间已满，写的过程中宕机等等)未执行完整的写入命令,你也也可使用redis-check-aof工具修复这些问题. Redis 可以在 AOF 文件体积变得过大时，自动地在后台对 AOF 进行重写： 重写后的新 AOF 文件包含了恢复当前数据集所需的最小命令集合。 整个重写操作是绝对安全的，因为 Redis 在创建新 AOF 文件的过程中，会继续将命令追加到现有的 AOF 文件里面，即使重写过程中发生停机，现有的 AOF 文件也不会丢失。 而一旦新 AOF 文件创建完毕，Redis 就会从旧 AOF 文件切换到新 AOF 文件，并开始对新 AOF 文件进行追加操作。 AOF 文件有序地保存了对数据库执行的所有写入操作， 这些写入操作以 Redis 协议的格式保存， 因此 AOF 文件的内容非常容易被人读懂， 对文件进行分析（parse）也很轻松。 导出（export） AOF 文件也非常简单： 举个例子， 如果你不小心执行了 FLUSHALL 命令， 但只要 AOF 文件未被重写， 那么只要停止服务器， 移除 AOF 文件末尾的 FLUSHALL 命令， 并重启 Redis ， 就可以将数据集恢复到 FLUSHALL 执行之前的状态。 AOF 缺点 对于相同的数据集来说，AOF 文件的体积通常要大于 RDB 文件的体积。 根据所使用的 fsync 策略，AOF 的速度可能会慢于 RDB 。 在一般情况下， 每秒 fsync 的性能依然非常高， 而关闭 fsync 可以让 AOF 的速度和 RDB 一样快， 即使在高负荷之下也是如此。 不过在处理巨大的写入载入时，RDB 可以提供更有保证的最大延迟时间（latency）。</p>
<h3 id="部署节点"><a href="#部署节点" class="headerlink" title="部署节点"></a>部署节点</h3><p>echo never &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;redhat_transparent_hugepage&#x2F;enabled echo “vm.overcommit_memory&#x3D;1” &gt;&gt;&#x2F;etc&#x2F;sysctl.conf echo “vm.swappiness&#x3D;10” &gt;&gt;&#x2F;etc&#x2F;sysctl.conf yum -y install tcl-devel wget <a target="_blank" rel="noopener" href="http://download.redis.io/releases/redis-3.2.9.tar.gz">http://download.redis.io/releases/redis-3.2.9.tar.gz</a> tar zxvf redis-3.2.9.tar.gz cd redis-3.2.9 make make test make install sh .&#x2F;utils&#x2F;install_server.sh &#x2F;data&#x2F;redis&#x2F;redis_7001.log &#x2F;data&#x2F;redis&#x2F;7001 Selected config: Port : 7001 Config file : &#x2F;etc&#x2F;redis&#x2F;7001.conf Log file : &#x2F;data&#x2F;redis&#x2F;redis_7001.log Data dir : &#x2F;data&#x2F;redis&#x2F;7001 Executable : &#x2F;usr&#x2F;local&#x2F;bin&#x2F;redis-server Cli Executable : &#x2F;usr&#x2F;local&#x2F;bin&#x2F;redis-cli</p>
<h3 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h3><p>wget <a target="_blank" rel="noopener" href="https://cache.ruby-lang.org/pub/ruby/2.3/ruby-2.3.4.tar.gz">https://cache.ruby-lang.org/pub/ruby/2.3/ruby-2.3.4.tar.gz</a> tar -xzvf ruby-2.3.4.tar.gz cd ruby-2.3.4 .&#x2F;configure –disable-install-rdoc make &amp;&amp; make install &#x2F;usr&#x2F;local&#x2F;bin&#x2F;ruby &#x2F;usr&#x2F;local&#x2F;bin&#x2F;gem gem sources –add <a target="_blank" rel="noopener" href="https://ruby.taobao.org/">https://ruby.taobao.org/</a> –remove <a target="_blank" rel="noopener" href="https://rubygems.org/">https://rubygems.org/</a> gem install redis [root@redisep69 ruby-2.3.4]# gem install redis Fetching: redis-3.3.3.gem (100%) Successfully installed redis-3.3.3 Parsing documentation for redis-3.3.3 Installing ri documentation for redis-3.3.3 Done installing documentation for redis after 1 seconds 1 gem installed</p>
<h3 id="集群节点配置"><a href="#集群节点配置" class="headerlink" title="集群节点配置"></a>集群节点配置</h3><p>[root@redisep69 etc]# cat &#x2F;etc&#x2F;redis&#x2F;7001.conf20170821 bind 192.168.188.69 protected-mode no port 7001 tcp-backlog 511 timeout 0 tcp-keepalive 300 daemonize yes supervised no pidfile &#x2F;var&#x2F;run&#x2F;redis_7001.pid loglevel notice logfile &#x2F;data&#x2F;redis&#x2F;redis_7001.log databases 16 save 900 100 save 300 1000 save 60 10000 stop-writes-on-bgsave-error yes rdbcompression yes rdbchecksum yes dbfilename dump.rdb dir &#x2F;data&#x2F;redis&#x2F;7001 slave-serve-stale-data yes slave-read-only yes repl-diskless-sync no repl-diskless-sync-delay 5 repl-timeout 300 repl-disable-tcp-nodelay no slave-priority 100 maxclients 40000 maxmemory 20gb appendonly no appendfilename “appendonly.aof” appendfsync everysec no-appendfsync-on-rewrite no auto-aof-rewrite-percentage 100 auto-aof-rewrite-min-size 64mb aof-load-truncated yes lua-time-limit 5000 cluster-enabled yes cluster-config-file nodes-7001.conf cluster-node-timeout 10000 slowlog-log-slower-than 10000 slowlog-max-len 128 latency-monitor-threshold 0 notify-keyspace-events “” hash-max-ziplist-entries 512 hash-max-ziplist-value 64 list-max-ziplist-size -2 list-compress-depth 0 set-max-intset-entries 512 zset-max-ziplist-entries 128 zset-max-ziplist-value 64 hll-sparse-max-bytes 3000 activerehashing yes client-output-buffer-limit normal 0 0 0 client-output-buffer-limit slave 256mb 64mb 60 client-output-buffer-limit pubsub 32mb 8mb 60 hz 10 aof-rewrite-incremental-fsync yes</p>
<h3 id="加入集群"><a href="#加入集群" class="headerlink" title="加入集群"></a>加入集群</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@redisep69 bin]# redis-trib.rb create --replicas 1 192.168.188.69:7001 192.168.188.70:7002 192.168.188.71:7003 192.168.188.72:7004 192.168.188.73:7005  192.168.188.74:7006</span><br><span class="line">&gt;&gt;&gt; Creating cluster</span><br><span class="line">&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span><br><span class="line">Using 3 masters:</span><br><span class="line">192.168.188.69:7001</span><br><span class="line">192.168.188.70:7002</span><br><span class="line">192.168.188.71:7003</span><br><span class="line">Adding replica 192.168.188.72:7004 to 192.168.188.69:7001</span><br><span class="line">Adding replica 192.168.188.73:7005 to 192.168.188.70:7002</span><br><span class="line">Adding replica 192.168.188.74:7006 to 192.168.188.71:7003</span><br><span class="line">M: b44e8f7e4505180f9969ecd5fee1b15f5dc3e045 192.168.188.69:7001</span><br><span class="line">slots:0-5460 (5461 slots) master</span><br><span class="line">M: aec4598d4905792ec9e5d8ab7ca403d250a2e89f 192.168.188.70:7002</span><br><span class="line">slots:5461-10922 (5462 slots) master</span><br><span class="line">M: d3e940f440dc5b33969575924bcc416e4658cd0b 192.168.188.71:7003</span><br><span class="line">slots:10923-16383 (5461 slots) master</span><br><span class="line">S: 24df5294bab6cce79fb1e0a134a4f8f761f30006 192.168.188.72:7004</span><br><span class="line">replicates b44e8f7e4505180f9969ecd5fee1b15f5dc3e045</span><br><span class="line">S: e9fe9a686aacb76d16b28460ec17f3f79098dc22 192.168.188.73:7005</span><br><span class="line">replicates aec4598d4905792ec9e5d8ab7ca403d250a2e89f</span><br><span class="line">S: 57015121d70c9f89b01cca162a25397f27ba3171 192.168.188.74:7006</span><br><span class="line">replicates d3e940f440dc5b33969575924bcc416e4658cd0b</span><br><span class="line">Can I set the above configuration? (type &#x27;yes&#x27; to accept): yes</span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting for the cluster to join.....</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 192.168.188.69:7001)</span><br><span class="line">M: b44e8f7e4505180f9969ecd5fee1b15f5dc3e045 192.168.188.69:7001</span><br><span class="line">slots:0-5460 (5461 slots) master</span><br><span class="line">1 additional replica(s)</span><br><span class="line">M: aec4598d4905792ec9e5d8ab7ca403d250a2e89f 192.168.188.70:7002</span><br><span class="line">slots:5461-10922 (5462 slots) master</span><br><span class="line">1 additional replica(s)</span><br><span class="line">S: 24df5294bab6cce79fb1e0a134a4f8f761f30006 192.168.188.72:7004</span><br><span class="line">slots: (0 slots) slave</span><br><span class="line">replicates b44e8f7e4505180f9969ecd5fee1b15f5dc3e045</span><br><span class="line">S: e9fe9a686aacb76d16b28460ec17f3f79098dc22 192.168.188.73:7005</span><br><span class="line">slots: (0 slots) slave</span><br><span class="line">replicates aec4598d4905792ec9e5d8ab7ca403d250a2e89f</span><br><span class="line">S: 57015121d70c9f89b01cca162a25397f27ba3171 192.168.188.74:7006</span><br><span class="line">slots: (0 slots) slave</span><br><span class="line">replicates d3e940f440dc5b33969575924bcc416e4658cd0b</span><br><span class="line">M: d3e940f440dc5b33969575924bcc416e4658cd0b 192.168.188.71:7003</span><br><span class="line">slots:10923-16383 (5461 slots) master</span><br><span class="line">1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">保存节点配置到硬盘（默认会保存）</span><br><span class="line">[root@redisep69 bin]# redis-cli -c -h 192.168.188.69 -p 7001</span><br><span class="line">192.168.188.69:7001&gt; CLUSTER SAVECONFIG</span><br><span class="line">OK</span><br><span class="line">192.168.188.69:7001&gt;</span><br></pre></td></tr></table></figure>

<h3 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@redisep69 etc]# redis-benchmark -d 100  -n 2000000 -t get,set  -q  -h 192.168.188.69 -p 7001</span><br><span class="line">SET: 120685.49 requests per second</span><br><span class="line">GET: 152753.38 requests per second</span><br><span class="line">[root@redisep69 etc]# redis-benchmark -d 10  -n 2000000 -t get,set  -q  -h 192.168.188.69 -p 7001</span><br><span class="line">SET: 148754.19 requests per second</span><br><span class="line">GET: 126887.45 requests per second</span><br><span class="line">[root@redisep69 etc]# redis-benchmark -d 1  -n 2000000 -t get,set  -q  -h 192.168.188.69 -p 7001</span><br><span class="line">SET: 141522.78 requests per second</span><br><span class="line">GET: 158516.30 requests per second</span><br><span class="line">[root@redisep71 ~]# redis-benchmark -d 100  -n 2000000 -t get,set  -q  -h 192.168.188.71 -p 7003</span><br><span class="line">SET: 176928.52 requests per second</span><br></pre></td></tr></table></figure>

<h3 id="三节点集群注意事项"><a href="#三节点集群注意事项" class="headerlink" title="三节点集群注意事项"></a>三节点集群注意事项</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">REDIS3节点集群默认会有一组主从在同一虚拟机上，需要手工调整，架构主-从为7001-7006  7002-7004  7003-7005，以下是调整主从例子。</span><br><span class="line">[root@redis-108 ~]# redis-cli -c -h 172.17.6.110 -p 7006</span><br><span class="line">172.17.6.110:7006&gt; CLUSTER REPLICATE 560eca92df8080db9e0b3d8cf65ac1ed00c30dd0</span><br><span class="line">OK</span><br><span class="line">172.17.6.110:7006&gt; exit</span><br><span class="line">[root@redis-108 ~]# redis-cli -c -h 172.17.6.109 -p 7005</span><br><span class="line">172.17.6.109:7005&gt; CLUSTER REPLICATE 33d3ee604bc6136283038db12967c0dfb09e48a1</span><br><span class="line">OK</span><br><span class="line">172.17.6.109:7005&gt; CLUSTER SAVECONFIG</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h3 id="添加zabbix监控方法"><a href="#添加zabbix监控方法" class="headerlink" title="添加zabbix监控方法"></a>添加zabbix监控方法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">zabbix添加redis模版方法</span><br><span class="line">第一步</span><br><span class="line">vim /usr/local/zabbix/etc/zabbix_agentd.conf</span><br><span class="line">UserParameter=redis.discovery,/usr/local/zabbix/etc/redis_port.sh</span><br><span class="line">UserParameter=redis_stats[*],redis-cli -h 172.17.6.108 -a redis_passwd -p $1 info|grep $2|cut -d : -f2</span><br><span class="line"></span><br><span class="line">第二步</span><br><span class="line">visudo</span><br><span class="line">Defaults:zabbix  !requiretty</span><br><span class="line">zabbix ALL=(root)  NOPASSWD:/bin/netstat</span><br><span class="line">具体sh脚本如下</span><br><span class="line">cat /usr/local/zabbix/etc/redis_port.sh</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">#Fucation:mysql low-level discovery</span><br><span class="line">#Script_name redis_low_discovery.sh</span><br><span class="line">redis() &#123;</span><br><span class="line">port=($(sudo netstat -tpln | awk -F &quot;[ :]+&quot; &#x27;/redis/ &amp;&amp; /0.0.0.0/ &#123;print $5&#125;&#x27;))</span><br><span class="line">printf &#x27;&#123;\n&#x27;</span><br><span class="line">printf &#x27;\t&quot;data&quot;:[\n&#x27;</span><br><span class="line">for key in $&#123;!port[@]&#125;</span><br><span class="line">do</span><br><span class="line">if [[ &quot;$&#123;#port[@]&#125;&quot; -gt 1 &amp;&amp; &quot;$&#123;key&#125;&quot; -ne &quot;$(($&#123;#port[@]&#125;-1))&quot; ]];then</span><br><span class="line">socket=`ps aux|grep $&#123;port[$&#123;key&#125;]&#125;|grep -v grep|awk -F &#x27;=&#x27; &#x27;&#123;print $10&#125;&#x27;|cut -d &#x27; &#x27; -f 1`</span><br><span class="line">printf &#x27;\t &#123;\n&#x27;</span><br><span class="line">printf &quot;\t\t\t\&quot;&#123;#REDISPORT&#125;\&quot;:\&quot;$&#123;port[$&#123;key&#125;]&#125;\&quot;&#125;,\n&quot;</span><br><span class="line">else [[ &quot;$&#123;key&#125;&quot; -eq &quot;(($&#123;#port[@]&#125;-1))&quot; ]]</span><br><span class="line">socket=`ps aux|grep $&#123;port[$&#123;key&#125;]&#125;|grep -v grep|awk -F &#x27;=&#x27; &#x27;&#123;print $10&#125;&#x27;|cut -d &#x27; &#x27; -f 1`</span><br><span class="line">printf &#x27;\t &#123;\n&#x27;</span><br><span class="line">printf &quot;\t\t\t\&quot;&#123;#REDISPORT&#125;\&quot;:\&quot;$&#123;port[$&#123;key&#125;]&#125;\&quot;\n\t &#125;\n&quot;</span><br><span class="line">fi</span><br><span class="line">done</span><br><span class="line">printf &#x27;\t ]\n&#x27;</span><br><span class="line">printf &#x27;&#125;\n&#x27;</span><br><span class="line">&#125;</span><br><span class="line">redis  $1</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/11/21/2018/11/2018-11-21-%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E5%8D%9A%E5%AE%A2/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/21/2018/11/2018-11-21-%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E5%8D%9A%E5%AE%A2/index/" class="post-title-link" itemprop="url">从零开始创建自己的博客</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-21 08:00:00" itemprop="dateCreated datePublished" datetime="2018-11-21T08:00:00+08:00">2018-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dev/" itemprop="url" rel="index"><span itemprop="name">dev</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="minminmsn-com"><a href="#minminmsn-com" class="headerlink" title="minminmsn.com"></a><a target="_blank" rel="noopener" href="https://minminmsn.com/">minminmsn.com</a></h1><blockquote>
<h5 id="是否受够了各博客平台之间频繁切换，精心设计的语言被无辜替换，辛苦维护的博文偶尔遭到无情的误杀，铺天盖地的广告疯狂的轰炸。烦了！倦了！够了！终于我要出手了，现在给你个配方就可以从零开始创建自己的博客，只需要花点儿银子（平均每月百来元即可小玩一把）就能解决以上所有痛点，在自己的地盘自己做主，随意撒野！、"><a href="#是否受够了各博客平台之间频繁切换，精心设计的语言被无辜替换，辛苦维护的博文偶尔遭到无情的误杀，铺天盖地的广告疯狂的轰炸。烦了！倦了！够了！终于我要出手了，现在给你个配方就可以从零开始创建自己的博客，只需要花点儿银子（平均每月百来元即可小玩一把）就能解决以上所有痛点，在自己的地盘自己做主，随意撒野！、" class="headerlink" title="是否受够了各博客平台之间频繁切换，精心设计的语言被无辜替换，辛苦维护的博文偶尔遭到无情的误杀，铺天盖地的广告疯狂的轰炸。烦了！倦了！够了！终于我要出手了，现在给你个配方就可以从零开始创建自己的博客，只需要花点儿银子（平均每月百来元即可小玩一把）就能解决以上所有痛点，在自己的地盘自己做主，随意撒野！、"></a>是否受够了各博客平台之间频繁切换，精心设计的语言被无辜替换，辛苦维护的博文偶尔遭到无情的误杀，铺天盖地的广告疯狂的轰炸。烦了！倦了！够了！终于我要出手了，现在给你个配方就可以从零开始创建自己的博客，只需要花点儿银子（平均每月百来元即可小玩一把）就能解决以上所有痛点，在自己的地盘自己做主，随意撒野！、</h5><h5 id="具体主要包含如下几步（欢迎各位疯狂点赞、收藏、转载、打CALL、投币）："><a href="#具体主要包含如下几步（欢迎各位疯狂点赞、收藏、转载、打CALL、投币）：" class="headerlink" title="具体主要包含如下几步（欢迎各位疯狂点赞、收藏、转载、打CALL、投币）："></a>具体主要包含如下几步（欢迎各位疯狂点赞、收藏、转载、打CALL、投币）：</h5></blockquote>
<ul>
<li><p><a href="#1">一、域名注册</a></p>
</li>
<li><p><a href="#2">二、域名备案</a></p>
</li>
<li><p><a href="#3">三、公安备案</a></p>
</li>
<li><p><a href="#4">四、证书申请</a></p>
</li>
<li><p><a href="#5">五、架构设计</a></p>
<ul>
<li><a href="#5.1">效果图</a></li>
<li><a href="#5.2">架构图</a></li>
</ul>
</li>
<li><p><a href="#6">六、部署配置</a></p>
<ul>
<li><a href="#6.1">Nginx部署</a></li>
<li><a href="#6.2">Nginx配置</a></li>
<li><a href="#6.3">Docker部署</a></li>
</ul>
</li>
<li><p><a href="#7">七、前端设计</a></p>
<ul>
<li><a href="#7.1">模板</a></li>
<li><a href="#7.2">布局</a></li>
</ul>
</li>
<li><p><a href="#8">八、插件选型</a></p>
</li>
<li><p><a href="#9">九、原创内容</a></p>
</li>
</ul>
<h3 id="一、域名注册"><a href="#一、域名注册" class="headerlink" title="一、域名注册"></a>一、域名注册</h3><blockquote>
<p>选择一个有代表性的域名，比如：minminmsn.com<br>参考：<a target="_blank" rel="noopener" href="https://buy.cloud.tencent.com/domain?from=console">https://buy.cloud.tencent.com/domain?from=console</a></p>
</blockquote>
<h3 id="二、域名备案"><a href="#二、域名备案" class="headerlink" title="二、域名备案"></a>二、域名备案</h3><blockquote>
<p>个人站点备案，借助平台还是很方便的，大概20工作日左右可完成（根据大陆法所有域名需要备案，否则后果自负）<br>参考：<a target="_blank" rel="noopener" href="https://console.cloud.tencent.com/beian">https://console.cloud.tencent.com/beian</a></p>
</blockquote>
<h3 id="三、公安备案"><a href="#三、公安备案" class="headerlink" title="三、公安备案"></a>三、公安备案</h3><blockquote>
<p>个人站点非交互页面比较好备案，需要ICP备案后30日启动<br>参考：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/243/19142">https://cloud.tencent.com/document/product/243/19142</a></p>
</blockquote>
<h3 id="四、证书申请"><a href="#四、证书申请" class="headerlink" title="四、证书申请"></a>四、证书申请</h3><blockquote>
<p>竟然有域名型免费版可以免费试用一年（窃喜）<br><a target="_blank" rel="noopener" href="https://buy.cloud.tencent.com/ssl">https://buy.cloud.tencent.com/ssl</a></p>
</blockquote>
<h3 id="五、架构设计"><a href="#五、架构设计" class="headerlink" title="五、架构设计"></a>五、架构设计</h3><h4 id="5-1-效果图"><a href="#5-1-效果图" class="headerlink" title="5.1 效果图"></a>5.1 效果图</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://i.loli.net/2019/01/11/5c383089096a2.jpg"><img src="/images/5c383089096a2.jpg"></a></p>
</blockquote>
<h4 id="5-2-架构图"><a href="#5-2-架构图" class="headerlink" title="5.2 架构图"></a>5.2 架构图</h4><blockquote>
<h4 id="Nginx-证书、跳转、流控、反向代理）"><a href="#Nginx-证书、跳转、流控、反向代理）" class="headerlink" title="Nginx(证书、跳转、流控、反向代理）"></a>Nginx(证书、跳转、流控、反向代理）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|</span><br></pre></td></tr></table></figure>

<h4 id="Docker源站（安全、缓存插件）"><a href="#Docker源站（安全、缓存插件）" class="headerlink" title="Docker源站（安全、缓存插件）"></a>Docker源站（安全、缓存插件）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|</span><br></pre></td></tr></table></figure>

<h4 id="Docker数据库（mysql）"><a href="#Docker数据库（mysql）" class="headerlink" title="Docker数据库（mysql）"></a>Docker数据库（mysql）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|</span><br></pre></td></tr></table></figure>

<h4 id="定期备份（脚本）"><a href="#定期备份（脚本）" class="headerlink" title="定期备份（脚本）"></a>定期备份（脚本）</h4></blockquote>
<h3 id="六、部署配置"><a href="#六、部署配置" class="headerlink" title="六、部署配置"></a>六、部署配置</h3><h4 id="6-1-Nginx部署"><a href="#6-1-Nginx部署" class="headerlink" title="6.1 Nginx部署"></a>6.1 Nginx部署</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.14.1.tar.gz</span><br><span class="line">tar zxvf nginx-1.14.1.tar.gz</span><br><span class="line">cd nginx-1.14.1/</span><br><span class="line">./configure --with-http_ssl_module </span><br><span class="line">make</span><br><span class="line">make install </span><br></pre></td></tr></table></figure>

<h4 id="6-2-Nginx配置"><a href="#6-2-Nginx配置" class="headerlink" title="6.2 Nginx配置"></a>6.2 Nginx配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">user  nobody;</span><br><span class="line">worker_processes  auto;</span><br><span class="line"></span><br><span class="line">error_log  logs/error.log;</span><br><span class="line"></span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">#偶尔调大点就行，个人博客访问量大绝对有问题</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  10240;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    tcp_nopush     on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #开启压缩节省服务器流量</span><br><span class="line">    gzip  on;</span><br><span class="line">    gzip_min_length 1k;</span><br><span class="line">    gzip_buffers 4 16k;</span><br><span class="line">    gzip_comp_level 2;</span><br><span class="line">    gzip_types text/htm application/x-javascript text/css image/jpeg image/png;</span><br><span class="line">    gzip_vary off;</span><br><span class="line"></span><br><span class="line">    #配置限流放置轻微恶搞</span><br><span class="line">    limit_req_status 418;</span><br><span class="line">    limit_conn_status 418;</span><br><span class="line">    limit_req_zone  $binary_remote_addr zone=one:10m rate=3r/s;</span><br><span class="line">    limit_conn_zone $binary_remote_addr zone=addr:10m;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name minminmsn.com m.minminmsn.com www.minminmsn.com;</span><br><span class="line">        return 301 https://wwww.minminmsn.com$request_uri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #注意填上申请的证书及加密算法的安全性</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       443 ssl;</span><br><span class="line">        server_name  www.minminmsn.com;</span><br><span class="line"></span><br><span class="line">        limit_req zone=one burst=5 nodelay;</span><br><span class="line">        limit_conn  addr 5;</span><br><span class="line"></span><br><span class="line">        ssl_certificate      ssl/minminmsn.crt;</span><br><span class="line">        ssl_certificate_key  ssl/minminmsn.key;</span><br><span class="line">        ssl_prefer_server_ciphers   on;</span><br><span class="line">        ssl_ciphers &quot;ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4&quot;;</span><br><span class="line">        ssl_protocols               TLSv1.3 TLSv1.2 TLSv1.1 TLSv1;</span><br><span class="line">        ssl_session_cache           shared:SSL:10m;</span><br><span class="line">        ssl_session_timeout         60m;</span><br><span class="line"></span><br><span class="line">        #wordpress默认不支持ssl，nginx反向代理配置后还需要安装插件ssl-insecure-content-fixer才行</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass   http://127.0.0.1:8080;</span><br><span class="line">            proxy_http_version 1.1;</span><br><span class="line">            proxy_set_header X-Forwarded-Host $host;</span><br><span class="line">            proxy_set_header X-Forwarded-Server $host;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header X-Forwarded-Proto https;</span><br><span class="line">            proxy_set_header X-Forwarded-Port 443;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            client_max_body_size    30M;</span><br><span class="line">            client_body_buffer_size 256k;</span><br><span class="line">            proxy_connect_timeout       60s;</span><br><span class="line">            proxy_read_timeout          600s;</span><br><span class="line">            proxy_send_timeout          600s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-3-Docker部署"><a href="#6-3-Docker部署" class="headerlink" title="6.3 Docker部署"></a>6.3 Docker部署</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker可以当做一个可以开启暂停重启关闭的程序，只要数据保存到外部不丢失，使用起来非常方便快捷</span><br><span class="line">docker pull mysql:5.7</span><br><span class="line">docker pull wordpress:latest</span><br><span class="line">docker run --name mysql  -v /yourpath/db:/var/lib/mysql  -e MYSQL_ROOT_PASSWORD=your@password --restart=always   -d mysql:5.7</span><br><span class="line">docker run --name wordpress -v /yourpath/www:/var/www/html  --restart=always  --link mysql:mysql -p 8080:80 -d wordpress</span><br></pre></td></tr></table></figure>

<h3 id="七、前端设计（简洁明快）"><a href="#七、前端设计（简洁明快）" class="headerlink" title="七、前端设计（简洁明快）"></a>七、前端设计（简洁明快）</h3><h4 id="7-1-模板"><a href="#7-1-模板" class="headerlink" title="7.1 模板"></a>7.1 模板</h4><blockquote>
<p>（选择能Hold住且清新脱俗的） Sela不是您平常所见的商业主题。充满活力，大胆，干净，有大量的空间，大型图像，这个主题将在各种设备上，从桌面到移动设备，看起来很棒。 链接地址：<a target="_blank" rel="noopener" href="https://wordpress.com/theme/sela">https://wordpress.com/theme/sela</a>!</p>
</blockquote>
<h4 id="7-2-布局"><a href="#7-2-布局" class="headerlink" title="7.2 布局"></a>7.2 布局</h4><h4 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h4><blockquote>
<p><strong>三杯水</strong></p>
</blockquote>
<h4 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h4><blockquote>
<p><strong>手气不错</strong></p>
</blockquote>
<h4 id="标签云"><a href="#标签云" class="headerlink" title="标签云"></a>标签云</h4><blockquote>
<p><strong>琅琊榜</strong></p>
</blockquote>
<h4 id="万年历"><a href="#万年历" class="headerlink" title="万年历"></a>万年历</h4><blockquote>
<p><strong>三的倍数是发博日</strong></p>
</blockquote>
<h4 id="分类栏目"><a href="#分类栏目" class="headerlink" title="分类栏目"></a>分类栏目</h4><blockquote>
<p><strong>九九归一</strong></p>
</blockquote>
<h4 id="文档归档"><a href="#文档归档" class="headerlink" title="文档归档"></a>文档归档</h4><blockquote>
<p><strong>按年月归档</strong></p>
</blockquote>
<h4 id="近期文章"><a href="#近期文章" class="headerlink" title="近期文章"></a>近期文章</h4><blockquote>
<p><strong>最近五篇文章</strong></p>
</blockquote>
<h4 id="打赏"><a href="#打赏" class="headerlink" title="打赏"></a>打赏</h4><blockquote>
<p><strong>随喜赞叹</strong></p>
</blockquote>
<h4 id="版权"><a href="#版权" class="headerlink" title="版权"></a>版权</h4><blockquote>
<p><strong>支持开源</strong></p>
</blockquote>
<h3 id="八、插件选型（选简单好用的）"><a href="#八、插件选型（选简单好用的）" class="headerlink" title="八、插件选型（选简单好用的）"></a>八、插件选型（选简单好用的）</h3><h4 id="AddToAny-Share-Buttons"><a href="#AddToAny-Share-Buttons" class="headerlink" title="AddToAny Share Buttons"></a>AddToAny Share Buttons</h4><blockquote>
<p><strong>可以复杂链接分享给国内外常用的社交平台</strong></p>
</blockquote>
<h4 id="Limit-Login-Attempts-Reloaded"><a href="#Limit-Login-Attempts-Reloaded" class="headerlink" title="Limit Login Attempts Reloaded"></a>Limit Login Attempts Reloaded</h4><blockquote>
<p><strong>防止暴力破解博客账号密码</strong></p>
</blockquote>
<h4 id="Mobile-Menu"><a href="#Mobile-Menu" class="headerlink" title="Mobile Menu"></a>Mobile Menu</h4><blockquote>
<p><strong>在不同的终端都能很好的展示你的博客</strong></p>
</blockquote>
<h4 id="WP-Editor-md"><a href="#WP-Editor-md" class="headerlink" title="WP Editor.md"></a>WP Editor.md</h4><blockquote>
<p><strong>或许这是一个WordPress中最好，最完美的Markdown编辑器</strong></p>
</blockquote>
<h4 id="WP-Super-Cache"><a href="#WP-Super-Cache" class="headerlink" title="WP Super Cache"></a>WP Super Cache</h4><blockquote>
<p><strong>博客性能优化，缓存静态资源，访问加速</strong></p>
</blockquote>
<h4 id="WP-统计"><a href="#WP-统计" class="headerlink" title="WP 统计"></a>WP 统计</h4><blockquote>
<p><strong>后台统计，可对地域及点击率进行分析</strong></p>
</blockquote>
<h4 id="SSL-insecure-content-fixer"><a href="#SSL-insecure-content-fixer" class="headerlink" title="SSL-insecure-content-fixer"></a>SSL-insecure-content-fixer</h4><blockquote>
<p><strong>帮助您清理并修复 WordPress 站点的 HTTPS 不安全内容</strong></p>
</blockquote>
<h4 id="Disable-comments"><a href="#Disable-comments" class="headerlink" title="Disable comments"></a>Disable comments</h4><blockquote>
<p><strong>为了最大化的安全及ICP备案后公安网备案个人非交互站点需要禁用评论功能</strong></p>
</blockquote>
<h3 id="九、原创内容（九九归一，支持原创）"><a href="#九、原创内容（九九归一，支持原创）" class="headerlink" title="九、原创内容（九九归一，支持原创）"></a>九、原创内容（九九归一，支持原创）</h3><h4 id="佛经禅宗"><a href="#佛经禅宗" class="headerlink" title="佛经禅宗"></a>佛经禅宗</h4><blockquote>
<p><strong>博大精深有搞头</strong></p>
</blockquote>
<h4 id="哲学西学"><a href="#哲学西学" class="headerlink" title="哲学西学"></a>哲学西学</h4><blockquote>
<p><strong>自由自在无边界</strong></p>
</blockquote>
<h4 id="研发设计"><a href="#研发设计" class="headerlink" title="研发设计"></a>研发设计</h4><blockquote>
<p><strong>山不过来我过去</strong></p>
</blockquote>
<h4 id="心学理学"><a href="#心学理学" class="headerlink" title="心学理学"></a>心学理学</h4><blockquote>
<p><strong>燃烧你的小宇宙</strong></p>
</blockquote>
<h4 id="开源技术"><a href="#开源技术" class="headerlink" title="开源技术"></a>开源技术</h4><blockquote>
<p><strong>术是第一生产力</strong></p>
</blockquote>
<h4 id="数据分析"><a href="#数据分析" class="headerlink" title="数据分析"></a>数据分析</h4><blockquote>
<p><strong>数据满足好奇心</strong></p>
</blockquote>
<h4 id="杂谈心情"><a href="#杂谈心情" class="headerlink" title="杂谈心情"></a>杂谈心情</h4><blockquote>
<p><strong>亦正亦邪冰与火</strong></p>
</blockquote>
<h4 id="读书学习"><a href="#读书学习" class="headerlink" title="读书学习"></a>读书学习</h4><blockquote>
<p><strong>终身跨学科提问</strong></p>
</blockquote>
<h4 id="运维之道"><a href="#运维之道" class="headerlink" title="运维之道"></a>运维之道</h4><blockquote>
<p><strong>运筹于帷幄之中</strong></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/11/21/2018/11/2018-11-21-redis%E9%9B%86%E7%BE%A4%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/21/2018/11/2018-11-21-redis%E9%9B%86%E7%BE%A4%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/index/" class="post-title-link" itemprop="url">Redis集群性能问题深度分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-21 08:00:00" itemprop="dateCreated datePublished" datetime="2018-11-21T08:00:00+08:00">2018-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>Redis开发与运维 <a target="_blank" rel="noopener" href="https://redis.io/">https://redis.io/</a> <a target="_blank" rel="noopener" href="http://www.redis.cn/">http://www.redis.cn/</a> <a target="_blank" rel="noopener" href="https://github.com/antirez/redis">https://github.com/antirez/redis</a> <a target="_blank" rel="noopener" href="https://github.com/sohutv/cachecloud">https://github.com/sohutv/cachecloud</a></p>
</blockquote>
<h3 id="源起"><a href="#源起" class="headerlink" title="源起"></a>源起</h3><h4 id="优化之路永无止境，在此之前一做过一些架构优化汇总如下："><a href="#优化之路永无止境，在此之前一做过一些架构优化汇总如下：" class="headerlink" title="优化之路永无止境，在此之前一做过一些架构优化汇总如下："></a>优化之路永无止境，在此之前一做过一些架构优化汇总如下：</h4><ul>
<li>1，Redis集群3.0.7升级到3.2.9解决读从节点KEY过期不删除问题，集群有几千万KEY原来经核查3.0.7版本只有主上保存过期时间，所以需要主触发才能删除过期的KEY，默认有主动删除与惰性删除同时工作，但是KEY比较多，写的比删除的KEY，另外读从的话不能触发主动删KEY所以会有KEY没更新问题，升级3.2.X之后解决。</li>
<li>2，发现持久化操作时容易导致超时，后来从节点的持久化关闭，效果良好；后续计划持久化非持久化业务分开，过期时间短的与过期时间长的分开。</li>
<li>2，集群扩容，升级到3.2.9版本后为了均摊QPS扩容了几个节点，后续发现有2个节点内核版本比其他的高但是性能反而表现比其他差，后替换了同版本的内核。</li>
<li>3，Bigkeys扫描发现有几个hashkey元素过大超过几千万，单个KEY占用内存几个G后联系开发解决。</li>
<li>4，建立了CacheCloud监控系统，便于分析观察问题，另外Zabbix也使用Redis模版出现大故障时会报错。</li>
<li>5，后续优化方向转为客户端使用规划的问题，主要是解决各个量大的命令平均用时超过10微秒的问题。</li>
<li>6，每个Redis集群版本升级在功能与性能上都有比较大的提升，需要持久化功能的集群后续可以使用4.0.2版本，另外如果使用虚拟化不建议使用XEN、Hyper-V等，最好使用vSphere压力测试vSphere在各方面表现良好。</li>
</ul>
<h3 id="一，发现问题"><a href="#一，发现问题" class="headerlink" title="一，发现问题"></a>一，发现问题</h3><h4 id="1，慢查询"><a href="#1，慢查询" class="headerlink" title="1，慢查询"></a>1，慢查询</h4><p>slowlog get n 默认保留128个日志执行超过10毫秒的记录，可以根据实际情况修改</p>
<h4 id="2，应用报错"><a href="#2，应用报错" class="headerlink" title="2，应用报错"></a>2，应用报错</h4><p>主要是应用邮件报超时</p>
<h3 id="二，分析问题"><a href="#二，分析问题" class="headerlink" title="二，分析问题"></a>二，分析问题</h3><h4 id="1，内在原因"><a href="#1，内在原因" class="headerlink" title="1，内在原因"></a>1，内在原因</h4><p>1）API或数据结构使用不合理 2）CPU饱和的问题 3）持久化相关的阻塞</p>
<h4 id="2，外在原因"><a href="#2，外在原因" class="headerlink" title="2，外在原因"></a>2，外在原因</h4><p>1）CPU竞争 2）内存交换 3）网络问题</p>
<h3 id="三，解决问题之内在原因"><a href="#三，解决问题之内在原因" class="headerlink" title="三，解决问题之内在原因"></a>三，解决问题之内在原因</h3><h4 id="1，API或数据结构使用不合理"><a href="#1，API或数据结构使用不合理" class="headerlink" title="1，API或数据结构使用不合理"></a>1，API或数据结构使用不合理</h4><p>1）发现慢查询 slowlog get n 慢查询日志有两个参数： slowlog-log-slower-than: 单位微妙，指定redis执行命令的最大时间，超过将记录到慢查询日志中, 不接受负值，如果设置为0每条命令都要记录到慢查询日志中,默认10微妙。 slowlog-max-len: 设置慢查询日志长度，如果慢查询日志已经到最大值，如果有新命令需要记录，就将最老那条记录删除，默认保存128，可以在线修改，CONFIG REWRITE保存。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">redis-cli </span><br><span class="line">127.0.0.1:6379&gt; config get slowlog-max-len</span><br><span class="line">1) &quot;slowlog-max-len&quot;</span><br><span class="line">2) &quot;128&quot;</span><br><span class="line">127.0.0.1:6379&gt; config set slowlog-max-len 1000</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; config rewrite</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>2）发现大key redis-cli –bigkeys</p>
<h4 id="2，CPU饱和"><a href="#2，CPU饱和" class="headerlink" title="2，CPU饱和"></a>2，CPU饱和</h4><p>1）统计Redis状态 500QPS左右，单个命令使用时间越少支持的QPS并发越大，比如平均1毫妙的支持1000QPS，平均100微妙的支持10000QPS。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --stat</span><br><span class="line">------- data ------ --------------------- load -------------------- - child -</span><br><span class="line">keys       mem      clients blocked requests            connections          </span><br><span class="line">5088981    6.51G    514     0       578132987 (+0)      384742      </span><br><span class="line">5088997    6.51G    514     0       578133573 (+586)    384742      </span><br><span class="line">5089018    6.51G    514     0       578134096 (+523)    384742      </span><br><span class="line">5089005    6.51G    515     0       578134720 (+624)    384743      </span><br><span class="line">5089048    6.51G    515     0       578135195 (+475)    384743      </span><br><span class="line">5089093    6.51G    513     0       578135829 (+634)    384743      </span><br><span class="line">5089117    6.51G    513     0       578136455 (+626)    384743      </span><br><span class="line">5089081    6.51G    512     0       578136850 (+395)    384743      </span><br><span class="line">5089121    6.51G    512     0       578137226 (+376)    384743</span><br></pre></td></tr></table></figure>

<p>2）命令统计 时间单位为微秒 单个命令10微妙以内，尽量避免高算法复杂的命令 setex平均26 del 平均43 hmset平均229 hmget平均12 以上特别是hmset要优化，另外hgetall命令不建议使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">redis-cli  info commandstats</span><br><span class="line"># Commandstats</span><br><span class="line">cmdstat_get:calls=2814596805,usec=12130889716,usec_per_call=4.31</span><br><span class="line">cmdstat_set:calls=25674338,usec=234328226,usec_per_call=9.13</span><br><span class="line">cmdstat_setex:calls=910333006,usec=20767349072,usec_per_call=22.81</span><br><span class="line">cmdstat_del:calls=780287520,usec=33983500560,usec_per_call=43.55</span><br><span class="line">cmdstat_lpush:calls=1,usec=34,usec_per_call=34.00</span><br><span class="line">cmdstat_hset:calls=145663119,usec=499130659,usec_per_call=3.43</span><br><span class="line">cmdstat_hget:calls=2841141555,usec=13763160250,usec_per_call=4.84</span><br><span class="line">cmdstat_hmset:calls=1452658,usec=333516295,usec_per_call=229.59</span><br><span class="line">cmdstat_hmget:calls=970024532,usec=11909915205,usec_per_call=12.28</span><br><span class="line">cmdstat_hdel:calls=581004,usec=3925702,usec_per_call=6.76</span><br><span class="line">cmdstat_hgetall:calls=28985688,usec=555451600,usec_per_call=19.16</span><br><span class="line">cmdstat_hexists:calls=262547,usec=2867627,usec_per_call=10.92</span><br><span class="line">cmdstat_select:calls=1,usec=1,usec_per_call=1.00</span><br><span class="line">cmdstat_expire:calls=72409493,usec=101731304,usec_per_call=1.40</span><br><span class="line">cmdstat_auth:calls=1544789,usec=2890530,usec_per_call=1.87</span><br><span class="line">cmdstat_ping:calls=4977672,usec=2672430,usec_per_call=0.54</span><br><span class="line">cmdstat_echo:calls=697770,usec=380462,usec_per_call=0.55</span><br><span class="line">cmdstat_info:calls=32700948,usec=7243085428,usec_per_call=221.49</span><br><span class="line">cmdstat_config:calls=2176619,usec=31168795,usec_per_call=14.32</span><br><span class="line">cmdstat_subscribe:calls=1717,usec=7283,usec_per_call=4.24</span><br><span class="line">cmdstat_unsubscribe:calls=5506966,usec=21985846,usec_per_call=3.99</span><br><span class="line">cmdstat_cluster:calls=696482,usec=210160284,usec_per_call=301.75</span><br><span class="line">cmdstat_readonly:calls=696449,usec=437883,usec_per_call=0.63</span><br><span class="line">cmdstat_client:calls=697770,usec=1869891,usec_per_call=2.68</span><br><span class="line">cmdstat_slowlog:calls=2,usec=214,usec_per_call=107.00</span><br><span class="line">cmdstat_command:calls=2,usec=11824,usec_per_call=5912.00</span><br></pre></td></tr></table></figure>

<p>3）持久化阻塞 由于从已经关闭持久化，主要分析主的，主上只开启了RDB且10分钟一次，没有开启AOF刷盘阻塞（故不用考虑） fork阻塞：latest_fork_usec该指标不能超过1秒，这里是275毫秒</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">redis-cli  info stats</span><br><span class="line"># Stats</span><br><span class="line">total_connections_received:384861</span><br><span class="line">total_commands_processed:578276973</span><br><span class="line">instantaneous_ops_per_sec:509</span><br><span class="line">total_net_input_bytes:530863235402</span><br><span class="line">total_net_output_bytes:1584445816901</span><br><span class="line">instantaneous_input_kbps:668.38</span><br><span class="line">instantaneous_output_kbps:838.84</span><br><span class="line">rejected_connections:0</span><br><span class="line">sync_full:1</span><br><span class="line">sync_partial_ok:0</span><br><span class="line">sync_partial_err:0</span><br><span class="line">expired_keys:164683638</span><br><span class="line">evicted_keys:0</span><br><span class="line">keyspace_hits:193101765</span><br><span class="line">keyspace_misses:12414607</span><br><span class="line">pubsub_channels:0</span><br><span class="line">pubsub_patterns:0</span><br><span class="line">latest_fork_usec:275078   275毫秒</span><br><span class="line">migrate_cached_sockets:0</span><br></pre></td></tr></table></figure>

<p>另外HugePage写操作阻塞，这个内核已经关闭HugePages，方法如下 echo never &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</p>
<h3 id="四，解决问题之外在原因"><a href="#四，解决问题之外在原因" class="headerlink" title="四，解决问题之外在原因"></a>四，解决问题之外在原因</h3><h4 id="1，CPU竞争"><a href="#1，CPU竞争" class="headerlink" title="1，CPU竞争"></a>1，CPU竞争</h4><p>Redis是典型的CPU密集型应用，同一台服务器不建议部署其他服务，如果需要不是多个Redis实例也建议绑定CPU。</p>
<h4 id="2，内存交换"><a href="#2，内存交换" class="headerlink" title="2，内存交换"></a>2，内存交换</h4><p>1）根据进程号cat &#x2F;proc&#x2F;5413&#x2F;smaps |grep Swap可以查看内存交换，为了避免内存交换，首先服务器最好富余1&#x2F;3-1&#x2F;2内存，fork时会生成一个进程占用当前实例大小的内存，等于说内存加倍。</p>
<p>2）设置最大可用内存及触发内存启动lru算法（Redis版本越高该算法效率越高，因为Redis一直在进化）以防万一，方法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; CONFIG GET maxmemory</span><br><span class="line">1) &quot;maxmemory&quot;</span><br><span class="line">2) &quot;21474836480&quot;</span><br><span class="line">127.0.0.1:6379&gt; CONFIG GET maxmemory-policy</span><br><span class="line">1) &quot;maxmemory-policy&quot;</span><br><span class="line">2) &quot;allkeys-lru&quot;</span><br></pre></td></tr></table></figure>

<p>3)可以降低系统使用swap的优先级，由于前面对内存做了优化这里没有对swap调优，毕竟这些都是不得已手段，需要从架构与使用上修改效果才好。</p>
<h4 id="3，网络问题"><a href="#3，网络问题" class="headerlink" title="3，网络问题"></a>3，网络问题</h4><p>1）连接拒绝 主要是网络闪断接Redis连接数超过默认的10000，可以通过监控与修改默认值规避。目前连接不多，如果连接过多服务端的timeout可以修改一个具体的值，默认是0代表永远不主动断开连接。 另外连接溢出，这个服务端与客户端都需要排查，主要是看进程限制与backlog队列是否溢出。 2）网络延迟 3）网卡软中断</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/11/21/2018/11/2018-11-21-yum%E5%AE%89%E8%A3%85rabbitmq3-6-11%E4%B8%8Eerlange20%E9%85%8D%E7%BD%AE%E5%8F%8A%E4%BC%98%E5%8C%96/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/21/2018/11/2018-11-21-yum%E5%AE%89%E8%A3%85rabbitmq3-6-11%E4%B8%8Eerlange20%E9%85%8D%E7%BD%AE%E5%8F%8A%E4%BC%98%E5%8C%96/index/" class="post-title-link" itemprop="url">Yum安装RabbitMQ3.6.11与Erlange20配置及优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-21 08:00:00" itemprop="dateCreated datePublished" datetime="2018-11-21T08:00:00+08:00">2018-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<h3 id="RabbitMQ简介"><a href="#RabbitMQ简介" class="headerlink" title="RabbitMQ简介"></a>RabbitMQ简介</h3><p>AMQP，即Advanced Message Queuing Protocol，高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。消息中间件主要用于组件之间的解耦，消息的发送者无需知道消息使用者的存在，反之亦然。 AMQP的主要特征是面向消息、队列、路由（包括点对点和发布&#x2F;订阅）、可靠性、安全。 RabbitMQ是一个开源的AMQP实现，服务器端用Erlang语言编写，支持多种客户端，如：Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP等，支持AJAX。用于在分布式系统中存储转发消息，在易用性、扩展性、高可用性等方面表现不俗。</p>
</blockquote>
<h3 id="官网的配置"><a href="#官网的配置" class="headerlink" title="官网的配置"></a>官网的配置</h3><blockquote>
<p><a target="_blank" rel="noopener" href="http://www.rabbitmq.com/production-checklist.html">http://www.rabbitmq.com/production-checklist.html</a> <a target="_blank" rel="noopener" href="http://www.rabbitmq.com/configure.html">http://www.rabbitmq.com/configure.html</a> <a target="_blank" rel="noopener" href="http://www.rabbitmq.com/memory.html">http://www.rabbitmq.com/memory.html</a> <a target="_blank" rel="noopener" href="http://www.rabbitmq.com/production-checklist.html#resource-limits-ram">http://www.rabbitmq.com/production-checklist.html#resource-limits-ram</a></p>
</blockquote>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><blockquote>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/crazylqy/p/6567253.html">http://www.cnblogs.com/crazylqy/p/6567253.html</a> <a target="_blank" rel="noopener" href="http://wangqingpei557.blog.51cto.com/1009349/1881540">http://wangqingpei557.blog.51cto.com/1009349/1881540</a></p>
</blockquote>
<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><blockquote>
<p>ConnectionFactory、Connection、Channel ConnectionFactory、Connection、Channel都是RabbitMQ对外提供的API中最基本的对象。Connection是RabbitMQ的socket链接，它封装了socket协议相关部分逻辑。ConnectionFactory为Connection的制造工厂。 Channel是我们与RabbitMQ打交道的最重要的一个接口，我们大部分的业务操作是在Channel这个接口中完成的，包括定义Queue、定义Exchange、绑定Queue与Exchange、发布消息等。 Queue Queue（队列）是RabbitMQ的内部对象，用于存储消息。 RabbitMQ中的消息都只能存储在Queue中，生产者生产消息并最终投递到Queue中，消费者可以从Queue中获取消息并消费。 多个消费者可以订阅同一个Queue，这时Queue中的消息会被平均分摊给多个消费者进行处理，而不是每个消费者都收到所有的消息并处理。 Message acknowledgment 在实际应用中，可能会发生消费者收到Queue中的消息，但没有处理完成就宕机（或出现其他意外）的情况，这种情况下就可能会导致消息丢失。为了避免这种情况发生，我们可以要求消费者在消费完消息后发送一个回执给RabbitMQ，RabbitMQ收到消息回执（Message acknowledgment）后才将该消息从Queue中移除；如果RabbitMQ没有收到回执并检测到消费者的RabbitMQ连接断开，则RabbitMQ会将该消息发送给其他消费者（如果存在多个消费者）进行处理。这里不存在timeout概念，一个消费者处理消息时间再长也不会导致该消息被发送给其他消费者，除非它的RabbitMQ连接断开。 这里会产生另外一个问题，如果我们的开发人员在处理完业务逻辑后，忘记发送回执给RabbitMQ，这将会导致严重的bug——Queue中堆积的消息会越来越多；消费者重启后会重复消费这些消息并重复执行业务逻辑… 另外pub message是没有ack的。 Message durability 如果我们希望即使在RabbitMQ服务重启的情况下，也不会丢失消息，我们可以将Queue与Message都设置为可持久化的（durable），这样可以保证绝大部分情况下我们的RabbitMQ消息不会丢失。但依然解决不了小概率丢失事件的发生（比如RabbitMQ服务器已经接收到生产者的消息，但还没来得及持久化该消息时RabbitMQ服务器就断电了），如果我们需要对这种小概率事件也要管理起来，那么我们要用到事务。 Prefetch count 前面我们讲到如果有多个消费者同时订阅同一个Queue中的消息，Queue中的消息会被平摊给多个消费者。这时如果每个消息的处理时间不同，就有可能会导致某些消费者一直在忙，而另外一些消费者很快就处理完手头工作并一直空闲的情况。我们可以通过设置prefetchCount来限制Queue每次发送给每个消费者的消息数，比如我们设置prefetchCount&#x3D;1，则Queue每次给每个消费者发送一条消息；消费者处理完这条消息后Queue会再给该消费者发送一条消息。 Exchange 在上一节我们看到生产者将消息投递到Queue中，实际上这在RabbitMQ中这种事情永远都不会发生。实际的情况是，生产者将消息发送到Exchange，由Exchange将消息路由到一个或多个Queue中（或者丢弃）。 Exchange是按照什么逻辑将消息路由到Queue的？这个将在Binding一节介绍。 RabbitMQ中的Exchange有四种类型，不同的类型有着不同的路由策略，这将在Exchange Types一节介绍。 Routing key 生产者在将消息发送给Exchange的时候，一般会指定一个routing key，来指定这个消息的路由规则，而这个routing key需要与Exchange Type及binding key联合使用才能最终生效。 在Exchange Type与binding key固定的情况下（在正常使用时一般这些内容都是固定配置好的），我们的生产者就可以在发送消息给Exchange时，通过指定routing key来决定消息流向哪里。 RabbitMQ为routing key设定的长度限制为255 bytes。 Binding RabbitMQ中通过Binding将Exchange与Queue关联起来，这样RabbitMQ就知道如何正确地将消息路由到指定的Queue了。</p>
</blockquote>
<h3 id="部署配置"><a href="#部署配置" class="headerlink" title="部署配置"></a>部署配置</h3><p>1、安装erlang 下载rpm仓库：wget <a target="_blank" rel="noopener" href="http://packages.erlang-solutions.com/erlang-solutions-1.0-1.noarch.rpm">http://packages.erlang-solutions.com/erlang-solutions-1.0-1.noarch.rpm</a> 安装rpm仓库 rpm -Uvh erlang-solutions-1.0-1.noarch.rpm 安装erlang yum -y install erlang</p>
<p>2、安装rabbitmq wget <a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-server/releases/download/rabbitmq/_v3/_6/_11/rabbitmq-server-3.6.11-1.el6.noarch.rpm">https://github.com/rabbitmq/rabbitmq-server/releases/download/rabbitmq\_v3\_6\_11/rabbitmq-server-3.6.11-1.el6.noarch.rpm</a> rpm –import <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/rabbitmq-release-signing-key.asc">https://www.rabbitmq.com/rabbitmq-release-signing-key.asc</a> yum install rabbitmq-server-3.6.11-1.noarch.rpm yum install rabbitmq-server-3.6.11-1.el6.noarch.rpm Installed: rabbitmq-server.noarch 0:3.6.11-1.el6 Dependency Installed: socat.x86_64 0:1.7.2.3-1.el6</p>
<p>3、启动 mkdir -p &#x2F;data&#x2F;rabbitmq&#x2F;data mkdir -p &#x2F;data&#x2F;rabbitmq&#x2F;log chown rabbitmq:rabbitmq &#x2F;data&#x2F;rabbitmq&#x2F; -R &#x2F;etc&#x2F;init.d&#x2F;rabbitmq-server restart</p>
<p>4、添加帐号 rabbitmqctl add_user rabbitmq76 RMQXXXXXXXXX rabbitmqctl set_user_tags rabbitmq76 administrator rabbitmqctl set_permissions -p &#x2F; rabbitmq76 “.<em>“ “.</em>“ “.*“</p>
<p>5、加入集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@rabbitmq76 etc]# cat /etc/hosts</span><br><span class="line">127.0.0.1  localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1        localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.188.76 rabbitmq76</span><br><span class="line">192.168.188.77 rabbitmq77</span><br><span class="line">192.168.188.78 rabbitmq78</span><br><span class="line">192.168.188.79 rabbitmq79</span><br><span class="line">192.168.188.80 rabbitmq80</span><br><span class="line"></span><br><span class="line">scp -P10001 .erlang.cookie 192.168.188.77:$PWD</span><br><span class="line">scp -P10001 .erlang.cookie 192.168.188.78:$PWD</span><br><span class="line">scp -P10001 .erlang.cookie 192.168.188.79:$PWD</span><br><span class="line">scp -P10001 .erlang.cookie 192.168.188.80:$PWD</span><br><span class="line"></span><br><span class="line">[root@rabbitmq77 ~]# rabbitmqctl stop_app</span><br><span class="line">Stopping rabbit application on node rabbit@rabbitmq77</span><br><span class="line">[root@rabbitmq77 ~]#  rabbitmqctl join_cluster rabbit@rabbitmq76</span><br><span class="line">Clustering node rabbit@rabbitmq77 with rabbit@rabbitmq76</span><br><span class="line">[root@rabbitmq77 ~]# rabbitmqctl start_app</span><br><span class="line">Starting node rabbit@rabbitmq77</span><br><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br><span class="line">[root@rabbitmq76 etc]# rabbitmqctl cluster_status</span><br><span class="line">Cluster status of node rabbit@rabbitmq76</span><br><span class="line">[&#123;nodes,[&#123;disc,[rabbit@rabbitmq76,rabbit@rabbitmq77,rabbit@rabbitmq78,</span><br><span class="line">rabbit@rabbitmq79,rabbit@rabbitmq80]&#125;]&#125;,</span><br><span class="line">&#123;running_nodes,[rabbit@rabbitmq80,rabbit@rabbitmq79,rabbit@rabbitmq78,</span><br><span class="line">rabbit@rabbitmq77,rabbit@rabbitmq76]&#125;,</span><br><span class="line">&#123;cluster_name,&lt;&lt;&quot;rabbit@rabbitmq76&quot;&gt;&gt;&#125;,</span><br><span class="line">&#123;partitions,[]&#125;,</span><br><span class="line">&#123;alarms,[&#123;rabbit@rabbitmq80,[]&#125;,</span><br><span class="line">&#123;rabbit@rabbitmq79,[]&#125;,</span><br><span class="line">&#123;rabbit@rabbitmq78,[]&#125;,</span><br><span class="line">&#123;rabbit@rabbitmq77,[]&#125;,</span><br><span class="line">&#123;rabbit@rabbitmq76,[]&#125;]&#125;]</span><br></pre></td></tr></table></figure>

<p>6、设置镜像队列策略 可以参考 <a target="_blank" rel="noopener" href="http://blog.csdn.net/zheng911209/article/details/49949303">http://blog.csdn.net/zheng911209/article/details/49949303</a> 在任意一个节点上执行下面的命令 rabbitmqctl set_policy ha-all “^” ‘{“ha-mode”:”all”}’ 剩下的可以在web上操作</p>
<p>1），首先创建vhost，例如testapp 2），其次创建user，例如testapp,tags设置None，vhosts选择testapp ，设置好密码 3），配置police</p>
<p>选择要应用策略的vhost name:起个有意义的名称，比如我们写的ha-all(表示在所有节点建立镜像) pattern:为正则表达式，是要匹配的exchange和queue的名称，比要匹配所有exchange或者queue的话，可以直接写 ‘^’，表示任意名称开头的，如果要指定以ha-开发的exchange和queue的话 可以使用 ‘^ha-‘ applyto:是表示策略应用的范围，比如 exchange或者queue还是两者都应用。 priority:优先级，是只在exchange转发时优先级高的会优先转发。 definition: 下面有提示，点击就可以definition的定义表单上去，值的话，点击下面定义后面跟的？号就可以看到可选值。通常会加两项定义： ha-mode:all　　在集群所有节点中创建镜像exchange或者queue ha-sync-mode:automatic 自动同步到镜像节点 4），创建exchange，例如testapp-exchange 5），配置queues，例如testapp-queues 6），绑定exchange与queues，例如testapp-exchange和testapp-queues.key绑定</p>
<p>7、优化配置等 官网的配置 <a target="_blank" rel="noopener" href="http://www.rabbitmq.com/production-checklist.html">http://www.rabbitmq.com/production-checklist.html</a> <a target="_blank" rel="noopener" href="http://www.rabbitmq.com/configure.html">http://www.rabbitmq.com/configure.html</a> <a target="_blank" rel="noopener" href="http://www.rabbitmq.com/memory.html">http://www.rabbitmq.com/memory.html</a> <a target="_blank" rel="noopener" href="http://www.rabbitmq.com/production-checklist.html#resource-limits-ram">http://www.rabbitmq.com/production-checklist.html#resource-limits-ram</a></p>
<p>线上优化后配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@rabbitmq76 rabbitmq]# cat rabbitmq.conf</span><br><span class="line">[</span><br><span class="line">&#123;rabbit,</span><br><span class="line">[</span><br><span class="line">&#123;loopback_users, []&#125;,</span><br><span class="line">&#123;vm_memory_high_watermark, 0.40&#125;,                      #最大使用内存40%，erlang开始GC</span><br><span class="line">&#123;vm_memory_high_watermark_paging_ratio, 0.8&#125;,  #32G内存，32*0.8*0.2时开始持久化磁盘</span><br><span class="line">&#123;disk_free_limit, &quot;10GB&quot;&#125;,                          #磁盘使用量剩余10G时，不收发消息</span><br><span class="line">&#123;hipe_compile, true&#125;,                                 #开启hipe，提高erlang性能</span><br><span class="line">&#123;collect_statistics_interval, 10000&#125;,           #统计刷新时间默认5秒，改成10秒</span><br><span class="line">&#123;cluster_partition_handling, autoheal&#125;        #网络优化参数，不稳定时用这个选项</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">].</span><br><span class="line"></span><br><span class="line">[root@rabbitmq76 rabbitmq]# cat rabbitmq-env.conf</span><br><span class="line">RABBITMQ_NODENAME=rabbit@rabbitmq76             #节点名字，全局唯一</span><br><span class="line">RABBITMQ_MNESIA_BASE=/data/rabbitmq/data        #消息落地存放位置</span><br><span class="line">RABBITMQ_LOG_BASE=/data/rabbitmq/log            #日志位置</span><br><span class="line">RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS=&quot;+A 128&quot;    #默认65，server线程</span><br><span class="line">另外系统参数需要留有swap空间，及打开文件数rabbitmq启动进程至少需要5万，yum安装时rabbitmq启动，源码安装时root启动</span><br><span class="line"></span><br><span class="line">[root@rabbitmq76 rabbitmq]# cat /etc/security/limits.conf</span><br><span class="line">* soft  nofile 65536</span><br><span class="line">* hard  nofile 131072</span><br><span class="line">* soft  nproc 10240</span><br><span class="line">* hard  nproc 20480</span><br></pre></td></tr></table></figure>

<h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><h4 id="内存控制："><a href="#内存控制：" class="headerlink" title="内存控制："></a>内存控制：</h4><p>vm_memory_high_watermark 该值为内存阈值，默认为0.4。意思为物理内存的40%。40%的内存并不是内存的最大的限制，它是一个发布的节制，当达到40%时Erlang会做GC。最坏的情况是使用 内存80%。如果把该值配置为0，将关闭所有的publishing 。 rabbitmqctl set_vm_memory_high_watermark 0 Paging 内存阈值，该值为默认为0.5，该值为vm_memory_high_watermark的20%时，将把内存数据写到磁盘。 如机器内存16G，当RABBITMQ占用内存1.28G（16_0.4_0.2）时把内存数据放到磁盘。</p>
<h3 id="硬盘控制："><a href="#硬盘控制：" class="headerlink" title="硬盘控制："></a>硬盘控制：</h3><p>当RabbitMQ的磁盘空闲空间小于50M（默认），生产者将被BLOCK, 如果采用集群模式，磁盘节点空闲空间小于50M将导致其他节点的生产者都被block 可以通过disk_free_limit来对进行配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Memory</span><br><span class="line">By default, RabbitMQ will not accept any new messages when it detects that it&#x27;s using more than 40% of the available memory (as reported by the OS):</span><br><span class="line">&#123;vm_memory_high_watermark, 0.4&#125;. This is a safe default and care should be taken when modifying this value, even when the host is a dedicated RabbitMQ node.</span><br><span class="line">The OS and file system use system memory to speed up operations for all system processes. Failing to leave enough free system memory for this purpose will have an</span><br><span class="line">adverse effect on system performance due to OS swapping, and can even result in RabbitMQ process termination.</span><br><span class="line">A few recommendations when adjusting the default  vm_memory_high_watermark:</span><br><span class="line">Nodes hosting RabbitMQ should have at least 128MB of memory available at all times.</span><br><span class="line">The recommended vm_memory_high_watermark range is  0.40 to 0.66</span><br><span class="line">Values above 0.7 are not recommended. The OS and file system must be left with at least 30% of the memory, otherwise performance may degrade severely due to paging.</span><br><span class="line">As with every tuning, benchmarking and measuring are required to find the best setting for your environment and workload.</span><br><span class="line"></span><br><span class="line">Disk Space</span><br><span class="line">The current 50MB disk_free_limit default works very well for development and tutorials. Production deployments require a much greater safety margin. Insufficient disk</span><br><span class="line">space will lead to node failures and may result in data loss as all disk writes will fail.</span><br><span class="line">Why is the default 50MB then? Development environments sometimes use really small partitions to host  /var/lib, for example, which means nodes go into resource alarm</span><br><span class="line">state right after booting. The very low default ensures that RabbitMQ works out of the box for everyone. As for production deployments, we recommend the following:</span><br><span class="line">&#123;disk_free_limit, &#123;mem_relative, 1.0&#125;&#125; is the minimum recommended value and it translates to the total amount of memory available. For example, on a host dedicated to</span><br><span class="line">RabbitMQ with 4GB of system memory, if available disk space drops below 4GB, all publishers will be blocked and no new messages will be accepted. Queues will need to</span><br><span class="line">be drained, normally by consumers, before publishing will be allowed to resume.</span><br><span class="line">&#123;disk_free_limit, &#123;mem_relative, 1.5&#125;&#125; is a safer production value. On a RabbitMQ node with 4GB of memory, if available disk space drops below 6GB, all new messages</span><br><span class="line">will be blocked until the disk alarm clears. If RabbitMQ needs to flush to disk 4GB worth of data, as can sometimes be the case during shutdown, there will be</span><br><span class="line">sufficient disk space available for RabbitMQ to start again. In this specific example, RabbitMQ will start and immediately block all publishers since 2GB is well under</span><br><span class="line">the required 6GB.</span><br><span class="line">&#123;disk_free_limit, &#123;mem_relative, 2.0&#125;&#125; is the most conservative production value, we cannot think of any reason to use anything higher.If you want full confidence in</span><br><span class="line">RabbitMQ having all the disk space that it needs, at all times, this is the value to use.</span><br><span class="line"></span><br><span class="line">Open File Handles Limit</span><br><span class="line">Operating systems limit maximum number of concurrently open file handles, which includes network sockets. Make sure that you have limits set high enough to allow for</span><br><span class="line">expected number of concurrent connections and queues.</span><br><span class="line">Make sure your environment allows for at least 50K open file descriptors for effective RabbitMQ user, including in development environments.</span><br><span class="line">As a rule of thumb, multiple the 95th percentile number of concurrent connections by 2 and add total number of queues to calculate recommended open file handle limit.</span><br><span class="line">Values as high as 500K are not inadequate and won&#x27;t consume a lot of hardware resources, and therefore are recommended for production setups. See Networking guide for</span><br><span class="line">more information.</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/11/18/2018/11/2018-11-18-%E4%BD%A0%E6%B2%A1%E6%9C%89%E7%90%86%E7%94%B1%E4%B8%8D%E7%9B%B8%E4%BF%A1%E8%87%AA%E5%B7%B1/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/18/2018/11/2018-11-18-%E4%BD%A0%E6%B2%A1%E6%9C%89%E7%90%86%E7%94%B1%E4%B8%8D%E7%9B%B8%E4%BF%A1%E8%87%AA%E5%B7%B1/index/" class="post-title-link" itemprop="url">你没有理由不相信自己</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-18 08:00:00" itemprop="dateCreated datePublished" datetime="2018-11-18T08:00:00+08:00">2018-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mind/" itemprop="url" rel="index"><span itemprop="name">mind</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>纵观儒释道心，没有哪一个不是强调追随内心、反诸求己的，很多人都已经证明了向外求最终都所获甚少或者连方向都错了，说到底就是要有强大的自信力。遇到领导腿不软，遇到大神心不慌，把他们当哥们，平等的对待一切，其实他们本来就和你一样的，你叫声领导与大神是在夸奖他们呢，他们应该赞美你才对，如果他们悟到了。</p>
</blockquote>
<ul>
<li><pre><code>  有不少人包括我认为要是怎样，如果怎样就好了，事实是过去不可念，未来不可思，这样想只是浪费时间而已。比如在家里你就应该是孩子的榜样，哪怕你混得再差在孩子面前你就是老师，得拿出你的担当，告知孩子一流的人生是怎样的，虽然你不能实现但不代表他不行。
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line">- ```</span><br><span class="line">    虽然我偶尔遇到一些偏执狂，总以为自己是对的世界是错的，表面上看我是讨厌的，其实我是佩服的。因为他至少行走的是正道，在没有证明自己是错的前为啥不坚持一下呢。就算证明自己错了，那又有什么关系，改过就是了。</span><br></pre></td></tr></table></figure>
  
</code></pre>
</li>
<li><pre><code>  有一条现成的路可走，这是阳明祖师首先提出的，简单讲就是：志存高远，勤学苦练，知错就改，自渡渡他，当然最后一条要求比较高首先要悟者才能自渡，其次要有大热心肠才能渡他。
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line">- ```</span><br><span class="line">    这条路至少对大部分人都是适合的，是一条渐修之道，需要持之以恒。当然有了渐修也有顿悟，顿悟传说中也有不少人证明是对的，但是难度系数太大，又需要上根机缘巧合等必要因素所以就不强调了。</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/11/18/2018/11/2018-11-18-%E7%88%86%E8%A3%82%EF%BC%9A%E6%9C%AA%E6%9D%A5%E7%A4%BE%E4%BC%9A%E7%9A%849%E5%A4%A7%E7%94%9F%E5%AD%98%E5%8E%9F%E5%88%99/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/18/2018/11/2018-11-18-%E7%88%86%E8%A3%82%EF%BC%9A%E6%9C%AA%E6%9D%A5%E7%A4%BE%E4%BC%9A%E7%9A%849%E5%A4%A7%E7%94%9F%E5%AD%98%E5%8E%9F%E5%88%99/index/" class="post-title-link" itemprop="url">爆裂：未来社会的9大生存原则</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-18 08:00:00" itemprop="dateCreated datePublished" datetime="2018-11-18T08:00:00+08:00">2018-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/note/" itemprop="url" rel="index"><span itemprop="name">note</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<h3 id="伊藤穰一-杰夫·豪"><a href="#伊藤穰一-杰夫·豪" class="headerlink" title="伊藤穰一 杰夫·豪"></a>伊藤穰一 杰夫·豪</h3><h4 id="未来社会的三个定义条件"><a href="#未来社会的三个定义条件" class="headerlink" title="未来社会的三个定义条件"></a>未来社会的三个定义条件</h4><ul>
<li><strong>不对称性</strong></li>
<li><strong>复杂性</strong></li>
<li><strong>不确定性</strong> <a target="_blank" rel="noopener" href="https://i.loli.net/2019/01/25/5c4ac72821790.jpg"><img src="/images/5c4ac72821790.jpg"></a></li>
</ul>
</blockquote>
<h3 id="涌现优于权威（Emer-gence-over-Authority）"><a href="#涌现优于权威（Emer-gence-over-Authority）" class="headerlink" title="涌现优于权威（Emer-gence over Authority）"></a>涌现优于权威（Emer-gence over Authority）</h3><ul>
<li>新的事物比过去的权威更重要</li>
<li>接受新事物</li>
</ul>
<h3 id="拉力优于推力（Pull-over-Push）"><a href="#拉力优于推力（Pull-over-Push）" class="headerlink" title="拉力优于推力（Pull over Push）"></a>拉力优于推力（Pull over Push）</h3><ul>
<li>自己有需求而主动获取</li>
<li>不要被动接受</li>
</ul>
<h3 id="指南针优于地图（Compasses-over-Maps）"><a href="#指南针优于地图（Compasses-over-Maps）" class="headerlink" title="指南针优于地图（Compasses over Maps）"></a>指南针优于地图（Compasses over Maps）</h3><ul>
<li>找准方向</li>
</ul>
<h3 id="风险优于安全（Risk-over-Safety）"><a href="#风险优于安全（Risk-over-Safety）" class="headerlink" title="风险优于安全（Risk over Safety）"></a>风险优于安全（Risk over Safety）</h3><ul>
<li>愿意承担风险</li>
</ul>
<h3 id="违抗优于服从（Disobedience-over-Compliance）"><a href="#违抗优于服从（Disobedience-over-Compliance）" class="headerlink" title="违抗优于服从（Disobedience over Compliance）"></a>违抗优于服从（Disobedience over Compliance）</h3><ul>
<li>叛逆和对叛逆宽容</li>
</ul>
<h3 id="实践优于理论（Practice-over-Theory）"><a href="#实践优于理论（Practice-over-Theory）" class="headerlink" title="实践优于理论（Practice over Theory）"></a>实践优于理论（Practice over Theory）</h3><ul>
<li>变化快、节奏快</li>
</ul>
<h3 id="多样性优于能力（Diversity-over-Ability）"><a href="#多样性优于能力（Diversity-over-Ability）" class="headerlink" title="多样性优于能力（Diversity over Ability）"></a>多样性优于能力（Diversity over Ability）</h3><ul>
<li>通才比专才重要</li>
<li>团队多样性比单一化有优势</li>
</ul>
<h3 id="韧性优于力量（Resilience-over-Strength）"><a href="#韧性优于力量（Resilience-over-Strength）" class="headerlink" title="韧性优于力量（Resilience over Strength）"></a>韧性优于力量（Resilience over Strength）</h3><ul>
<li>柔能克刚</li>
</ul>
<h3 id="系统优于个体（Systems-over-Objects）"><a href="#系统优于个体（Systems-over-Objects）" class="headerlink" title="系统优于个体（Systems over Objects）"></a>系统优于个体（Systems over Objects）</h3><ul>
<li>整体大于个体</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/11/18/2018/11/2018-11-18-%E6%9C%8D%E5%8A%A1%E7%A8%B3%E5%AE%9A%E6%80%A7%E5%8F%8A%E5%BA%94%E7%94%A8%E9%98%B2%E6%94%BB%E5%87%BB%E6%96%B9%E6%A1%88/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/18/2018/11/2018-11-18-%E6%9C%8D%E5%8A%A1%E7%A8%B3%E5%AE%9A%E6%80%A7%E5%8F%8A%E5%BA%94%E7%94%A8%E9%98%B2%E6%94%BB%E5%87%BB%E6%96%B9%E6%A1%88/index/" class="post-title-link" itemprop="url">服务稳定性及应用防攻击方案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-18 08:00:00" itemprop="dateCreated datePublished" datetime="2018-11-18T08:00:00+08:00">2018-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/op/" itemprop="url" rel="index"><span itemprop="name">op</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="一、-服务稳定性"><a href="#一、-服务稳定性" class="headerlink" title="一、 服务稳定性"></a><strong>一、 服务稳定性</strong></h3><h4 id="1．-基本监控"><a href="#1．-基本监控" class="headerlink" title="1． 基本监控"></a>1． 基本监控</h4><p>基本监控推荐使用Zabbix，开源分布式企业级监控系统，能满足目前我们监控的需求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a.  系统监控，包括CPU、内存、磁盘、网络等，能够对系统级别的风险进行报警，目前已经实现并线上运行</span><br><span class="line">b.  服务进程及端口监控，能够监控服务异常退出，目前已经实现并线上运行</span><br><span class="line">c.  自定义脚本程序模拟接口登陆访问结合Zabbix监控日志文件功能，能够对自定义的错误进行报警，目前已经实现并线上运行</span><br><span class="line">d.  以上默认系统监控会自动添加，服务进程端口及自定义监控有需要时添加</span><br></pre></td></tr></table></figure>

<h4 id="2．-日志收集"><a href="#2．-日志收集" class="headerlink" title="2． 日志收集"></a>2． 日志收集</h4><p>日志收集推荐使用Elastic Stack协议栈，可以满足收集海量日志需求，而且便于后续分析、报表、报警操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a.  日志包括服务正常访问日志及错误日志</span><br><span class="line">b.  访问日志可以收集客户端IP、响应时间、HTTP状态码、发送字节、Referer、Agent等，也可以自定义字段</span><br><span class="line">c.  错误日志可以收集自定义字段错误字段，例如登陆失败、连接超时、后端无响应等</span><br><span class="line">d.  以上需要提前准备好日志及定义好日志字段</span><br></pre></td></tr></table></figure>

<h4 id="3．-指标分析"><a href="#3．-指标分析" class="headerlink" title="3． 指标分析"></a>3． 指标分析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a.  访问日志指标，例如HTTP状态码统计、响应时间分布、其他字段统计</span><br><span class="line">b.  错误日志指标，例如一段时间内某某错误出现的次数、一段时间内各项错误比例分布、错误出现趋势、错误出现时间、错误出现区域等</span><br><span class="line">c.  以上都可以通过Elasticsearch支持的Lucene语言或者Kibana Dev Tools编辑DSL语言进行精确或模糊匹配来分析</span><br></pre></td></tr></table></figure>

<h4 id="4．-报表制作"><a href="#4．-报表制作" class="headerlink" title="4． 报表制作"></a>4． 报表制作</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a.  Kibana通过visualize及dashboard来实现饼图、趋势图、表格、直方图、地图、Metric、热力图、Markdown等形式的报表</span><br><span class="line">b.  Grafana结合Data Sources及Plugins来实现饼图、趋势图、直方图、Html等形式的报表</span><br></pre></td></tr></table></figure>

<h4 id="5．-异常报警"><a href="#5．-异常报警" class="headerlink" title="5． 异常报警"></a>5． 异常报警</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a.  Elastalert通过Elasticsearch Python API编辑报警策略实现报警，例如一段时间内匹配某项DSL语法结果出现的次数大于或小于某值报警、两段对比时间段内匹配结果的值对比后大于或者小于某一基数、一段时间内匹配的值进行聚合运算后大于或小于某值报警、其他自定义语法获得结果异常报警</span><br><span class="line">b.  Grafana可以对趋势设置Alert阈值并通过邮件报警</span><br><span class="line">c.  以上工程量都比较大而且难度系数也不小但都能实现</span><br></pre></td></tr></table></figure>

<h3 id="二、应用防攻击"><a href="#二、应用防攻击" class="headerlink" title="二、应用防攻击"></a><strong>二、应用防攻击</strong></h3><h4 id="1．主要是基于Nginx与Iptables实现（目前CLB不支持这些配置）"><a href="#1．主要是基于Nginx与Iptables实现（目前CLB不支持这些配置）" class="headerlink" title="1．主要是基于Nginx与Iptables实现（目前CLB不支持这些配置）"></a>1．主要是基于Nginx与Iptables实现（目前CLB不支持这些配置）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">a.  限速</span><br><span class="line">利用ngx_http_limit_conn_module及ngx_http_limit_req_module模块，首先在http区域里定义好限速限制连接数策略，再在具体的域名上使用，具体限速及限制连接数需要根据实际情况评估，超过的连接会默认直接返回503不转发到袁征</span><br><span class="line">b.  屏蔽IP</span><br><span class="line">方法一使用ngx_http_access_module模块allow、deny控制，缺点是通过remote_addr来屏蔽IP的，支持CIDR等格式地址</span><br><span class="line">方法二使用自定义客户端IP变量$clientRealIp来屏蔽，IP需要写成正则形式的，支持IP穿透，所以通过CDN的域名这种方法也能生效</span><br><span class="line">方法三自定义屏蔽IP，结合Elasticsearch查询异常IP可自动化屏蔽IP，前两种方法易于实现但是只能手动屏蔽</span><br><span class="line">c.  屏蔽reffer</span><br><span class="line">例如屏蔽某些流氓网站友情链接</span><br><span class="line">d.  屏蔽agent</span><br><span class="line">例如屏蔽爬虫agent</span><br><span class="line">e.  屏蔽url</span><br><span class="line">例如屏蔽有漏洞url禁止外部访问</span><br><span class="line">f.  其他自定义</span><br><span class="line">设置故障域，怎样都防不住可以通过error_page功能，转发流量到备用源站</span><br></pre></td></tr></table></figure>

<h4 id="2．第三方腾讯云产品通过网站管家WAF与大禹BGP高防包实现"><a href="#2．第三方腾讯云产品通过网站管家WAF与大禹BGP高防包实现" class="headerlink" title="2．第三方腾讯云产品通过网站管家WAF与大禹BGP高防包实现"></a>2．第三方腾讯云产品通过网站管家WAF与大禹BGP高防包实现</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a.  网站管家WAF高级版放在CLB前面</span><br><span class="line">b.  大禹BGP高防放在WAF前面</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/22/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><span class="page-number current">23</span><a class="page-number" href="/page/24/">24</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/24/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jerry Min</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">260</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jerry Min</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
