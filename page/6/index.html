<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"minminmsn.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="MinMinMsn">
<meta property="og:url" content="https://minminmsn.github.io/page/6/index.html">
<meta property="og:site_name" content="MinMinMsn">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Jerry Min">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://minminmsn.github.io/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>MinMinMsn</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">MinMinMsn</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2020/07/16/2020/07/2020-07-16-%E5%9C%A8%E7%BA%BF%E6%9B%BF%E6%8D%A2ingress%E8%AF%81%E4%B9%A6/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/16/2020/07/2020-07-16-%E5%9C%A8%E7%BA%BF%E6%9B%BF%E6%8D%A2ingress%E8%AF%81%E4%B9%A6/index/" class="post-title-link" itemprop="url">在线更新ingress证书</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-16 08:00:00" itemprop="dateCreated datePublished" datetime="2020-07-16T08:00:00+08:00">2020-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:34" itemprop="dateModified" datetime="2023-05-26T15:06:34+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>1.制作新证书</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 yaml]# kubectl  create secret tls ingress-secret2021 --key minminmsn.key --cert minminmsn.crt </span><br></pre></td></tr></table></figure>

<p><strong>2.在ingress替换secretName</strong> 查看ingress</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 yaml]# kubectl get ingress</span><br><span class="line">NAME                    HOSTS                                                     ADDRESS   PORTS     AGE</span><br><span class="line">jenkins                 jenkins.minminmsn.com                                              80, 443   419d</span><br><span class="line">minminmsn-harbor-ingress   core-harbor.minminmsn.com,notary-harbor.minminmsn.com             80, 443   30h</span><br></pre></td></tr></table></figure>

<p>在线编辑ingress，替换secretName的值由ingress-secret2020，替换为ingress-secret2021，保存生效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 yaml]# kubectl edit ingress minminmsn-harbor-ingress</span><br><span class="line"># Please edit the object below. Lines beginning with a &#x27;#&#x27; will be ignored,</span><br><span class="line"># and an empty file will abort the edit. If an error occurs while saving this file will be</span><br><span class="line"># reopened with the relevant failures.</span><br><span class="line">#</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    ingress.kubernetes.io/proxy-body-size: &quot;0&quot;</span><br><span class="line">    ingress.kubernetes.io/ssl-redirect: &quot;true&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-body-size: &quot;0&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/ssl-redirect: &quot;true&quot;</span><br><span class="line">  creationTimestamp: &quot;2020-07-15T03:18:15Z&quot;</span><br><span class="line">  generation: 1</span><br><span class="line">  labels:</span><br><span class="line">    app: harbor</span><br><span class="line">    chart: harbor</span><br><span class="line">    heritage: Tiller</span><br><span class="line">    release: minminmsn</span><br><span class="line">  name: minminmsn-harbor-ingress</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: &quot;91736348&quot;</span><br><span class="line">  selfLink: /apis/extensions/v1beta1/namespaces/default/ingresses/minminmsn-harbor-ingress</span><br><span class="line">  uid: d2bf4b41-c649-11ea-9386-52540089b2b6</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: core-harbor.minminmsn.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: minminmsn-harbor-portal</span><br><span class="line">          servicePort: 80</span><br><span class="line">        path: /</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: minminmsn-harbor-core</span><br><span class="line">          servicePort: 80</span><br><span class="line">        path: /api/</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: minminmsn-harbor-core</span><br><span class="line">          servicePort: 80</span><br><span class="line">        path: /service/</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: minminmsn-harbor-core</span><br><span class="line">          servicePort: 80</span><br><span class="line">        path: /v2/</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: minminmsn-harbor-core</span><br><span class="line">          servicePort: 80</span><br><span class="line">        path: /chartrepo/</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: minminmsn-harbor-core</span><br><span class="line">          servicePort: 80</span><br><span class="line">        path: /c/</span><br><span class="line">  - host: notary-harbor.minminmsn.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: minminmsn-harbor-notary-server</span><br><span class="line">          servicePort: 4443</span><br><span class="line">        path: /</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - core-harbor.minminmsn.com</span><br><span class="line">    secretName: ingress-secret2021</span><br><span class="line">  - hosts:</span><br><span class="line">    - notary-harbor.minminmsn.com</span><br><span class="line">    secretName: ingress-secret2021</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2020/07/15/2020/07/2020-07-15-harbor-helm%E9%95%9C%E5%83%8F%E5%BA%93%E9%87%8D%E6%96%B0%E9%83%A8%E7%BD%B2%E5%90%8Epv%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/15/2020/07/2020-07-15-harbor-helm%E9%95%9C%E5%83%8F%E5%BA%93%E9%87%8D%E6%96%B0%E9%83%A8%E7%BD%B2%E5%90%8Epv%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D/index/" class="post-title-link" itemprop="url">Harbor-helm镜像库重新部署后PV数据恢复</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-15 08:00:00" itemprop="dateCreated datePublished" datetime="2020-07-15T08:00:00+08:00">2020-07-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:34" itemprop="dateModified" datetime="2023-05-26T15:06:34+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>起因</strong></p>
<p>开发反馈habor镜像库登陆不了，初步查看是证书过期了。</p>
<p><strong>解决方案</strong> 之前Harbor-helm部署镜像库文档可以回顾链接<a target="_blank" rel="noopener" href="https://minminmsn.com/middleware/698/">Kubernetes1.13.1集群集成Harbor-helm</a> 1.首先新建新证书的secret</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 harbor-helm]#  kubectl  create secret tls ingress-secret2021 --key minminmsnauto.key --cert minminmsnauto.crt </span><br></pre></td></tr></table></figure>

<p>2.然后修改harbor-helm的value.yaml，把secretName替换下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 harbor-helm]# head -n 20 values.yaml</span><br><span class="line">expose:</span><br><span class="line">  # Set the way how to expose the service. Set the type as &quot;ingress&quot;, </span><br><span class="line">  # &quot;clusterIP&quot; or &quot;nodePort&quot; and fill the information in the corresponding </span><br><span class="line">  # section</span><br><span class="line">  type: ingress</span><br><span class="line">  tls:</span><br><span class="line">    # Enable the tls or not. Note: if the type is &quot;ingress&quot; and the tls </span><br><span class="line">    # is disabled, the port must be included in the command when pull/push</span><br><span class="line">    # images. Refer to https://github.com/goharbor/harbor/issues/5291 </span><br><span class="line">    # for the detail.</span><br><span class="line">    enabled: true</span><br><span class="line">    # Fill the name of secret if you want to use your own TLS certificate</span><br><span class="line">    # and private key. The secret must contain keys named tls.crt and </span><br><span class="line">    # tls.key that contain the certificate and private key to use for TLS</span><br><span class="line">    # The certificate and private key will be generated automatically if </span><br><span class="line">    # it is not set</span><br><span class="line">    secretName: &quot;ingress-secret2021&quot;</span><br><span class="line">    # By default, the Notary service will use the same cert and key as</span><br><span class="line">    # described above. Fill the name of secret if you want to use a </span><br><span class="line">    # separated one. Only needed when the type is &quot;ingress&quot;.</span><br></pre></td></tr></table></figure>

<p>3.最后使用helm upgrade更新版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 harbor-helm]#  helm upgrade  minminmsn . -f values.yaml</span><br></pre></td></tr></table></figure>

<p>到这个时候应该能解决需求，可是事与愿违，不知道哪儿除了问题，这时登陆Harbor证书问题是解决了，但是项目及库访问不了提示内部错误，看Pod的运行状态也都是Running。 最后打算使用helm先delete掉再install，但是这样创建的harbor看起来一切正常，实际上是个初始化环境，是自动生成的新PV并没有原来的数据。此时发现原来的PV还在，下面就开始找PV恢复的方案。</p>
<p><strong>调整PV状态</strong></p>
<p>1.查询此时PV与PVC状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 harbor-helm]# kubectl get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM                                            STORAGECLASS   REASON   AGE                    9h</span><br><span class="line">pvc-e7967cfe-7ded-11e9-a09d-52540089b2b6   50Gi       RWO            Retain           Released   default/minminmsn-harbor-chartmuseum                rbd                     417d</span><br><span class="line">pvc-e7974d1c-7ded-11e9-a09d-52540089b2b6   20Gi       RWO            Retain           Released   default/minminmsn-harbor-jobservice                 rbd                     417d</span><br><span class="line">pvc-e7985b55-7ded-11e9-a09d-52540089b2b6   2000Gi     RWO            Retain           Released   default/minminmsn-harbor-registry                   rbd                     417d</span><br><span class="line">pvc-e7d38097-7ded-11e9-a09d-52540089b2b6   20Gi       RWO            Retain           Released   default/database-data-minminmsn-harbor-database-0   rbd                     417d</span><br><span class="line">pvc-e7da3f3c-7ded-11e9-a09d-52540089b2b6   20Gi       RWO            Retain           Released   default/data-minminmsn-harbor-redis-0               rbd                     417d</span><br><span class="line">[root@elasticsearch01 harbor-helm]# kubectl get pvc</span><br><span class="line">NAME                                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">data-minminmsn-harbor-redis-0               Bound    pvc-6cd422e4-c5f0-11ea-9386-52540089b2b6   20Gi       RWO            rbd            9h</span><br><span class="line">database-data-minminmsn-harbor-database-0   Bound    pvc-6ccda00b-c5f0-11ea-9386-52540089b2b6   20Gi       RWO            rbd            9h</span><br><span class="line">minminmsn-harbor-chartmuseum                Bound    pvc-6c903857-c5f0-11ea-9386-52540089b2b6   50Gi       RWO            rbd            9h</span><br><span class="line">minminmsn-harbor-jobservice                 Bound    pvc-6c91d1a4-c5f0-11ea-9386-52540089b2b6   20Gi       RWO            rbd            9h</span><br><span class="line">minminmsn-harbor-registry                   Bound    pvc-6c92bfc0-c5f0-11ea-9386-52540089b2b6   500Gi      RWO            rbd            9h</span><br></pre></td></tr></table></figure>

<p>2.修改PV状态 先把PV的状态由Released改变成 备注：默认创建的PV的回收策略是Delete就是用完就删除，之前特意把RECLAIM POLICY改为了Retain，在线修改PV回收策略可以参考文档<a target="_blank" rel="noopener" href="https://minminmsn.com/cloud/1091/">在线修改 PV的回收策略</a>，否则这里Helm Delete后就会自动删除PV，就没有后来这篇PV数据恢复操作了。 在线编辑PV,需要把其中claimRef这段删除，这样状态就可以变成Available了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">claimRef:</span><br><span class="line">  apiVersion: v1</span><br><span class="line">  kind: PersistentVolumeClaim</span><br><span class="line">  name: minminmsn-harbor-chartmuseum</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: &quot;91736092&quot;</span><br><span class="line">  uid: b31ec8ca-c649-11ea-9386-52540089b2b6</span><br><span class="line">persistentVolumeReclaimPolicy: Retain</span><br></pre></td></tr></table></figure>

<p>具体如下修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 harbor-helm]# kubectl edit pv pvc-e7967cfe-7ded-11e9-a09d-52540089b2b6 </span><br><span class="line"># Please edit the object below. Lines beginning with a &#x27;#&#x27; will be ignored,</span><br><span class="line"># and an empty file will abort the edit. If an error occurs while saving this file will be</span><br><span class="line"># reopened with the relevant failures.</span><br><span class="line">#</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    pv.kubernetes.io/bound-by-controller: &quot;yes&quot;</span><br><span class="line">    pv.kubernetes.io/provisioned-by: ceph.com/rbd</span><br><span class="line">    rbdProvisionerIdentity: ceph.com/rbd</span><br><span class="line">  creationTimestamp: &quot;2019-05-24T06:33:55Z&quot;</span><br><span class="line">  finalizers:</span><br><span class="line">  - kubernetes.io/pv-protection</span><br><span class="line">  name: pvc-e7967cfe-7ded-11e9-a09d-52540089b2b6</span><br><span class="line">  resourceVersion: &quot;91736100&quot;</span><br><span class="line">  selfLink: /api/v1/persistentvolumes/pvc-e7967cfe-7ded-11e9-a09d-52540089b2b6</span><br><span class="line">  uid: e7ade7f7-7ded-11e9-a09d-52540089b2b6</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 50Gi</span><br><span class="line">  claimRef:</span><br><span class="line">    apiVersion: v1</span><br><span class="line">    kind: PersistentVolumeClaim</span><br><span class="line">    name: minminmsn-harbor-chartmuseum</span><br><span class="line">    namespace: default</span><br><span class="line">    resourceVersion: &quot;91736092&quot;</span><br><span class="line">    uid: b31ec8ca-c649-11ea-9386-52540089b2b6</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  rbd:</span><br><span class="line">    image: kubernetes-dynamic-pvc-e79b34d3-7ded-11e9-ac1b-02420afe4905</span><br><span class="line">    keyring: /etc/ceph/keyring</span><br><span class="line">    monitors:</span><br><span class="line">    - 10.0.4.8:6789</span><br><span class="line">    pool: rbd-k8s</span><br><span class="line">    secretRef:</span><br><span class="line">      name: ceph-secret</span><br><span class="line">      namespace: default</span><br><span class="line">    user: admin</span><br><span class="line">  storageClassName: rbd</span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">status:</span><br><span class="line">  phase: Released</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.其他四个PV同样操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 harbor-helm]# kubectl edit pv pvc-e7974d1c-7ded-11e9-a09d-52540089b2b6</span><br><span class="line">[root@elasticsearch01 harbor-helm]# kubectl edit pv pvc-e7985b55-7ded-11e9-a09d-52540089b2b6</span><br><span class="line">[root@elasticsearch01 harbor-helm]# kubectl edit pv pvc-e7d38097-7ded-11e9-a09d-52540089b2b6</span><br><span class="line">[root@elasticsearch01 harbor-helm]# kubectl edit pv pvc-e7da3f3c-7ded-11e9-a09d-52540089b2b6</span><br></pre></td></tr></table></figure>

<p>4.查看效果 现在看PV的STATUS已经变成了Available，然后CLAIM也变空了，这样就可以在后面绑定使用了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 harbor-helm]# kubectl get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                       STORAGECLASS   REASON   AGE</span><br><span class="line">pvc-e7967cfe-7ded-11e9-a09d-52540089b2b6   50Gi       RWO            Retain           Available                               rbd                     417d</span><br><span class="line">pvc-e7974d1c-7ded-11e9-a09d-52540089b2b6   20Gi       RWO            Retain           Available                               rbd                     417d</span><br><span class="line">pvc-e7985b55-7ded-11e9-a09d-52540089b2b6   2000Gi     RWO            Retain           Available                               rbd                     417d</span><br><span class="line">pvc-e7d38097-7ded-11e9-a09d-52540089b2b6   20Gi       RWO            Retain           Available                               rbd                     417d</span><br><span class="line">pvc-e7da3f3c-7ded-11e9-a09d-52540089b2b6   20Gi       RWO            Retain           Available                               rbd                     417d</span><br></pre></td></tr></table></figure>

<p><strong>创建PVC</strong></p>
<p>1.先设置好PVC及PV对应关系</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 yaml]# cat minminmsn.pvc </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: minminmsn-harbor-registry</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  storageClassName: &quot;rbd&quot;</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 2000Gi</span><br><span class="line">  volumeName: &quot;pvc-e7985b55-7ded-11e9-a09d-52540089b2b6&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: minminmsn-harbor-jobservice</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  storageClassName: &quot;rbd&quot;</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 20Gi</span><br><span class="line">  volumeName: &quot;pvc-e7974d1c-7ded-11e9-a09d-52540089b2b6&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: minminmsn-harbor-chartmuseum</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  storageClassName: &quot;rbd&quot;</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 50Gi</span><br><span class="line">  volumeName: &quot;pvc-e7967cfe-7ded-11e9-a09d-52540089b2b6&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: database-data-minminmsn-harbor-database-0</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  storageClassName: &quot;rbd&quot;</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 20Gi</span><br><span class="line">  volumeName: &quot;pvc-e7d38097-7ded-11e9-a09d-52540089b2b6&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: data-minminmsn-harbor-redis-0</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  storageClassName: &quot;rbd&quot;</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 20Gi</span><br><span class="line">  volumeName: &quot;pvc-e7da3f3c-7ded-11e9-a09d-52540089b2b6&quot;</span><br></pre></td></tr></table></figure>

<p>2.创建PVC</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 yaml]# kubectl apply -f minminmsn.pvc </span><br><span class="line">persistentvolumeclaim/minminmsn-harbor-registry created</span><br><span class="line">persistentvolumeclaim/minminmsn-harbor-jobservice created</span><br><span class="line">persistentvolumeclaim/minminmsn-harbor-chartmuseum created</span><br><span class="line">persistentvolumeclaim/database-data-minminmsn-harbor-database-0 created</span><br><span class="line">persistentvolumeclaim/data-minminmsn-harbor-redis-0 created</span><br></pre></td></tr></table></figure>

<p>3.检查PV与PVC</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 yaml]# kubectl get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                            STORAGECLASS   REASON   AGE</span><br><span class="line">pvc-e7967cfe-7ded-11e9-a09d-52540089b2b6   50Gi       RWO            Retain           Bound    default/minminmsn-harbor-chartmuseum                rbd                     417d</span><br><span class="line">pvc-e7974d1c-7ded-11e9-a09d-52540089b2b6   20Gi       RWO            Retain           Bound    default/minminmsn-harbor-jobservice                 rbd                     417d</span><br><span class="line">pvc-e7985b55-7ded-11e9-a09d-52540089b2b6   2000Gi     RWO            Retain           Bound    default/minminmsn-harbor-registry                   rbd                     417d</span><br><span class="line">pvc-e7d38097-7ded-11e9-a09d-52540089b2b6   20Gi       RWO            Retain           Bound    default/database-data-minminmsn-harbor-database-0   rbd                     417d</span><br><span class="line">pvc-e7da3f3c-7ded-11e9-a09d-52540089b2b6   20Gi       RWO            Retain           Bound    default/data-minminmsn-harbor-redis-0               rbd                     417d</span><br><span class="line">[root@elasticsearch01 yaml]# kubectl get pvc</span><br><span class="line">NAME                                     STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">ceph-rbd-pv-claim                        Bound     ceph-rbd-pv                                20Gi       RWO                           540d</span><br><span class="line">data-minminmsn-harbor-redis-0               Pending   pvc-e7da3f3c-7ded-11e9-a09d-52540089b2b6   0                         rbd            12s</span><br><span class="line">database-data-minminmsn-harbor-database-0   Pending   pvc-e7d38097-7ded-11e9-a09d-52540089b2b6   0                         rbd            12s</span><br><span class="line">minminmsn-harbor-chartmuseum                Pending   pvc-e7967cfe-7ded-11e9-a09d-52540089b2b6   0                         rbd            12s</span><br><span class="line">minminmsn-harbor-jobservice                 Pending   pvc-e7974d1c-7ded-11e9-a09d-52540089b2b6   0                         rbd            12s</span><br><span class="line">minminmsn-harbor-registry                   Bound     pvc-e7985b55-7ded-11e9-a09d-52540089b2b6   2000Gi     RWO            rbd            12s</span><br><span class="line">[root@elasticsearch01 yaml]# kubectl describe pvc minminmsn-harbor-registry</span><br><span class="line">Name:          minminmsn-harbor-registry</span><br><span class="line">Namespace:     default</span><br><span class="line">StorageClass:  rbd</span><br><span class="line">Status:        Bound</span><br><span class="line">Volume:        pvc-e7985b55-7ded-11e9-a09d-52540089b2b6</span><br><span class="line">Labels:        &lt;none&gt;</span><br><span class="line">Annotations:   kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                 &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;PersistentVolumeClaim&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;minminmsn-harbor-registry&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spe...</span><br><span class="line">               pv.kubernetes.io/bind-completed: yes</span><br><span class="line">Finalizers:    [kubernetes.io/pvc-protection]</span><br><span class="line">Capacity:      2000Gi</span><br><span class="line">Access Modes:  RWO</span><br><span class="line">VolumeMode:    Filesystem</span><br><span class="line">Events:        &lt;none&gt;</span><br><span class="line">Mounted By:    &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p><strong>使用Hlem重新部署Harbor镜像库</strong></p>
<p>1.部署前先删除版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 harbor-helm]# helm delete --purge minminmsn</span><br><span class="line">helm delete --purge minminmsn</span><br><span class="line">release &quot;minminmsn&quot; deleted</span><br></pre></td></tr></table></figure>

<p>2.修改Harbor-helm的values.yaml中PVC相关值 注意existingClaim: “”由空值改成上面生成的PVC名字，注意对应关系，其他不变，具体变更如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">persistence:</span><br><span class="line">  enabled: true</span><br><span class="line">  # Setting it to &quot;keep&quot; to avoid removing PVCs during a helm delete </span><br><span class="line">  # operation. Leaving it empty will delete PVCs after the chart deleted</span><br><span class="line">  resourcePolicy: &quot;keep&quot;</span><br><span class="line">  persistentVolumeClaim:</span><br><span class="line">    registry:</span><br><span class="line">      # Use the existing PVC which must be created manually before bound</span><br><span class="line">      existingClaim: &quot;minminmsn-harbor-registry&quot;</span><br><span class="line">      # Specify the &quot;storageClass&quot; used to provision the volume. Or the default</span><br><span class="line">      # StorageClass will be used(the default).</span><br><span class="line">      # Set it to &quot;-&quot; to disable dynamic provisioning</span><br><span class="line">      storageClass: &quot;rbd&quot;</span><br><span class="line">      subPath: &quot;&quot;</span><br><span class="line">      accessMode: ReadWriteOnce</span><br><span class="line">      size: 2000Gi</span><br><span class="line">    chartmuseum:</span><br><span class="line">      existingClaim: &quot;minminmsn-harbor-chartmuseum&quot;</span><br><span class="line">      storageClass: &quot;rbd&quot;</span><br><span class="line">      subPath: &quot;&quot;</span><br><span class="line">      accessMode: ReadWriteOnce</span><br><span class="line">      size: 50Gi</span><br><span class="line">    jobservice:</span><br><span class="line">      existingClaim: &quot;minminmsn-harbor-jobservice&quot;</span><br><span class="line">      storageClass: &quot;rbd&quot;</span><br><span class="line">      subPath: &quot;&quot;</span><br><span class="line">      accessMode: ReadWriteOnce</span><br><span class="line">      size: 20Gi</span><br><span class="line">    # If external database is used, the following settings for database will </span><br><span class="line">    # be ignored</span><br><span class="line">    database:</span><br><span class="line">      existingClaim: &quot;database-data-minminmsn-harbor-database-0&quot;</span><br><span class="line">      storageClass: &quot;rbd&quot;</span><br><span class="line">      subPath: &quot;&quot;</span><br><span class="line">      accessMode: ReadWriteOnce</span><br><span class="line">      size: 20Gi</span><br><span class="line">    # If external Redis is used, the following settings for Redis will </span><br><span class="line">    # be ignored</span><br><span class="line">    redis:</span><br><span class="line">      existingClaim: &quot;data-minminmsn-harbor-redis-0&quot;</span><br><span class="line">      storageClass: &quot;rbd&quot;</span><br><span class="line">      subPath: &quot;&quot;</span><br><span class="line">      accessMode: ReadWriteOnce</span><br><span class="line">      size: 20Gi</span><br></pre></td></tr></table></figure>

<p>3.重新部署</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 harbor-helm]# helm  install . --name minminmsn</span><br><span class="line">NAME:   minminmsn</span><br><span class="line">LAST DEPLOYED: Wed Jul 15 11:18:13 2020</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/Service</span><br><span class="line">NAME                         TYPE       CLUSTER-IP      EXTERNAL-IP  PORT(S)            AGE</span><br><span class="line">minminmsn-harbor-adminserver    ClusterIP  10.254.58.23    &lt;none&gt;       80/TCP             1s</span><br><span class="line">minminmsn-harbor-chartmuseum    ClusterIP  10.254.154.44   &lt;none&gt;       80/TCP             1s</span><br><span class="line">minminmsn-harbor-clair          ClusterIP  10.254.25.107   &lt;none&gt;       6060/TCP           1s</span><br><span class="line">minminmsn-harbor-core           ClusterIP  10.254.56.153   &lt;none&gt;       80/TCP             1s</span><br><span class="line">minminmsn-harbor-database       ClusterIP  10.254.65.18    &lt;none&gt;       5432/TCP           1s</span><br><span class="line">minminmsn-harbor-jobservice     ClusterIP  10.254.81.97    &lt;none&gt;       80/TCP             1s</span><br><span class="line">minminmsn-harbor-notary-server  ClusterIP  10.254.99.90    &lt;none&gt;       4443/TCP           1s</span><br><span class="line">minminmsn-harbor-notary-signer  ClusterIP  10.254.175.105  &lt;none&gt;       7899/TCP           1s</span><br><span class="line">minminmsn-harbor-portal         ClusterIP  10.254.242.113  &lt;none&gt;       80/TCP             1s</span><br><span class="line">minminmsn-harbor-redis          ClusterIP  10.254.127.40   &lt;none&gt;       6379/TCP           1s</span><br><span class="line">minminmsn-harbor-registry       ClusterIP  10.254.158.222  &lt;none&gt;       5000/TCP,8080/TCP  1s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Deployment</span><br><span class="line">NAME                         DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE</span><br><span class="line">minminmsn-harbor-adminserver    1        1        1           0          1s</span><br><span class="line">minminmsn-harbor-chartmuseum    1        1        1           0          1s</span><br><span class="line">minminmsn-harbor-clair          1        0        0           0          1s</span><br><span class="line">minminmsn-harbor-core           1        0        0           0          1s</span><br><span class="line">minminmsn-harbor-jobservice     1        0        0           0          1s</span><br><span class="line">minminmsn-harbor-notary-server  1        0        0           0          1s</span><br><span class="line">minminmsn-harbor-notary-signer  1        0        0           0          1s</span><br><span class="line">minminmsn-harbor-portal         1        0        0           0          1s</span><br><span class="line">minminmsn-harbor-registry       1        0        0           0          1s</span><br><span class="line"></span><br><span class="line">==&gt; v1/StatefulSet</span><br><span class="line">NAME                    DESIRED  CURRENT  AGE</span><br><span class="line">minminmsn-harbor-database  1        1        1s</span><br><span class="line">minminmsn-harbor-redis     1        1        1s</span><br><span class="line"></span><br><span class="line">==&gt; v1beta1/Ingress</span><br><span class="line">NAME                   HOSTS                                                    ADDRESS  PORTS  AGE</span><br><span class="line">minminmsn-harbor-ingress  core-harbor.minminmsn.com,notary-harbor.minminmsn.com  80, 443  1s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Pod(related)</span><br><span class="line">NAME                                          READY  STATUS             RESTARTS  AGE</span><br><span class="line">minminmsn-harbor-adminserver-b5d58db8c-wmrbd     0/1    ContainerCreating  0         1s</span><br><span class="line">minminmsn-harbor-chartmuseum-7c6b9d4977-94rhb    0/1    Pending            0         1s</span><br><span class="line">minminmsn-harbor-clair-54465ff7dd-d7bxx          0/1    Pending            0         1s</span><br><span class="line">minminmsn-harbor-core-587cc5d9b5-2xxl9           0/1    Pending            0         1s</span><br><span class="line">minminmsn-harbor-jobservice-764bb697d-wsxqx      0/1    Pending            0         1s</span><br><span class="line">minminmsn-harbor-notary-server-77fbb84fcc-2bw7c  0/1    Pending            0         1s</span><br><span class="line">minminmsn-harbor-notary-signer-8466d68f5b-klv76  0/1    Pending            0         1s</span><br><span class="line">minminmsn-harbor-database-0                      0/1    Pending            0         1s</span><br><span class="line">minminmsn-harbor-redis-0                         0/1    Pending            0         1s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Secret</span><br><span class="line">NAME                       TYPE    DATA  AGE</span><br><span class="line">minminmsn-harbor-adminserver  Opaque  4     1s</span><br><span class="line">minminmsn-harbor-chartmuseum  Opaque  1     1s</span><br><span class="line">minminmsn-harbor-core         Opaque  4     1s</span><br><span class="line">minminmsn-harbor-database     Opaque  1     1s</span><br><span class="line">minminmsn-harbor-jobservice   Opaque  1     1s</span><br><span class="line">minminmsn-harbor-registry     Opaque  1     1s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ConfigMap</span><br><span class="line">NAME                         DATA  AGE</span><br><span class="line">minminmsn-harbor-adminserver    39    1s</span><br><span class="line">minminmsn-harbor-chartmuseum    24    1s</span><br><span class="line">minminmsn-harbor-clair          1     1s</span><br><span class="line">minminmsn-harbor-core           1     1s</span><br><span class="line">minminmsn-harbor-jobservice     1     1s</span><br><span class="line">minminmsn-harbor-notary-server  5     1s</span><br><span class="line">minminmsn-harbor-registry       2     1s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line">Please wait for several minutes for Harbor deployment to complete.</span><br><span class="line">Then you should be able to visit the Harbor portal at https://core-harbor.minminmsn.com. </span><br><span class="line">For more details, please visit https://github.com/goharbor/harbor.</span><br><span class="line"></span><br><span class="line">3.查看新生成Pods的信息</span><br><span class="line">[root@elasticsearch01 harbor-helm]# kubectl get pods</span><br><span class="line">NAME                                           READY   STATUS              RESTARTS   AGE</span><br><span class="line">minminmsn-harbor-adminserver-b5d58db8c-wmrbd      0/1     ContainerCreating   0          9s</span><br><span class="line">minminmsn-harbor-chartmuseum-7c6b9d4977-94rhb     0/1     ContainerCreating   0          9s</span><br><span class="line">minminmsn-harbor-clair-54465ff7dd-d7bxx           0/1     Running             0          9s</span><br><span class="line">minminmsn-harbor-core-587cc5d9b5-2xxl9            0/1     Running             0          9s</span><br><span class="line">minminmsn-harbor-database-0                       0/1     Init:0/1            0          9s</span><br><span class="line">minminmsn-harbor-jobservice-764bb697d-wsxqx       0/1     ContainerCreating   0          9s</span><br><span class="line">minminmsn-harbor-notary-server-77fbb84fcc-2bw7c   0/1     ContainerCreating   0          9s</span><br><span class="line">minminmsn-harbor-notary-signer-8466d68f5b-klv76   0/1     ContainerCreating   0          9s</span><br><span class="line">minminmsn-harbor-portal-64cf8b9b69-xm8nl          0/1     ContainerCreating   0          8s</span><br><span class="line">minminmsn-harbor-redis-0                          0/1     ContainerCreating   0          9s</span><br><span class="line">minminmsn-harbor-registry-755746c5bb-q8m55        0/2     ContainerCreating   0          8s</span><br></pre></td></tr></table></figure>

<p>再等2分钟查看就上恢复了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@elasticsearch01 harbor-helm]# kubectl get pods</span><br><span class="line">NAME                                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">jenkins-0                                      1/1     Running   0          62d</span><br><span class="line">rbd-provisioner-67b4857bcd-rjwlg               1/1     Running   0          61d</span><br><span class="line">minminmsn-harbor-adminserver-b5d58db8c-wmrbd      1/1     Running   1          2m33s</span><br><span class="line">minminmsn-harbor-chartmuseum-7c6b9d4977-94rhb     1/1     Running   0          2m33s</span><br><span class="line">minminmsn-harbor-clair-54465ff7dd-d7bxx           1/1     Running   1          2m33s</span><br><span class="line">minminmsn-harbor-core-587cc5d9b5-2xxl9            1/1     Running   1          2m33s</span><br><span class="line">minminmsn-harbor-database-0                       1/1     Running   0          2m33s</span><br><span class="line">minminmsn-harbor-jobservice-764bb697d-wsxqx       1/1     Running   0          2m33s</span><br><span class="line">minminmsn-harbor-notary-server-77fbb84fcc-2bw7c   1/1     Running   0          2m33s</span><br><span class="line">minminmsn-harbor-notary-signer-8466d68f5b-klv76   1/1     Running   0          2m33s</span><br><span class="line">minminmsn-harbor-portal-64cf8b9b69-xm8nl          1/1     Running   0          2m32s</span><br><span class="line">minminmsn-harbor-redis-0                          1/1     Running   0          2m33s</span><br><span class="line">minminmsn-harbor-registry-755746c5bb-q8m55        2/2     Running   0          2m32s</span><br></pre></td></tr></table></figure>

<p>4.Harbor控制验证 证书更新了项目也恢复了 <a target="_blank" rel="noopener" href="https://core-harbor.minminmsn.com/harbor/projects">https://core-harbor.minminmsn.com/harbor/projects</a></p>
<p><img src="/images/harbor-helm.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2020/07/14/2020/07/2020-07-14-nginx%E7%BB%93%E5%90%88%E8%85%BE%E8%AE%AF%E4%BA%91clb%E5%AE%8C%E6%88%90%E8%AF%B7%E6%B1%82%E5%A4%B4host%E9%87%8D%E5%86%99/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/14/2020/07/2020-07-14-nginx%E7%BB%93%E5%90%88%E8%85%BE%E8%AE%AF%E4%BA%91clb%E5%AE%8C%E6%88%90%E8%AF%B7%E6%B1%82%E5%A4%B4host%E9%87%8D%E5%86%99/index/" class="post-title-link" itemprop="url">Nginx结合腾讯云CLB完成请求头Host重写</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-14 08:00:00" itemprop="dateCreated datePublished" datetime="2020-07-14T08:00:00+08:00">2020-07-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:34" itemprop="dateModified" datetime="2023-05-26T15:06:34+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>需求背景</strong> 1.常规情况是访问A域名时对外展示域名信息不变，内容却是B域名的，大部分在多版本发布切换时才有这种的需求 2.非常规情况是临时过渡或者域名更换时遗留访问导向 3.使用的是腾讯云clb做负载均衡暂不支持自定义请求header头</p>
<p><strong>想要的效果</strong> 访问http或<a target="_blank" rel="noopener" href="https://xxx.domainold.com时实际上是访问http或https//xxx.domainnew.xom%E7%9A%84%E5%86%85%E5%AE%B9">https://xxx.domainold.com时实际上是访问http或https://xxx.domainnew.xom的内容</a></p>
<p><strong>解决方案</strong> 该方案只支持未过CDN的域名，因为过了CDN域名前端访问控制权在腾讯云手中，不可以自定义nginx拦截流量。</p>
<p><strong>架构变更</strong> 原架构：Client–七层Clb–CVM 新架构：Client–四层Clb–Nginx–七层Clb–CVM</p>
<p><strong>具体配置</strong> 需要通过修改header头加反向代理方式实现可行，配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        listen 443 ssl;</span><br><span class="line">        server_name jumpserver.domainold.com;</span><br><span class="line">        ssl_certificate             ssl/domainold.com.crt;</span><br><span class="line">        ssl_certificate_key         ssl/domainold.com.key;</span><br><span class="line">        ssl_prefer_server_ciphers   on;</span><br><span class="line">        ssl_ciphers &quot;ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128:AES256:AES:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!DHE:3DES;&quot;</span><br><span class="line">ssl_protocols               TLSv1.3 TLSv1.2 TLSv1.1 TLSv1;</span><br><span class="line">        ssl_session_cache           shared:SSL:10m;</span><br><span class="line">        ssl_session_timeout         60m;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://158.8.188.188:80;</span><br><span class="line">            proxy_set_header Host jumpserver.domainnew.com;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        access_log  logs/jumpserver.log  main;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>备注：由于cname只改变路由且腾讯云clb不支持修改header头，所以需要新增一层nginx自定义重写header请求头中host值。jumpserver.domainold.com解析到nginx，其中158.8.188.188为7层clb负载对应的是domainnew.com域名。</p>
<p><strong>访问验证</strong> 1.nginx访问日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">108.38.55.198 - - [13/Jul/2020:18:56:28 +0800] &quot;GET /static/js/plugins/echarts/chart/pie.js HTTP/1.1&quot; 200 12159 &quot;https://jumpserver.domainold.com/&quot; jumpserver.domainold.com &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure>

<p>2.clb访问日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;request&quot;:&quot;GET /static/js/plugins/echarts/chart/pie.js HTTP/1.0&quot;,&quot;server_name&quot;:&quot;jumpserver.domainnew.com&quot;,&quot;stgw_engine_connect_time&quot;:&quot;-&quot;,&quot;upstream_addr&quot;:&quot;10.2.8.35:80&quot;,&quot;upstream_header_time&quot;:&quot;0.003&quot;,&quot;connection_requests&quot;:&quot;1&quot;,&quot;ssl_cipher&quot;:&quot;-&quot;,&quot;stgw_engine_response_time&quot;:&quot;-&quot;,&quot;stgw_request_id&quot;:&quot;186f546bcc8484a5b7ab1855afef4ff8&quot;,&quot;http_host&quot;:&quot;jumpserver.domainnew.com&quot;,&quot;http_user_agent&quot;:&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36&quot;,&quot;upstream_status&quot;:&quot;200&quot;,&quot;vip_vpcid&quot;:-1,&quot;request_time&quot;:&quot;0.003&quot;,&quot;via_stgw_engine&quot;:&quot;-&quot;,&quot;proxy_host&quot;:&quot;661564&quot;,&quot;vsvc_id&quot;:&quot;530789&quot;,&quot;connection&quot;:&quot;30345865319&quot;,&quot;tcpinfo_rtt&quot;:&quot;11000&quot;,&quot;ssl_protocol&quot;:&quot;-&quot;,&quot;remote_addr&quot;:&quot;118.89.230.123&quot;,&quot;remote_port&quot;:&quot;54234&quot;,&quot;time_local&quot;:&quot;13/Jul/2020:18:56:28 +0800&quot;,&quot;bytes_sent&quot;:&quot;12408&quot;,&quot;server_addr&quot;:&quot;154.8.188.184&quot;,&quot;protocol_type&quot;:&quot;http&quot;,&quot;ssl_handshake_time&quot;:&quot;-&quot;,&quot;upstream_connect_time&quot;:&quot;0.002&quot;,&quot;request_length&quot;:&quot;574&quot;,&quot;http_referer&quot;:&quot;https://jumpserver.domainold.com/&quot;,&quot;ssl_session_reused&quot;:&quot;-&quot;,&quot;server_port&quot;:&quot;1072&quot;,&quot;upstream_response_time&quot;:&quot;0.003&quot;,&quot;status&quot;:200,&quot;__TOPIC__&quot;:&quot;clb_api&quot;,&quot;__SOURCE__&quot;:&quot;100.98.178.58&quot;,&quot;__FILENAME__&quot;:&quot;access.log&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现域名变化了， 原因访问domainold.com的请求变成了访问domainnew.com的请求了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2020/06/29/2020/06/2020-06-29-%E5%B1%B1%E6%B5%B7%E7%BB%8F%E5%AF%86%E7%A0%81%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/29/2020/06/2020-06-29-%E5%B1%B1%E6%B5%B7%E7%BB%8F%E5%AF%86%E7%A0%81%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/index/" class="post-title-link" itemprop="url">山海经密码读书笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-29 08:00:00" itemprop="dateCreated datePublished" datetime="2020-06-29T08:00:00+08:00">2020-06-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:34" itemprop="dateModified" datetime="2023-05-26T15:06:34+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/talk/" itemprop="url" rel="index"><span itemprop="name">talk</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这本书很久以前读过一遍了，这次熊猫君推荐就又读了一遍，话说熊猫君的音频演绎真是一手绝活啊。不过避免被打扰了思绪，后面的我多半还是看文字，笔记不多就三条如下 <img src="/images/%E5%B1%B1%E6%B5%B7%E7%BB%8F%E5%AF%86%E7%A0%81.jpg"></p>
<p><strong>最喜欢的话</strong> 都雄魁道：“这个世界上，最没有说服力的就是谎话！这个道理，我三十年前就懂了。”</p>
<p><strong>最暧昧的关系</strong> 我捋一下藐姑射和江离师父祝宗人长的一样，因为他是被仇皇的师父以祝宗人肉体为模板复制的再导入洞天派传宗之发的，另外藐姑射杀了季丹将要成婚的老婆一家，然而藐姑射却是个男的。这样一来藐姑射肉体来源于太一宗和血宗的帮助，但心灵缺有所缺陷，虽然仇皇师父也擅长神裂，所以导致藐姑射有些疯狂，为了毁灭自己这个四不像和千年的苦痛，最终由他终极灭世最合理。</p>
<p><strong>最精巧的构思</strong> 作者套路深啊，雒灵虽然肉体被兵解了，但她早就练就了魂游物外所以马蹄重做了她的肉体他的灵魂回到肉体就复活了。雒灵复活后看到江丽灵魂溃散但肉身没有受到影响，所以手指一点江离眉心他就活过来了。江离一有了气息，川穹就能在至黑之地感应到因为他们本来就是一体的，所以能赶到昆仑之界，最后川穹又把他们带到人间。所以四宗关系错综复杂而又微妙，后来不破复活，燕其羽获得灵魂也就可想而知了，唯有羿老大之前答应了刑天的要求所以不会回来了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2020/06/11/2020/06/2020-06-11-gitlab%E9%80%9A%E8%BF%87%E6%8E%A7%E5%88%B6%E5%8F%B0%E9%87%8D%E7%BD%AE%E5%AF%86%E7%A0%81%E5%8F%8A%E8%A7%A3%E9%94%81%E7%94%A8%E6%88%B7/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/11/2020/06/2020-06-11-gitlab%E9%80%9A%E8%BF%87%E6%8E%A7%E5%88%B6%E5%8F%B0%E9%87%8D%E7%BD%AE%E5%AF%86%E7%A0%81%E5%8F%8A%E8%A7%A3%E9%94%81%E7%94%A8%E6%88%B7/index/" class="post-title-link" itemprop="url">Gitlab通过控制台重置密码及解锁用户</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-11 08:00:00" itemprop="dateCreated datePublished" datetime="2020-06-11T08:00:00+08:00">2020-06-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:34" itemprop="dateModified" datetime="2023-05-26T15:06:34+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>参考官方文档</strong> <a href="https://link.zhihu.com/?target=https://docs.gitlab.com/ee/security/reset_root_password.html">How to reset your root password</a> <a href="https://link.zhihu.com/?target=https://docs.gitlab.com/ee/security/unlock_user.html">How to unlock a locked user from the command line</a> <strong>操作背景</strong> Gitlab是Docker部署，Jenkins账号登陆不了，开始是怀疑密码不对，通过控制台登陆重置了密码，还是登陆不了，怀疑是Jenkins用户被锁住了（默认错误登陆超过10次会锁定），解锁后登陆成功。</p>
<p><strong>操作步骤</strong> <strong>1.登陆Gitlab所在容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@188-20 ~]# docker exec -it gitlab /bin/bash</span><br><span class="line">root@gitlab:/# ls</span><br><span class="line">RELEASE  bin   dev  home  lib64  mnt  proc  run   srv  tmp  var</span><br><span class="line">assets   boot  etc  lib   media  opt  root  sbin  sys  usr</span><br></pre></td></tr></table></figure>

<p><strong>2.登陆控制台</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@gitlab:/# gitlab-rails console production</span><br><span class="line">Loading production environment (Rails 4.2.10)</span><br></pre></td></tr></table></figure>

<p><strong>3.通过邮箱找到用户</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">irb(main):003:0&gt; user=User.where(email:&#x27;jenkins@domian.com&#x27;).first</span><br><span class="line">=&gt; #&lt;User id:12 @jenkins&gt;</span><br></pre></td></tr></table></figure>

<p><strong>4.修改密码并保存</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">irb(main):005:0&gt; user.password=12345678</span><br><span class="line">=&gt; 12345678</span><br><span class="line">irb(main):006:0&gt; user.password_confirmation=12345678</span><br><span class="line">=&gt; 12345678</span><br><span class="line">irb(main):007:0&gt; user.save!</span><br><span class="line">Enqueued ActionMailer::DeliveryJob (Job ID: 53d8c7ea-c523-43a1-a5e6-032c836f4870) to Sidekiq(mailers) with arguments: &quot;DeviseMailer&quot;, &quot;password_change&quot;, &quot;deliver_now&quot;, gid://gitlab/User/22</span><br><span class="line">=&gt; true</span><br></pre></td></tr></table></figure>

<p><strong>5.解锁用户</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">irb(main):012:0&gt; user=User.where(email:&#x27;jenkins@domain.com&#x27;).first</span><br><span class="line">=&gt; #&lt;User id:22 @jenkins&gt;</span><br><span class="line">irb(main):013:0&gt; user.unlock_access!</span><br><span class="line">=&gt; true</span><br><span class="line">irb(main):014:0&gt; </span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2020/06/09/2020/06/2020-06-09-%E4%B8%A4%E6%9D%A1%E5%91%BD%E4%BB%A4%E6%89%BE%E5%87%BA%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8E%A5%E5%8F%A3%E9%97%AE%E9%A2%98%E7%82%B9/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/09/2020/06/2020-06-09-%E4%B8%A4%E6%9D%A1%E5%91%BD%E4%BB%A4%E6%89%BE%E5%87%BA%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8E%A5%E5%8F%A3%E9%97%AE%E9%A2%98%E7%82%B9/index/" class="post-title-link" itemprop="url">两条命令找出第三方接口问题点</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-09 08:00:00" itemprop="dateCreated datePublished" datetime="2020-06-09T08:00:00+08:00">2020-06-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:34" itemprop="dateModified" datetime="2023-05-26T15:06:34+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/op/" itemprop="url" rel="index"><span itemprop="name">op</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a><strong>缘起</strong></h3><p>这几天疲于救火，火气有点儿大，今早领导在群里@我了下，说第三方反馈我们的网络有些问题。搞得我一头雾水，我首先问清了事情的原委，原来我们这边某个应用调用了第三方接口，但是应用这边时不时的会甩出那么几条错误，而且近期比较多。这不问题一多，大家就紧张了。为了自证清白，我不得不拿起武器自卫。</p>
<h3 id="措施"><a href="#措施" class="headerlink" title="措施"></a><strong>措施</strong></h3><p>思索了一会儿，既然对方说是网络的问题，那么我就从网络着手。解决网络问题莫过于经典的OSI七层模型了，根据我以往的经验排错用七层模型还是很靠谱的，只要定位了问题在那一层基本上问题就解决了一大半儿。就像一个牛人故事里面讲的那样：知道在哪儿画线和画一条线的价值相差天壤。所以找出问题的根源然后再去解决问题才能有正解。 下面直接上两条命令，没有铺垫，后续遇到类似问题还可以参考：</p>
<p><strong>1.首先确定TCP&#x2F;IP层有无问题</strong> 首先想的是ping这个命令，本来还想用traceroute,mtr的，但是对方做了些安全的屏蔽，所以没效果，幸亏ping没有屏蔽否则真说不清了。 ping效果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">64 bytes from 58.213.99.80: icmp_seq=626 ttl=51 time=33.5 ms</span><br><span class="line">64 bytes from 58.213.99.80: icmp_seq=627 ttl=51 time=33.6 ms</span><br><span class="line">64 bytes from 58.213.99.80: icmp_seq=628 ttl=51 time=33.5 ms</span><br><span class="line">^C</span><br><span class="line">--- api.domain.com ping statistics ---</span><br><span class="line">628 packets transmitted, 628 received, 0% packet loss, time 639851ms</span><br><span class="line">rtt min/avg/max/mdev = 33.484/33.608/36.531/0.235 ms</span><br></pre></td></tr></table></figure>

<p>看着还不错， 没有超时，ttl也算稳定，不过略大。北京到外地很少超过3000千米的，大多在2000千米内，20ms内才算优质。这里由ping命令可以判断TCP&#x2F;IP层没有问题。</p>
<p><strong>2.再看应用层主要是http&#x2F;https协议</strong> curl命令应该是首选，系统大多默认自带，使用方法多样，而且能从功能及性能两个层面来观察问题所在 先查看返回状态码，默认401还算正常因为没有加认证，但是多试几次就差点儿意思了，偶尔会出现503，代表后端处理不过来。这时基本上就发现了问题点儿，后端多半是集群可能是某个节点有问题，问题多半是处理到了瓶颈。 再看响应时间还是挺快的，进一步确认TCP&#x2F;IP层没有问题。就连出现503时相应时间依然挺快的，感觉可能是第三方这边可能做了优化，默认超过了一个比较小的响应时间这边就会返回一个503，不用等那么久，这一点儿还是很认可的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@188.18 ~]# curl -I https://api.domain.com/api</span><br><span class="line">HTTP/1.1 401 Unauthorized</span><br><span class="line">Server: nginx/1.16.1</span><br><span class="line">Date: Tue, 09 Jun 2020 04:11:40 GMT</span><br><span class="line">Content-Type: application/json;charset=utf-8</span><br><span class="line">Content-Length: 0</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">time_connect: 0.033</span><br><span class="line">time_starttransfer: 0.188</span><br><span class="line">time_total: 0.188</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@188.18 ~]# curl -I https://api.domain.com/api</span><br><span class="line">HTTP/1.1 503 Service Unavailable</span><br><span class="line">Server: nginx/1.16.1</span><br><span class="line">Date: Tue, 09 Jun 2020 04:11:41 GMT</span><br><span class="line">Content-Type: text/html;charset=iso-8859-1</span><br><span class="line">Content-Length: 355</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: must-revalidate,no-cache,no-store</span><br><span class="line"></span><br><span class="line">time_connect: 0.047</span><br><span class="line">time_starttransfer: 0.217</span><br><span class="line">time_total: 0.217</span><br></pre></td></tr></table></figure>

<h3 id="后续"><a href="#后续" class="headerlink" title="后续"></a><strong>后续</strong></h3><p>建议肯定是没有的，和他方合作，特别是一堆老师们，应该少说话，尽量别越界，把实事讲清楚就行。不用提建议，对方私下里肯定会改善的，毕竟这对人对己都是有好处的。 后续没有后续，做为运维，只要打好底子，就能从本质上去发现解决问题之道。他强任他强,清风拂山岗他横由他横明月照大江。好好的打磨打磨自己的内功，尽量使用最少的招数，解决最大的问题，达到四两拨千斤的效果。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2020/06/05/2020/06/2020-06-05-es%E9%9B%86%E7%BE%A47-3-2%E7%89%88%E6%9C%AC%E5%9C%A8%E7%BA%BF%E6%89%A9%E5%AE%B9data%E8%8A%82%E7%82%B9/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/05/2020/06/2020-06-05-es%E9%9B%86%E7%BE%A47-3-2%E7%89%88%E6%9C%AC%E5%9C%A8%E7%BA%BF%E6%89%A9%E5%AE%B9data%E8%8A%82%E7%82%B9/index/" class="post-title-link" itemprop="url">ES集群7.3.2版本在线扩容Data节点</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-05 08:00:00" itemprop="dateCreated datePublished" datetime="2020-06-05T08:00:00+08:00">2020-06-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:34" itemprop="dateModified" datetime="2023-05-26T15:06:34+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/op/" itemprop="url" rel="index"><span itemprop="name">op</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a><strong>背景</strong></h3><p>接到生产业务需求，需要在线扩容ES集群且不能影响数据安全性，经过对Elasticsearch角色的分析，发现直接扩容Data节点最简单而且能满足需求。 备注：原来ES集群3节点dim角色默认都开启了。</p>
<p><strong>原节点信息</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@188_33_centos ~]# curl 192.168.188.33:9200/_cat/nodes</span><br><span class="line">192.168.188.33 51 98 3 0.23 0.20 0.17 dim - es-33</span><br><span class="line">192.168.188.39 33 97 2 0.01 0.06 0.11 dim * es-39</span><br><span class="line">192.168.188.40 24 97 2 0.30 0.16 0.15 dim - es-40</span><br><span class="line">[root@188_33_centos ~]# curl 192.168.188.33:9200</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;es-33&quot;,</span><br><span class="line">  &quot;cluster_name&quot; : &quot;escluster&quot;,</span><br><span class="line">  &quot;cluster_uuid&quot; : &quot;mc5KtwBYSh-OHX5VdW3D8g&quot;,</span><br><span class="line">  &quot;version&quot; : &#123;</span><br><span class="line">    &quot;number&quot; : &quot;7.3.2&quot;,</span><br><span class="line">    &quot;build_flavor&quot; : &quot;default&quot;,</span><br><span class="line">    &quot;build_type&quot; : &quot;rpm&quot;,</span><br><span class="line">    &quot;build_hash&quot; : &quot;1c1faf1&quot;,</span><br><span class="line">    &quot;build_date&quot; : &quot;2019-09-06T14:40:30.409026Z&quot;,</span><br><span class="line">    &quot;build_snapshot&quot; : false,</span><br><span class="line">    &quot;lucene_version&quot; : &quot;8.1.0&quot;,</span><br><span class="line">    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,</span><br><span class="line">    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="在线扩容节点"><a href="#在线扩容节点" class="headerlink" title="在线扩容节点"></a><strong>在线扩容节点</strong></h3><p>备注：分别在新增节点es-87与es-135上执行如下操作。</p>
<p><strong>1.设置基本依赖Java环境</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@188-87-centos ~]# java -version</span><br><span class="line">java version &quot;1.8.0_171&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_171-b11)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.171-b11, mixed mode)</span><br></pre></td></tr></table></figure>

<p><strong>2.调整hosts信息</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@188-87-centos ~]# cat /etc/hosts</span><br><span class="line">192.168.188.33 es-33</span><br><span class="line">192.168.188.39 es-39</span><br><span class="line">192.168.188.40 es-40</span><br><span class="line">192.168.188.87 es-87</span><br><span class="line">192.168.188.135 es-135</span><br></pre></td></tr></table></figure>

<p><strong>3.安装elasticsearch</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@188-87-centos ~]# rpm -ivh elasticsearch-7.3.2-x86_64.rpm </span><br><span class="line">warning: elasticsearch-7.3.2-x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID d88e42b4: NOKEY</span><br><span class="line">Preparing...                          ################################# [100%]</span><br><span class="line">Creating elasticsearch group... OK</span><br><span class="line">Creating elasticsearch user... OK</span><br><span class="line">Updating / installing...</span><br><span class="line">   1:elasticsearch-0:7.3.2-1          ################################# [100%]</span><br><span class="line">### NOT starting on installation, please execute the following statements to configure elasticsearch service to start automatically using systemd</span><br><span class="line"> sudo systemctl daemon-reload</span><br><span class="line"> sudo systemctl enable elasticsearch.service</span><br><span class="line">### You can start elasticsearch service by executing</span><br><span class="line"> sudo systemctl start elasticsearch.service</span><br><span class="line">future versions of Elasticsearch will require Java 11; your Java version from [/usr/local/jdk/jre] does not meet this requirement</span><br><span class="line">Created elasticsearch keystore in /etc/elasticsearch</span><br></pre></td></tr></table></figure>

<p><strong>4.修改Node节点配置文件</strong></p>
<p>参考之前节点配置文件，这里只需要修改node.name、network.host即可，其他保持不变。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@188-87-centos elasticsearch]# cat elasticsearch.yml </span><br><span class="line">cluster.name: escluster</span><br><span class="line">node.name: es-87</span><br><span class="line">node.master: false</span><br><span class="line">node.data: true </span><br><span class="line">path.data: /data1/esdata</span><br><span class="line">path.logs: /data1/eslog</span><br><span class="line">network.host: 192.168.188.87</span><br><span class="line">http.port: 9200</span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;192.168.188.33:9300&quot;,&quot;192.168.188.39:9300&quot;, &quot;192.168.188.40:9300&quot;]</span><br><span class="line">cluster.initial_master_nodes: [&quot;es-33&quot;,&quot;es-39&quot;,&quot;es-40&quot;]</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure>

<p><strong>5.设置目录权限</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@188_87_centos elasticsearch]# mkdir /data1/&#123;esdata,eslog&#125;</span><br><span class="line">[root@188_87_centos elasticsearch]# chown elasticsearch:elasticsearch /data1/esdata</span><br><span class="line">[root@188_87_centos elasticsearch]# chown elasticsearch:elasticsearch /data1/eslog</span><br><span class="line">[root@188_87_centos elasticsearch]# ls -lh /data1/</span><br><span class="line">total 8.0K</span><br><span class="line">drwxr-xr-x 2 elasticsearch elasticsearch 4.0K Jun  5 10:22 esdata</span><br><span class="line">drwxr-xr-x 2 elasticsearch elasticsearch 4.0K Jun  5 10:22 eslog</span><br></pre></td></tr></table></figure>

<p><strong>6.启动Node节点</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@188-87-centos elasticsearch]# systemctl enable elasticsearch.service </span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/elasticsearch.service to /usr/lib/systemd/system/elasticsearch.service.</span><br><span class="line">[root@188-87-centos elasticsearch]# systemctl start elasticsearch</span><br><span class="line">[root@188-87-centos elasticsearch]# systemctl status elasticsearch</span><br><span class="line">● elasticsearch.service - Elasticsearch</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/elasticsearch.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Fri 2020-06-05 10:25:13 CST; 5s ago</span><br><span class="line">     Docs: http://www.elastic.co</span><br><span class="line"> Main PID: 17417 (java)</span><br><span class="line">   CGroup: /system.slice/elasticsearch.service</span><br><span class="line">           ├─17417 /usr/share/elasticsearch/jdk/bin/java -Xms3g -Xmx3g -XX:+UseConcMarkSweepG...</span><br><span class="line">           └─17513 /usr/share/elasticsearch/modules/x-pack-ml/platform/linux-x86_64/bin/contr...</span><br><span class="line"></span><br><span class="line">Jun 05 10:25:13 188-87-centos systemd[1]: Started Elasticsearch.</span><br><span class="line">Jun 05 10:25:13 188-87-centos systemd[1]: Starting Elasticsearch...</span><br><span class="line">Jun 05 10:25:14 188-87-centos elasticsearch[17417]: OpenJDK 64-Bit Server VM warning: Opti...e.</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span><br></pre></td></tr></table></figure>

<p><strong>7.检查集群情况</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@188_33_centos elasticsearch]# curl 192.168.188.33:9200/_cat/nodes</span><br><span class="line">192.168.188.40  23 98 4 0.40 0.19 0.15 dim - es-40</span><br><span class="line">192.168.188.87   9 98 5 0.89 0.44 0.20 di  - es-87</span><br><span class="line">192.168.188.33  57 98 7 0.17 0.22 0.21 dim - es-33</span><br><span class="line">192.168.188.39  31 98 3 0.29 0.17 0.15 dim * es-39</span><br><span class="line">192.168.188.135  9 63 0 0.27 0.10 0.07 di  - es-135</span><br><span class="line">[root@188_33_centos elasticsearch]# curl 192.168.188.33:9200/_cluster/health?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;cluster_name&quot; : &quot;escluster&quot;,</span><br><span class="line">  &quot;status&quot; : &quot;green&quot;,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;number_of_nodes&quot; : 5,</span><br><span class="line">  &quot;number_of_data_nodes&quot; : 5,</span><br><span class="line">  &quot;active_primary_shards&quot; : 45,</span><br><span class="line">  &quot;active_shards&quot; : 90,</span><br><span class="line">  &quot;relocating_shards&quot; : 2,</span><br><span class="line">  &quot;initializing_shards&quot; : 0,</span><br><span class="line">  &quot;unassigned_shards&quot; : 0,</span><br><span class="line">  &quot;delayed_unassigned_shards&quot; : 0,</span><br><span class="line">  &quot;number_of_pending_tasks&quot; : 0,</span><br><span class="line">  &quot;number_of_in_flight_fetch&quot; : 0,</span><br><span class="line">  &quot;task_max_waiting_in_queue_millis&quot; : 0,</span><br><span class="line">  &quot;active_shards_percent_as_number&quot; : 100.0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>弄清Elasticsearch节点类型，这里主要用到Master节点、 Data节点、 Ingest节点。 主节点负责管理整个集群。它管理所有节点的状态，并周期性地将集群状态同步到集群中的所有其他节点，通知大家有什么新节点加入了集群，有什么节点脱离了集群。主节点会定期向所有其他节点发送ping消息，以此判断它们是否正常存活（别的节点也会向主节点发送ping消息）。主节点的重要任务之一是配置管理。它管理着全部元数据，以及集群中所有索引的映射。 数据节点负责保存数据、段合并和执行查询。数据节点是集群中真正承担工作任务的地方，因此服务器的配置应该比集群中的其他节点高。 数据处理管道由一到多个ingest节点组成，由ingest节点负责每个环节的处理。依ingest节点要处理的任务不同，它们可能会需要很多资源，因此有时候需要在集群中指定专用的ingest节点。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2020/06/04/2020/06/2020-06-04-%E8%8B%8F%E4%B8%96%E6%B0%91%E7%9A%8425%E6%9D%A1%E5%B7%A5%E4%BD%9C%E5%92%8C%E7%94%9F%E6%B4%BB%E5%8E%9F%E5%88%99/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/04/2020/06/2020-06-04-%E8%8B%8F%E4%B8%96%E6%B0%91%E7%9A%8425%E6%9D%A1%E5%B7%A5%E4%BD%9C%E5%92%8C%E7%94%9F%E6%B4%BB%E5%8E%9F%E5%88%99/index/" class="post-title-link" itemprop="url">苏世民工作生活人生投资管理原则信条法则六十条</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-04 08:00:00" itemprop="dateCreated datePublished" datetime="2020-06-04T08:00:00+08:00">2020-06-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:34" itemprop="dateModified" datetime="2023-05-26T15:06:34+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/method/" itemprop="url" rel="index"><span itemprop="name">method</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/method/financial/" itemprop="url" rel="index"><span itemprop="name">financial</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://pic2.zhimg.com/v2-556804531a75dfc257c262e6df00d72f_1200x500.jpg"><img src="/images/v2-556804531a75dfc257c262e6df00d72f_1200x500.jpg"></a> <strong>摘自《苏世民：我的经验与教训》，是一部由苏世民所著的投资、管理类图书，2020年于中信出版社出版发行。</strong></p>
<p><strong>作者简介</strong> 苏世民（Stephen A. Schwarzman），全球私募巨头黑石集团联合创始人、董事会主席、首席执行官，耶鲁大学学士，哈佛大学商学院工商管理硕士。他与彼得·彼得森以40万美元创建黑石集团，并将其发展为华尔街真正的私募之王。</p>
<p><strong>25条工作和生活原则</strong></p>
<ol>
<li>大事和做小事的难易程度是一样的。所以要选择一个值得追求的宏伟目标，让回报与你的努力相匹配。</li>
<li>优秀的高管不是天生的，而是后天磨砺的结果。他们好学不倦，永无止境。要善于研究你生活中取得巨大成功的人和组织，他们能够提供关于如何在现实世界获得成功的免费教程，可以帮助你进行自我提升。</li>
<li>你敬佩的人写信或打电话，请他们提供建议或与其会面的机会。你永远不知道谁愿意跟你见面。最后你会从这些人身上学到很多重要的东西，建立你在余生都可以享用的人际关系。在生命早期结交的人，会与你缔结非同寻常的感情纽带。</li>
<li>们总觉得最有意思的话题就是与自己相关的话题。所以，要善于分析他人的问题所在，并尝试提出办法来帮助他人。几乎所有的人，无论他声名多么显赫、地位多么高贵，都愿意接受新的想法，当然，前提是这些想法必须经过深思熟虑。</li>
<li>个企业都是一个封闭的集成系统，内部各个组成部分性能独特却又相互关联。优秀的管理者既洞悉每个部分如何独立运行，也熟知各部分之间如何相互协作。</li>
<li>息是最重要的商业资产。掌握得越多，拥有的视角就越多，在竞争对手面前就越有可能发现常规模式和异常现象。所以要始终对进入企业的新鲜事物保持开放的态度，无论是新的人、新的经验，还是新的知识。</li>
<li>年轻的时候，请接受能为自己提供陡峭的学习曲线和艰苦的磨炼机会的工作。最初的工作是为人生打基础的，不要为了暂时的声望而轻易地接受一份工作。</li>
<li>展示自己时，请记住，印象非常重要。整体形象必须毫无瑕疵。其他人会通过各种线索和端倪，判断你的真实面貌。所以，要重诺守时，要真实诚信，要准备充分。</li>
<li>聪明的人也不能解决所有问题。聪明人组成的开诚布公的团队却可以无往而不利。</li>
<li>处于困境中的人往往只关注自己的问题，而解决问题的途径通常在于你如何解决别人的问题。</li>
<li>一个人的信念必须超越自我和个人需求，它可以是自己的公司、祖国或服役义务。任何因信念和核心价值观的激励而选择的挑战都是值得的，无论最终的结果是成功还是失败。</li>
<li>永远要黑白分明、百折不回。你的诚信必须要毋庸置疑。当一个人不需要付出代价或承担后果的时候，坚持做正确的事情并非难事。但当必须得放弃一些东西时，你就很难保持信用记录。要始终言而有信，不要为了自己的利益误导任何人。</li>
<li>要勇往直前。成功的企业家、经理和个人都是具有志在必得的气魄和一往无前的精神的人。他们会在恰当的时刻当仁不让。当其他人谨小慎微时，他们会接受风险；当其他人瞻前顾后时，他们会采取行动，但他们会选择明智的做法。这种特质是领导者的标志。</li>
<li>永远不要骄傲自满。没有什么是一成不变的。无论是个人还是企业，如果不经常寻求自我重塑和自我改进的方法，就会被竞争对手打败。尤其是组织，因为组织比想象中更脆弱。</li>
<li>极少有人能在首次推介中完成销售。仅仅因为你对一些事物有信念，并不意味着其他人也愿意接受。你需要能够一次又一次坚定地推销你的愿景。大多数人不喜欢改变，所以你需要说服他们为什么要接受改变。不要因为畏惧而不去争取自己想得到的东西。</li>
<li>如果你看到一个巨大的变革性机会，不要疑虑其他人为什么没有采取行动。你可能看到了他人没有看到的东西。问题越严峻，竞争就越有限，对问题解决者的回报就越大。</li>
<li>归根到底，成功就是抓住了寥寥可数的机遇。要始终保持开放的思维，冷静观察，高度警觉，随时准备抓住机会。要统筹合适的人力和其他资源，然后全力以赴。如果你没有准备好拼尽全力，要么是因为这个机会没有你想象的那么有吸引力，要么是因为你不是把握这一机遇的合适人选。</li>
<li>时间会对所有交易造成负面影响，有时甚至产生致命影响。一般情况下，等待的时间越久，意料之外的事情就越多。特别是在艰难的谈判中，要让所有人都在谈判桌上协商足够长的时间，以此达成协议。</li>
<li>不要赔钱！！！客观地评估每个机会的风险。</li>
<li>要在准备好时做出决定，而不是在压力之下。或为了达到个人目的，或因为内部政治斗争，或因为一些外部需求，其他人总会催促你做出决策。但几乎每次你都可以这么说：“我需要更多的时间来考虑这个问题。我想清楚了再回复你。”即使是在最艰难、最令人不快的情况下，这种策略也非常有效。</li>
<li>忧虑是一种积极的心理活动，可以开阔人的思路。如果能正确引导这一情绪，你就可以洞察任何形势下的负面风险，并采取行动规避这些风险。</li>
<li>失败是一个组织最好的老师。开诚布公地客观谈论失败，分析问题所在，你就会从失败中学到关于决策和组织行为的新规则。如果评估得当，失败就有可能改变一个组织的进程，使其在未来更加成功。</li>
<li>尽可能雇用10分人才，因为他们会积极主动地感知问题、设计解决方案，并朝着新方向开展业务。他们还会吸引和雇用其他10分人才。10分人才做什么事都会得心应手。</li>
<li>如果你认为一个人的本质是好的，就要随时为这个人提供帮助，即使其他人都离他而去。任何人都可能陷入困境。在别人需要的时候，一个偶然的善意行为就会改变他的生命轨迹，造就意想不到的友谊或忠诚。</li>
<li>每个人都有梦想。尽你所能帮助别人实现他们的目标。</li>
</ol>
<p><strong>苏世民成功人生的十大信条</strong> 1. 卓越成就&#x3D;原则+经验+教训+做法。 2. 有意义的人生&#x3D;创造出人意料、影响深远的新事物。 3. 成功的秘密：发现机会、抓住机会、永不言弃。 4. 面对问题时，要勇于挑战权威、挑战等级制度。 5. 忧虑是一种积极的心理活动，它可以开阔人的思路。 6. 人生有无限可能，你可以成为你想成为的任何人，做成你想做的任何事。 7. 了解问题的角度越多，越接近问题的答案。问题越困难，解决方案越少，你的建议就越有价值。 8. 追求卓越的人往往对学习充满热情，孜孜以求，他们善于提问、勤于思考，能够敏锐地捕捉到想法之间的联系，从不失手。 9. 成功就是充分利用那些你无法预测的罕见的机会，但抓住这些机会的前提是你必须时刻保持开放的思维、高度的警觉和严阵以待的姿态，并愿意接受重大变革。 10. 有时现实与自己想象的生活和事业之间存在巨大差距，这一差距会压得人喘不过气，几乎令人绝望。人们往往只能看到成功的光环或是失败的黯淡，却忽视那些可能彻底改变人生轨迹的转折点，可正是在这些转折点上，我们学到了事业和人生中最重要的经验和教训。</p>
<p><strong>苏世民成功投资的十五条法则</strong> 1. 充分使用手中的一切工具是投资的关键。 2. 在金融界，突如其来的运气逆转，一笔糟糕交易，一笔不良投资，都可能将你击垮。 3. 打造多样化的业务类型以应对市场的竞争和变故。 4. 在寻找投资人的过程中，投资人的决策难度越低，各方获得的利益越大。 5. 在充满变化和高压的投资环境中，启动和管理变化是衡量成功与否的标准。 6. 为了排除投资流程中的个人因素和风险因素，要鼓励群策群力、增强集体责任感。 7. 时间会对所有交易产生负面影响。等待的时间越长，越有可能出现意料之外的棘手事件。 8. 洞察模式、研究新型解决方案、打造新模型，加上锲而不舍的意志力，一切想法都能变为现实。 9. 如何面对压力？（1）客观、理性地认识眼前形势。（2）屏蔽其他所有内容，只关注交易要点。（3）花点时间让自己舒缓下来，倾听者不介意多花一点时间。 10. 企业需要摒弃“单人决策”的做法，审查并收紧企业流程，制定规则来剔除投资流程中的个人化因素。 11. 额外的付出一定会换来意外的收获，并将逐渐变成一种志在必得的信念，一种锲而不舍的精神，这些会在投资过程中成为取之不尽、用之不竭的无形资产。 12. 杠杆收购中投资者采取的运营改进措施包括：提高制造、能源利用和采购效率，投产新的产品线，拓展新的市场，技术升级以及提升公司管理团队的领导水平。 13. 杠杆收购有三件事情令人印象深刻：（1）无论经济环境如何，杠杆收购都可以从经常性费用和投资利润中收集资产、赚取收入。（2）你可以通过杠杆收购真正改善你所收购的公司。（3）可以赚大钱。 14. 投资的首要原则是：不——要——赔——钱！为了反映这一基本原则，需要创建一个投资流程，并随着时间推移不断完善这一流程。需要打造一个极为可靠的风险评估框架。需要为公司内部的专业人士提供培训，教他们如何把每个投资机会提炼为两个或三个主要变量，这些变量将决定投资能否成功、能否创造价值。投资决策的核心在于程序严格、冷静稳健的风险评估。这不仅是一个流程，更是一种思维方式。 15. 任何投资的成功与否在很大程度上取决于所处经济周期的节点。周期会对企业的成长轨迹、估值及潜在回报率造成重大影响。周期最终是由各种各样的供需因素决定的。理解这些供需因素，对其进行量化分析，就可以很好地确定你与市场离顶部或底部的距离。</p>
<p><strong>苏世民带领黑石走向巅峰的十大管理原则</strong> 1. 坚持成长就要不断提出问题，预测事件、审时度势，主动寻求进步和变革。 2. 优秀的企业文化兼具规模优势和小公司的灵魂，员工可以自由表达想法。 3. 不断创新，才能永远不被淘汰。 4. 为了取得成功，你必须有勇气打破边界，进军自己无权进入的行业和领域。 5. 谨慎做出决策：每一个微小的行为都有可能对其他人造成深远的影响，无论好坏。 6. 对企业进行精英管理，追求卓越、保持开放、坚守诚信，并竭力聘用拥有同样信念的人。 7. 创业的三项基本测试：你的设想必须足够宏大，企业的产品或服务应该是独一无二的，时机必须是正确的。 8. 企业的一切要素都相互关联。企业如果要取得成功，那么每一个部门既需要独立运转，又需要与其他部门顺利协作。系统中任何一环出现问题都有可能造成亏损或破产。 9. 创业的重要结论：创立和运营小企业的难度和大企业相差无几。一个企业的创立，无论规模大小，都有一个从无到有的过程，你会承受相同的经济负担和心理压力。筹集资金并找到合适人才的难度也同样大。在同样的困难和压力面前，要确保创业成功，唯一的办法就是全身心的投入。 10. 企业“八九十”人才观：得8分的人是任务执行者，得9分的人非常擅长执行和制订一流策略。如果公司都是9分人才，就可以获得成功。但10分人才，无须得到指令，就能主动发现问题、设计解决方案，并将业务推向新的方向。10分人才能够为企业带来源源不断的收益。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2020/05/30/2020/05/2020-05-30-1699/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/30/2020/05/2020-05-30-1699/index/" class="post-title-link" itemprop="url">运维的境界</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-05-30 08:00:00" itemprop="dateCreated datePublished" datetime="2020-05-30T08:00:00+08:00">2020-05-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:34" itemprop="dateModified" datetime="2023-05-26T15:06:34+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/op/" itemprop="url" rel="index"><span itemprop="name">op</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="引子"><a href="#引子" class="headerlink" title="引子"></a><strong>引子</strong></h3><p>怎么说我也算个出道十年的运维老兵，连笔记在<a target="_blank" rel="noopener" href="https://blog.51cto.com/jerrymin" title="技术博客">技术博客</a>上也做了九年了，可是最近与一位业外人士交流时怎么都不能用大白话讲清楚运维具体是做什么的？</p>
<p>为此我懊恼了一小会儿，后来又反省并做了下功课发现我之所以不会用大白话不会用打比方的方式告诉业外人士运维到底是干什么的，主要原因是我没有洞察运维的本质。关于为啥没有洞察运维的本质主要原因可能是对运维不够热爱没有全身心的投入吧。</p>
<p>虽然今天依然没有洞察运维的本质，但是在这里还是乐意分享一点儿对运维的思考。</p>
<h3 id="关于运维"><a href="#关于运维" class="headerlink" title="关于运维"></a><strong>关于运维</strong></h3><ul>
<li><p>关于运 运本义为移动、运行；引申义为运转、转动，挥动、搬运。由运转还引申出命运、气数等抽象意义。比如天下可运于掌。——《孟子·梁惠王上》</p>
</li>
<li><p>关于维 维本义是系物的大绳。引申义为维系，维持。比如四方是维。——《诗·小雅·节南山》</p>
</li>
<li><p>关于运维 百度百科上是这样解释运维的：运维，本质上是对网络、服务器、服务的生命周期各个阶段的运营与维护，在成本、稳定性、效率上达成一致可接受的状态。</p>
</li>
</ul>
<p>由上可以推出公司的正常运行与持续发展离不开运维，另外从公司的人员划分来讲运维人员与其他人员比例大概是1：100，也就是说1个运维人员至少要服务100个其他人员。这么重要的岗位却需要这么少的人员，可见运维的性价比何其高也。这也导致了大多数公司对运维的忽视，从而也决定了公司发展的高度。</p>
<h3 id="关于境界"><a href="#关于境界" class="headerlink" title="关于境界"></a><strong>关于境界</strong></h3><ul>
<li><p>冯友兰“人生四境界” 冯友兰提出人生四大境界：“自然境界”，混沌未开；“功利境界”，为己为利；“道德境界”为人为公；“天地境界”万物皆备于我，我与宇宙同一。</p>
</li>
<li><p>王国维“治学三境界” 王国维在《人间词话》中说，古今之成大事业、大学问者，必经过三种之境界： “昨夜西风凋碧树，独上高楼，望尽天涯路。” 此第一境也； “ 衣带渐宽终不悔，为伊消得人憔悴。” 此第二境也； “ 众里寻他千百度，蓦然回首，那人却在，灯火阑珊处。”此第三境也。</p>
</li>
<li><p>禅宗“三见山” 唐代禅宗大师青原行思语：老僧三十年前未参禅时，见山是山，见水是水。及即至后来，亲见知识，有个入处；见山不是山，见水不是水。而今得个休歇处，依前见山只是山，见水只是水。</p>
</li>
<li><p>习武“三阶段” 王家卫导演的电影《一代宗师》中宫二语：我爹常说，习武之人有三个阶段：见自己，见天地，见众生。我见过自己，也算见过天地，可惜见不到众生。这条路我没走完，希望你能把它走下去。</p>
</li>
</ul>
<p>从上可知，不管是搞哲学、治学、修禅还是习武都得讲究个阶段，要不然格局上不来，格局上不来境界自然也高不了。那么对搞运维的来说是否也有阶段或者境界呢？答案是显然的。</p>
<h3 id="运维的境界"><a href="#运维的境界" class="headerlink" title="运维的境界"></a><strong>运维的境界</strong></h3><p>这里先从运维的岗位为切入点来谈起，当我们浏览招聘网站搜索运维岗位，从偏技术的角色来看大多是这些：运维工程师、中级运维工程师、高级运维工程师、资深运维工程师、运维专家；从偏管理角色来看大多是这些：运维主管、运维经理、高级运维经理、运维总监。</p>
<p>所以从岗位来看不管是偏技术还是偏管理基本上运维专家与运维总监是运维人员的天花板了。那对从事运维职业的人员来说，运维专家或者运维总监就是到头了呢？愚以为不是的。虽然岗位有终点，但境界无止境。下面是我思考得出的运维的三个境界：</p>
<ul>
<li><p>为他人 运维日常处理需求、输出参考意见、乃至救火等等表面上都是给他人提供服务的，然后年终考核也多要参考他人对运维的评价，然后很自然的运维也以服务人员自居，所以这一阶段基本上所有运维人员都能达到。 关于怎样才能很好的为他人提供服务，可以参考我之前的思考<a target="_blank" rel="noopener" href="https://minminmsn.com/op/212/" title="《关于金刚经在运维开发中的实践》">《关于金刚经在运维开发中的实践》</a>， 其核心就是讲运维就是服务，服务就是布施，布施又是六度波罗蜜第一条，所有想修行为他人服务真的很重要。何况我们又是有偿服务，所以这条达不到肯定成不了一个好运维。</p>
</li>
<li><p>为自己 《古之学者为己，今之学者为人》出自《论语·宪问》。这里为自己是相对于上面的为他人，一个是里子一个是面子。救火英雄固然人人叫好，但我以为无名英雄更值得令人敬佩。这里的为自己是苦练技术内功，并耐得住寂寞，这样才能防范于未然。就好比大多数人都能做到从0到1，但是从0到0，谁又能坚持得下来呢？我们知道技术更新迭代的速度估计比你喜新厌旧的速度还快，在如此竞争激烈的环境中如果过多的浮于表面，沉淀不下去最终吃亏的还是自己。所以要为自己，就得自我精进。另外为自己的初衷也是为了能更好的为他人服务，最终达到表里如一知行合一的境界。</p>
</li>
<li><p>为无为 《为无为，事无事，味无味》出自老子的《道德经》第六十三章。这里强调运维此阶段当有了文化，产生了信仰，大家在制定的规则文化下自驱的去运转与维持，最终淡化了运维对公司的影响，必要时也有可能消灭了运维，但又有种运维无处不在的感觉。</p>
</li>
</ul>
<h3 id="画外音"><a href="#画外音" class="headerlink" title="画外音"></a><strong>画外音</strong></h3><p>马老师说过每个行业做到极致，都是艺术家。这里套用到每个职业上也应该适用吧。最后还回到运维岗位上来？试问那家公司有运维科学家或者运维艺术家这个岗位？如果有那么这家公司当知运维的真谛，从而也给运维的天花板定的足够高，运维在这里当大有作为。当然话说回来如果没有这样的公司，自己努力提升自己的阶段或境界也是挺好的。</p>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a><strong>参考文献</strong></h3><ul>
<li>《百度百科》</li>
<li>《中国哲学简史》</li>
<li>《人间词话》</li>
<li>《五灯会元》</li>
<li>《一代宗师》</li>
<li>《金刚经》</li>
<li>《论语》</li>
<li>《道德经》</li>
<li>《DevOps实践指南》</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2020/05/24/2020/05/2020-05-24-%E6%88%91%E5%AF%B9%E6%A0%BC%E7%89%A9%E8%87%B4%E7%9F%A5%E7%9A%84%E6%A0%BC%E8%87%B4/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/24/2020/05/2020-05-24-%E6%88%91%E5%AF%B9%E6%A0%BC%E7%89%A9%E8%87%B4%E7%9F%A5%E7%9A%84%E6%A0%BC%E8%87%B4/index/" class="post-title-link" itemprop="url">我对格物致知的格致</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-05-24 08:00:00" itemprop="dateCreated datePublished" datetime="2020-05-24T08:00:00+08:00">2020-05-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:34" itemprop="dateModified" datetime="2023-05-26T15:06:34+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/confucian/" itemprop="url" rel="index"><span itemprop="name">confucian</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="格物致知的来源"><a href="#格物致知的来源" class="headerlink" title="格物致知的来源"></a><strong>格物致知的来源</strong></h3><blockquote>
<p>《礼记·大学》：“古之欲明德于天下者，先治其国；欲治其国者，先齐其家；欲齐其家者，先修其身；欲修其身者，先正其心；欲正其心者，先诚其意；欲诚其意者，先致其知，致知在格物。物格而后知至，知至而后意诚，意诚而后心正，心正而后身修，身修而后家齐，家齐而后国治，国治而后天下平。”</p>
</blockquote>
<p>可惜的是关于格物致知更多的内容《礼记·大学》没有记载，不知道是失传了还是曾子（朱子说本书是曾子所作，也有清代学者认为汉儒所作，这里沿用朱子的观点）忽略了。 由于只有寥寥几句话，所以导致“格物致知” 的真正意涵已是儒学思想史上的千古之谜。从最早为《大学》作注的东汉郑玄，一直到现代的儒学学者，已经争论了一千余年，至今仍无定论。 所以本文注定说不出什么来，只能证明本人曾经读过这段话并做了下笔记而已。虽如此，还是乐意之至的，不为无益之事，何以遣有涯之生？</p>
<h3 id="格物致知现在的含义"><a href="#格物致知现在的含义" class="headerlink" title="格物致知现在的含义"></a><strong>格物致知现在的含义</strong></h3><p>清朝末年，西学东传，其中物理学著作在1900年以前并没有采用“物理学”的译法，而是多译为“格物学”或“格致学”。例如京师同文馆第一个将近代物理学列入学校课程，当时开设的格致（亦称格物或格物学），即物理与化学的统称。 “格物学”或“格致学”就是“physics”的早期汉语意译。这两种译法是“格物知”一词两种形式的缩写。而“格物致知”一词源于儒家“致知在格物，格物而后知至”的思想。 但是经过近百年发展，最终在命名上物理学还是取代了格致学。如果还是把物理学翻译为格致学，那就是经典与现代接轨了，现代人就更方便理解格物致知了。</p>
<h3 id="古人是怎样理解格物知识的"><a href="#古人是怎样理解格物知识的" class="headerlink" title="古人是怎样理解格物知识的"></a><strong>古人是怎样理解格物知识的</strong></h3><blockquote>
<p><strong>郑玄</strong>：“格，来也。物、犹事也。其知于善深，则来善物。其知于恶深，则来恶物。言事缘人所好来也。此致或为至。” <strong>程颢</strong>：“格、至也。穷理而至于物，则物理尽。” <strong>程颐</strong>：“格犹穷也﹐物犹理也﹐犹曰穷其理而已也。穷其理然后足以致之，不穷则不能致也。” <strong>朱熹</strong>；“格，至也。物，犹事也。穷推至事物之理，欲其极处无不到也。”“所谓致知在格物者，言欲致吾之知，在即物而穷其理也。” <strong>陆九渊</strong>：“天之与我者，即此心也。人皆有是心，心皆有是理，心即理也。” <strong>王阳明</strong>：“格物即格心。”“格君心致良知” <strong>藕益智旭</strong>：“格物者，作唯心识观，了知天下国家，根身器界，皆是自心中所现物，心外别无他物也。” <strong>憨山德清</strong>：“物即外物，一向与我作对者，乃见闻知觉视听言动所取之境。知即真知，乃自体本明之智光。”格即禹格三苗之格。谓我以至诚感通，彼即化而归我。所谓至诚贯金石，感豚鱼，格也。“物化为知，与我为一，其为感格之格。” <strong>丁肇中</strong>：“不管研究自然科学，研究人文科学，或者在个人行动上，我们都要保留一个怀疑求真的态度，要靠实践来发现事物的真相。在环境激变的今天格物致知真正的意义有两个方面：第一，寻求真理的惟一途径是对事物客观的探索；第二，探索的过程不是消极的袖手旁观，而是有想像力的有计划的探索。”</p>
</blockquote>
<p>由上可知，不同的人理解的不仅不一样而且有的还相差十万八千里。看来由古推古也不一定能找到真相，不过古人注释古书，多少有借古人的话来宣传自己的学说之嫌，只是有人含蓄有人直接而已。譬如陆九渊不是公然说“学苟知本，六经皆我注脚”嘛。古人善假于物，他们表面上是注解经书，实际上也可能是拿经书注解自己啊。</p>
<h3 id="我所理解的格物致知"><a href="#我所理解的格物致知" class="headerlink" title="我所理解的格物致知"></a><strong>我所理解的格物致知</strong></h3><p>愚以为，“格物致知”就是把事物的始终、本末搞清楚，知道其中先后因果关系。怎样去格物致知呢，这里我用王阳明特别强调《孙子兵法》中的这句“校之以计而索其情”来作答。什么意思呢？就是先提出预案假设，然后去实践反馈，最终得出真知灼见。通俗的讲就是实践是认识的唯一源泉（实践不一定出真知哦，出真知需要下足功夫的）。</p>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a><strong>参考文献</strong></h3><blockquote>
<p>《百度百科》 《礼记·大学》郑玄注 《明道先生文集》 《伊川先生文集》 《四书章句集注》 《象山先生全集》 《阳明先生全集》 《憨山老人梦游集》 《忆云词甲乙丙复丁稿》 《荀子·劝学》 《孙子兵法》 《国学常识》 《应有格物致知精神》</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jerry Min</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">260</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jerry Min</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
