<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"minminmsn.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="最近把Elastic Stack从5.2.2版本升级到6.0.0版本，性能确实有所提高，文档记录了升级过程中需要注意的一些问题。  架构图   一、Filebeat6.0版本filebeat prospectors中的document_type被禁用,原来的topic: ‘%{[type]}’获取文档类型的方式不可用，但是引入了fields，后面映射模板也会用到。 1、document_type:">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticStack5.2.2升级到6.0.0注意事项">
<meta property="og:url" content="https://minminmsn.github.io/2018/11/09/2018/11/2018-11-09-elasticstack5-2-2%E5%8D%87%E7%BA%A7%E5%88%B06-0-0%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/index/index.html">
<meta property="og:site_name" content="MinMinMsn">
<meta property="og:description" content="最近把Elastic Stack从5.2.2版本升级到6.0.0版本，性能确实有所提高，文档记录了升级过程中需要注意的一些问题。  架构图   一、Filebeat6.0版本filebeat prospectors中的document_type被禁用,原来的topic: ‘%{[type]}’获取文档类型的方式不可用，但是引入了fields，后面映射模板也会用到。 1、document_type:">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://minminmsn.github.io/images/architecture.png">
<meta property="article:published_time" content="2018-11-09T00:00:00.000Z">
<meta property="article:modified_time" content="2023-05-26T07:06:29.571Z">
<meta property="article:author" content="Jerry Min">
<meta property="article:tag" content="elasticsearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://minminmsn.github.io/images/architecture.png">

<link rel="canonical" href="https://minminmsn.github.io/2018/11/09/2018/11/2018-11-09-elasticstack5-2-2%E5%8D%87%E7%BA%A7%E5%88%B06-0-0%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/index/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>ElasticStack5.2.2升级到6.0.0注意事项 | MinMinMsn</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">MinMinMsn</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://minminmsn.github.io/2018/11/09/2018/11/2018-11-09-elasticstack5-2-2%E5%8D%87%E7%BA%A7%E5%88%B06-0-0%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jerry Min">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MinMinMsn">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ElasticStack5.2.2升级到6.0.0注意事项
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-09 08:00:00" itemprop="dateCreated datePublished" datetime="2018-11-09T08:00:00+08:00">2018-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 15:06:29" itemprop="dateModified" datetime="2023-05-26T15:06:29+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>最近把Elastic Stack从5.2.2版本升级到6.0.0版本，性能确实有所提高，文档记录了升级过程中需要注意的一些问题。</strong></p>
<hr>
<h3 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a><strong>架构图</strong></h3><blockquote>
<p><img src="/images/architecture.png"></p>
</blockquote>
<h3 id="一、Filebeat"><a href="#一、Filebeat" class="headerlink" title="一、Filebeat"></a><strong>一、Filebeat</strong></h3><p>6.0版本filebeat prospectors中的document_type被禁用,原来的topic: ‘%{[type]}’获取文档类型的方式不可用，但是引入了fields，后面映射模板也会用到。 1、document_type: yewuname 原来的Index名字为filebeat-yewuname-2018.01.19这样的按照天分割的，升级后document_type不支持了，需要修改为字段加type的形式如下fields: document_type: yewuname 2、输出kafka也需要修改topic: ‘%{[fields.document_type]}’ 3、logstash生成index也需要由原来的index &#x3D;&gt; “filebeat-%{type}-%{+YYYY.MM.dd}”改为index &#x3D;&gt; “filebeat-%{[fields][document_type]}-%{+YYYY.MM.dd}”，最终index命名为filebeat-yewuname-* 4、最后和Elasic支持人员沟通后得知，客户端filebeat不升级也可以，不影响使用</p>
<h3 id="二、Logstash"><a href="#二、Logstash" class="headerlink" title="二、Logstash"></a><strong>二、Logstash</strong></h3><p>1、主要是自定义映射模板需要修改，模板这块儿改动比较大，可以先使用默认的获取格式后再修改，然后得出自己的模板运用，使用了geoip定位，相关类型需要修改，最终模板如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/logstash/templates/nginx_template</span><br><span class="line">&#123;</span><br><span class="line">  &quot;template&quot; : &quot;filebeat-*&quot;,</span><br><span class="line">  &quot;settings&quot; : &#123;</span><br><span class="line">    &quot;index.refresh_interval&quot; : &quot;5s&quot;,</span><br><span class="line">     &quot;index.number_of_shards&quot;: &quot;8&quot;,</span><br><span class="line">     &quot;index.number_of_replicas&quot;: &quot;1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;_default_&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;@timestamp&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;@version&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;agent&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;beat&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;object&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;clientRealIp&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;geoip&quot;: &#123;</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">              &quot;city_name&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                  &quot;keyword&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;ignore_above&quot;: 256</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;continent_code&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                  &quot;keyword&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;ignore_above&quot;: 256</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;country_code2&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                  &quot;keyword&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;ignore_above&quot;: 256</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;country_code3&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                  &quot;keyword&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;ignore_above&quot;: 256</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;country_name&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                  &quot;keyword&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;ignore_above&quot;: 256</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;dma_code&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;long&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;ip&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                  &quot;keyword&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;ignore_above&quot;: 256</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;latitude&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;float&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;location&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;geo_point&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;longitude&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;float&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;postal_code&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                  &quot;keyword&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;ignore_above&quot;: 256</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;region_code&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                  &quot;keyword&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;ignore_above&quot;: 256</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;region_name&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                  &quot;keyword&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;ignore_above&quot;: 256</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;timezone&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                  &quot;keyword&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;ignore_above&quot;: 256</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;http_host&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;method&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;referrer&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;request_uri&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;responsetime&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;float&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;size&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;status&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;type&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;upstreamhost&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;url&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、输出到elasticsearch有些参数不支持了，需要注释flush_size,否则会报错The setting <code>flush_size</code> in plugin <code>elasticsearch</code> is obsolete and is no longer available. This setting is no longer available as we now try to restrict bulk requests to sane sizes. See the ‘Batch Sizes’ section of the docs.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">output &#123;    </span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;192.168.88.240:9200&quot;,&quot;192.168.88.241:9200&quot;,&quot;192.168.88.242:9200&quot;,&quot;192.168.88.243:9200&quot;,&quot;192.168.88.244:9200&quot;]</span><br><span class="line">    index =&gt; &quot;filebeat-%&#123;[fields][document_type]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">    manage_template =&gt; true</span><br><span class="line">    template_overwrite =&gt; true</span><br><span class="line">    template_name =&gt; &quot;nginx_template&quot;</span><br><span class="line">    template =&gt; &quot;/etc/logstash/templates/nginx_template&quot;</span><br><span class="line">    #flush_size =&gt; 20000</span><br><span class="line">    #idle_flush_time =&gt; 5</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="三、Elasticsearch"><a href="#三、Elasticsearch" class="headerlink" title="三、Elasticsearch"></a><strong>三、Elasticsearch</strong></h3><p>主要变更是该版本的一个Index只支持一个type了 官方提供有滚动升级，按照这个步骤尝试了下没有成功，后删数据硬升级，如果大家想尝试，步骤如下 滚动升级 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/rolling-upgrades.html">https://www.elastic.co/guide/en/elasticsearch/reference/5.6/rolling-upgrades.html</a></p>
<p>1、Disable shard allocation 例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &#x27;192.168.88:9200/_cluster/settings?pretty&#x27; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;transient&quot;: &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.enable&quot;: &quot;none&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x27;</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &#x27;192.168.88:9200/_cluster/settings?pretty&#x27; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;   &quot;transient&quot;: &#123;</span><br><span class="line">&gt;     &quot;cluster.routing.allocation.enable&quot;: &quot;none&quot;</span><br><span class="line">&gt;   &#125;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; &#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;acknowledged&quot; : true,</span><br><span class="line">  &quot;persistent&quot; : &#123; &#125;,</span><br><span class="line">  &quot;transient&quot; : &#123;</span><br><span class="line">    &quot;cluster&quot; : &#123;</span><br><span class="line">      &quot;routing&quot; : &#123;</span><br><span class="line">        &quot;allocation&quot; : &#123;</span><br><span class="line">          &quot;enable&quot; : &quot;none&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、Stop non-essential indexing and perform a synced flush (Optional) curl -XPOST ‘192.168.88:9200&#x2F;_flush&#x2F;synced?pretty’ 可选的，忽略</p>
<p>3、Stop and upgrade a single node &#x2F;etc&#x2F;init.d&#x2F;elasticsearch stop rpm -e elasticsearch-5.2.2-1.noarch rpm -ivh elasticsearch-6.0.0.rpm chkconfig –add elasticsearch chkconfig elasticsearch on cp elasticsearch.yml.rpmsave elasticsearch.yml 注意权限，卸载rpm包再安装rpm包后elasticsearch的uid与gid会变化 chown elasticsearch:elasticsearch &#x2F;data&#x2F;eslog&#x2F; -R chown elasticsearch:elasticsearch &#x2F;data&#x2F;esngx1&#x2F; -R chown elasticsearch:elasticsearch &#x2F;data&#x2F;esngx2&#x2F; -R</p>
<p>4、Upgrade any plugins 没有第三方插件，忽略</p>
<p>5、Start the upgraded node curl -XGET ‘192.168.88:9200&#x2F;_cat&#x2F;nodes?pretty’</p>
<p>6、Reenable shard allocation</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &#x27;192.168.88:9200/_cluster/settings?pretty&#x27; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;transient&quot;: &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.enable&quot;: &quot;all&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x27;</span><br></pre></td></tr></table></figure>

<p>7、Wait for the node to recover curl -XGET ‘192.168.88:9200&#x2F;_cat&#x2F;health?pretty’ curl -XGET ‘192.168.88:9200&#x2F;_cat&#x2F;recovery?pretty’</p>
<p>8、Repeat</p>
<h3 id="四、Kibana"><a href="#四、Kibana" class="headerlink" title="四、Kibana"></a><strong>四、Kibana</strong></h3><p>1、index名字是字段type加通配 2、导出老visualize模板后所有的visualize里面.raw改成.keyword，然后导入时dashboard需要与index一一对应</p>
<h3 id="五、Grafana"><a href="#五、Grafana" class="headerlink" title="五、Grafana"></a><strong>五、Grafana</strong></h3><p>同样修改数据源的index名字与查询语法.raw关键字为.keyword即可</p>
<h3 id="六、Elastalert"><a href="#六、Elastalert" class="headerlink" title="六、Elastalert"></a><strong>六、Elastalert</strong></h3><p>由于<a target="_blank" rel="noopener" href="https://github.com/Yelp/elastalert/releases">https://github.com/Yelp/elastalert/releases</a> 安装部署是最新版本是v0.1.25还不支持elasticsearch6.0，后参考<a target="_blank" rel="noopener" href="https://github.com/Yelp/elastalert/pull/1426">https://github.com/Yelp/elastalert/pull/1426</a> 修</p>
<p>改&#x2F;root&#x2F;elastalert-0.1.25&#x2F;elastalert目录下elastalert.py、create_index.py、ruletypes.py、test_rule.py四个文件，最后安装（备注以后安装后可以直接复制该目录到其他服务器上</p>
<p>安装，不需要再修改源码） 现在v0.1.26版本更新就支持elasticsearch6.0了，直接更新新版本就行。</p>
<h3 id="七、其他的kafka、nginx等不需要调整"><a href="#七、其他的kafka、nginx等不需要调整" class="headerlink" title="七、其他的kafka、nginx等不需要调整"></a><strong>七、其他的kafka、nginx等不需要调整</strong></h3>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/elasticsearch/" rel="tag"># elasticsearch</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/11/06/2018/11/2018-11-06-%E5%84%92%E5%AE%B6%E4%BD%9B%E6%95%99%E5%9F%BA%E7%9D%A3%E5%88%86%E5%88%AB%E4%BB%A5%E4%BB%80%E4%B9%88%E6%9D%A5%E5%9B%9E%E6%8A%A5%E6%80%A8/index/" rel="prev" title="儒家佛教基督分别以什么来回报怨">
      <i class="fa fa-chevron-left"></i> 儒家佛教基督分别以什么来回报怨
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/11/09/2018/11/2018-11-09-%E8%BF%90%E7%BB%B4%E9%9C%80%E8%A6%81%E8%BF%88%E8%BF%87%E7%9A%84%E4%B8%A4%E9%81%93%E5%9D%8E/index/" rel="next" title="运维需要迈过的两道坎">
      运维需要迈过的两道坎 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">1.</span> <span class="nav-text">架构图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E3%80%81Filebeat"><span class="nav-number">2.</span> <span class="nav-text">一、Filebeat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Logstash"><span class="nav-number">3.</span> <span class="nav-text">二、Logstash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E3%80%81Elasticsearch"><span class="nav-number">4.</span> <span class="nav-text">三、Elasticsearch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Kibana"><span class="nav-number">5.</span> <span class="nav-text">四、Kibana</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%94%E3%80%81Grafana"><span class="nav-number">6.</span> <span class="nav-text">五、Grafana</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AD%E3%80%81Elastalert"><span class="nav-number">7.</span> <span class="nav-text">六、Elastalert</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E5%85%B6%E4%BB%96%E7%9A%84kafka%E3%80%81nginx%E7%AD%89%E4%B8%8D%E9%9C%80%E8%A6%81%E8%B0%83%E6%95%B4"><span class="nav-number">8.</span> <span class="nav-text">七、其他的kafka、nginx等不需要调整</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jerry Min</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">260</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jerry Min</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
